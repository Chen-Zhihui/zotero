

有问题，上知乎。知乎作为中文互联网最大的知识分享平台，以「知识连接一切」为愿景，致力于构建一个人人都可以便捷接入的知识分享网络，让人们便捷地与世界分享知识、经验和见解，发现更大的世界。
写文章
Camelyon Challenge: 癌症细胞区域检测竞赛
Camelyon Challenge: 癌症细胞区域检测竞赛
SCP-173
SCP-173
鹅厂头牌饮水机管理员
​ 关注他
129 人 赞了该文章
在今年早些时候，Google发了两篇关于人工智能医疗图像的科技文章：一篇是非常有名的关于皮肤癌检测的文章 Dermatologist-level classification of skin cancer with deep neural networks ，文章通过采用Inception v3的结构对皮肤癌图像进行了有效分类，更值得注意的是，模型的敏感性意料之内的能够超越了人类的识别能力，并且通过Tensorflow移植到了手机端做成了APP，在商业医疗方面有很广阔的应用前景。

（上图为皮肤癌分类问题的样本分布）

另一篇是Google发的一篇科技博客 Assisting Pathologists in Detecting Cancer with Deep Learning ，主要内容讲的是针对病理图像中乳腺癌在淋巴结中的转移的检测任务。这篇文章的背景是医学顶级会议ISBI在2016年发布的Camelyon16的竞赛，竞赛的主要内容是对乳腺癌在淋巴结中的转移进行病理切片的分类与定位。很幸运，那段时间正好在 DeepCare 公司学习工作，并且参加了Camelyon16和Camelyon17两届比赛，所以想分享一下自己关于深度学习中病理图像方面应用的一些经验和收获。

（一张淋巴结的病理图片，左边属于正常细胞组织，右边的细胞已经被癌细胞吞噬占领了）

问题的由来

一 般来说，乳腺癌细胞的扩散方式通常会首先转移到附近的淋巴结中，所以在很多乳腺检查中，会提取一些附近淋巴结组织做成切片，经过切片、染色、扫描等过程 后，生成如上图的图像。癌细胞和正常细胞在颜色、纹理、大小和组织形式上都会有很多的不同，一般来说就是“核大深染”的突出特征。在大医院中，很多上了年 纪的且具有很多“看片”经验的医生炙手可热，这意味着人类同样需要很多经验才能正确的进行分析判断，而年轻的或缺乏经验的医生容易出现误判。 Camelyon16希望我们能够通过计算机视觉技术帮助医生进行有效筛选，从而减少工作量和误判的可能性。

Camelyon16的任务是 对测试集中的120张淋巴结病理切片进行判断是否发生了癌变(classification)，同时需要对发生癌变的位置区域精准定位 (segmentation)；而Camelyon17的任务变得更加复杂，在16的基础上需要对发生癌变转移的区域进行大小判断，从而将病理切片分为 Normal/ITC/Micro/Macro四个类别，最终根据每个病人的五张切片的定性结果确定病人的乳腺癌细胞转移的情况。（听起来挺复杂，也的确 挺复杂）

官 方一共给了110张含有癌细胞组织的切片(Tumor)和130张正常的组织切片(Normal)，并对有癌症的区域进行了标记，最终确定120张切片的 性质。看起来数据量很少，按照传统的图像处理方式应该是很简单的，但实际上数据的形式是金字塔数据形式，最大分辨率40X的图像矩阵大小大概是 300000×150000，一个样本的所占硬盘空间大小大概是5~6G。这也就意味着我们不太可能将图片全部加载到内存中，即使有足够的内存，也不可能 把它加载到显卡内存中进行深度学习运算（可以想象一下如果这么大的矩阵采用3×3的卷积核进行运算的场景），所以对图片进行 预处理 非常有必要。

（病理切片图像中金字塔型的数据结构）
预处理
在经典问题中很少有图片会这么大，但也会遇到一些，比如遥感图像等；这类图像的处理办法一般会采用分块的方式进行处理，然后再将每一块的处理结果进行汇总从而得出结果。

对于一张病理图像来说，只有20%~30%的区域是有效区域RoI，如果每一块都要进行预处理，会导致处理时间过长，效率不高，所以需要做有效区域的提取。

（左图是一张病理切片的10X左右的效果图，可以发现基本上大多数区域都是不需要的；右图的蓝色区域所围成的区域是癌症区域）

比如这样的一张病理切片：

首先将它进行通过特定的阈值算法，提取出前景部分：

之后，通过一些古典图像处理的算法，将图片的有效区域提取出来：

于是我们就可以将每一部分根据坐标进行切分，从而生成很多小片(patch)：

(上图黑色区域就是一片一片的patch，每一张都是一个256×256大小的图片)

这里可以给大家透露一下，由于要这个过程要商业化，所以我们做了一个非常强大的并行策略去进行图片切割，比原始方法进行切割的速度可以理论提升64倍。

由于比赛数据来自于不同的医院或研究机构，所采用了不同厂家的扫描仪，因此图片在色调上存在着很大的差异，这对模型来说，会造成confused现象，因此在做成数据集之前，对所有的图片进行了染色均一化过程：

其主要的思想是通过将RGB变换到HSV 色域表征，通过调节色调分布使得不同图像进行染色均一化。

之后便生成数据集。未加入Data Augmentation前，已经可以生成正样本数量120w张，负样本就更多了，一方面数据量比较多，可以提升模型泛化能力，另一方面这么多数据集对运算设备和运算框架也提出了很高的要求。
模型设计

Google采用的是Multi-Scales算法，仿照病理医生的情况，针对不同的大小视觉差 针对不同的置信结果，我们采用了二级网络进行训练：

在做这个实验的时候，我们用了两块Pascal Titan X。为了更好地利用计算空间来提升运算性能，我们用了 MXNet 深度学习框架作为整体的解决方案（包括后来的商业部署Inference）。也非常感谢
@lau phunter
刘老师以及MXNet其他大神提供的解决办法。

粗选网络采用VGG16同时搭配低阈值，精选网络采用ResNeXt101设定较高的阈值，最后进行模型融合从而提升模型结果。

这里分享一个小的Trick，在实验中我们发现，图片如果尺寸过小，会造成误报现象严重，这也是Google在那篇文章中提到的。
后处理

后处理也是一个比较麻烦的地方，我们直接将上述生成的heatmap再次送到一个新的网络中，进行后续操作，包括分类等。其他高排名的解决方案大多数采用了癌症区域面积的方式。（实际上我们这是比较偷懒的做法）
后记

DeepCare公司的最终比赛排名是：Camelyon16第8名，Camelyon17第13名。

名次不是特别好的原因主要是我拖累的这个比赛进度，在这里我还是对DeepCare公司抱有很深的歉意~~~ 但DeepCare公司是我非常看好的一家人工智能医疗公司，在我因个人原因离开之前，公司进入了微软加速器并且获得了强力的A轮投资。

由于保密协议的原因，我没有办法公开任何有关代码，但是我同样非常欢迎交流和讨论，如果有机会参加Camelyon18的比赛，希望能有更多的人能够一起参赛。文章中如果有任何问题，非常欢迎各位批评指正，谢谢~

这篇文章写于2017年的端午节，刚好我完成了研究生学术论文答辩，同时已经签约到腾讯的AI Lab，继续从事有关计算机视觉技术的研究工作。这篇文章也算是对我这一年来的一个怀想吧！
编辑于 2017-05-29
深度学习（Deep Learning）
人工智能算法
医学影像
129 ​ 23 条评论
​ 分享
​ 收藏
​
推荐阅读

    癌症与免疫的故事
    癌症与免疫的故事
    孙测
    细胞传代培养

    1、悬浮细胞传代由于细胞已经在生长培养基中悬浮，所以无需酶的作用使其从培养容器表面脱离，方法简单。通常有两种方法。 材料准备：1、装有悬浮细胞的培养容器。2、完全生长培养基，预热至…
    autumn
    下葬后还疯狂生长65年，细胞竟然已经遍布世界
    下葬后还疯狂生长65年，细胞竟然已经遍布世界
    SME情报... 发表于Dizzy...
    Momenta首期MCDC竞赛来袭，海量数据丰厚大奖等你来
    Momenta首期MCDC竞赛来袭，海量数据丰厚大奖等你来
    Momenta

23 条评论
​ 切换为时间排序
写下你的评论...

评论
凡夫俗子
凡夫俗子 1 年前
每一个patch是要人工标记？那要花不少时间吧。
赞 回复 踩 举报
SCP-173
SCP-173 (作者) 回复 凡夫俗子 1 年前
是这样的，像文中蓝色圈出的标记区域，如果patch在里面那么就被标记成正样本即可
赞 查看对话 回复 踩 举报
lau phunter
lau phunter 1 年前

很好啊，把MXNet带到腾讯去
赞 回复 踩 举报
Siegel Seele
Siegel Seele 1 年前
关键是要识别细胞核
赞 回复 踩 举报
霍华德
霍华德 1 年前
羡慕啊 居然能去腾讯ai
赞 回复 踩 举报
paranoid
paranoid 11 个月前

楼主好，可以交流下吗？我Q：893457818，谢谢！
赞 回复 踩 举报
SCP-173
SCP-173 (作者) 回复 paranoid 11 个月前
您是？
赞 查看对话 回复 踩 举报
paranoid
paranoid 11 个月前

学生，医学图像处理方向，想学点经验
赞 回复 踩 举报
SCP-173
SCP-173 (作者) 回复 paranoid 11 个月前
有问题，私信即可
赞 查看对话 回复 踩 举报
呆苏克
呆苏克 回复 Siegel Seele 11 个月前

不一定的，除非细胞核颜色形状和周围有显著的差别。

赞 查看对话 回复 踩 举报
songdh
songdh 11 个月前
你好，求教一个问题: 结核杆菌的自动识别程序有人研究吗?因为私以为这个很简单，却找不找相关研究资料或立项情况。如果有了，我想用，如果没有，我可以自己开发。谢谢。
赞 回复 踩 举报
好吧
好吧 10 个月前

请问正样本是完全在标记区域内的patch吗？patch取到标记区域内有时有空白区域时如何选取？非癌组织也会有空白区域，如何减少这种影响呢
赞 回复 踩 举报
好吧
好吧 10 个月前

请问正样本是完全在标记区域内的patch吗？patch取到标记区域内有时有空白区域时如何选取？非癌组织也会有空白区域，如何减少这种影响呢
赞 回复 踩 举报
SCP-173
SCP-173 (作者) 回复 好吧 10 个月前

不一定全在标记里，可以有一些正常区域；第二个问题需要你自己去控制，如果制作出较好的样本

赞 查看对话 回复 踩 举报
好吧
好吧 回复 SCP-173 (作者) 10 个月前

好的 谢谢 ：)
赞 查看对话 回复 踩 举报
杨无字
杨无字 10 个月前
你好，您现在还留有数据么，我们这边自己开发了一套算法，也通过乳腺癌的数据测试算法。如果可以 我们可以私下留联系方式。
赞 回复 踩 举报
SCP-173
SCP-173 (作者) 回复 杨无字 10 个月前
你好，官网是可以申请数据的
赞 查看对话 回复 踩 举报
PJ.Javis
PJ.Javis 9 个月前

楼主，能否提供下【乳腺癌在淋巴结中的转移进行病理切片】的数据下载地址？
赞 回复 踩 举报
SCP-173
SCP-173 (作者) 回复 PJ.Javis 9 个月前
可以在官网下载的
赞 查看对话 回复 踩 举报
黄至铖
黄至铖 9 个月前

对于这种病理切片如果做病灶分割的话，有没有什么比较好的建议
赞 回复 踩 举报
1 2 下一页
想来知乎工作？请发送邮件到 jobs@zhihu.com
