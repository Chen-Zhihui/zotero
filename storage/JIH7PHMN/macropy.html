<!DOCTYPE html>
<html lang="en"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
  <link rel="dns-prefetch" href="https://assets-cdn.github.com/">
  <link rel="dns-prefetch" href="https://avatars0.githubusercontent.com/">
  <link rel="dns-prefetch" href="https://avatars1.githubusercontent.com/">
  <link rel="dns-prefetch" href="https://avatars2.githubusercontent.com/">
  <link rel="dns-prefetch" href="https://avatars3.githubusercontent.com/">
  <link rel="dns-prefetch" href="https://github-cloud.s3.amazonaws.com/">
  <link rel="dns-prefetch" href="https://user-images.githubusercontent.com/">



  <link crossorigin="anonymous" media="all" integrity="sha512-KDZfnHRZjn4xEe2VuPe5iA8c+O1aNoowrYTe3DQQR97UQDzf5HZ15My/ytImCLmX5X6kBM8kwtuUVj5H+DOZbA==" rel="stylesheet" href="frameworks-7d09971c51977b60c6626362003ef38a.css">
  <link crossorigin="anonymous" media="all" integrity="sha512-8VnmS7+S4UIxsIz2BC4F/c3YYbRNB/GEcCQ6AssRT3F3s6sObMSaw8K9ijW0SyurkWRxN/dPT/DV/+4GjWcFrA==" rel="stylesheet" href="github-324331281b788158086ad9201d9c0804.css">
  
  
  
  

  <meta name="viewport" content="width=device-width">
  
  <title>lihaoyi/macropy: Macros in Python: quasiquotes, case classes, LINQ and more!</title>
    <meta name="description" content="GitHub is where people build software. More than 27 million people use GitHub to discover, fork, and contribute to over 80 million projects.">
  <link rel="search" type="application/opensearchdescription+xml" href="https://github.com/opensearch.xml" title="GitHub">
  <link rel="fluid-icon" href="https://github.com/fluidicon.png" title="GitHub">
  <meta property="fb:app_id" content="1401488693436528">

    
    <meta property="og:image" content="https://avatars2.githubusercontent.com/u/934140?s=400&amp;v=4"><meta property="og:site_name" content="GitHub"><meta property="og:type" content="object"><meta property="og:title" content="lihaoyi/macropy"><meta property="og:url" content="https://github.com/lihaoyi/macropy"><meta property="og:description" content="macropy - Macros in Python: quasiquotes, case classes, LINQ and more!">

  <link rel="assets" href="https://assets-cdn.github.com/">
  <link rel="web-socket" href="wss://live.github.com/_sockets/VjI6MjU2ODMxODg5OmNiNGQxNWMxYzVkYjUyZmU5NzU3OTk2NDMxZmYyNjM3MGVmMGRiMDRlMDY1OWNmNDYyNGVhNzQ3MGYyYmE3ZmY=--6bd4653c0743457830012894fbddc3b27b155e7b">
  <meta name="pjax-timeout" content="1000">
  <link rel="sudo-modal" href="https://github.com/sessions/sudo_modal">
  <meta name="request-id" content="7340:6518:D77907:134388C:5AC0FE35" data-pjax-transient="">


  

  <meta name="selected-link" value="repo_source" data-pjax-transient="">

    <meta name="google-site-verification" content="KT5gs8h0wvaagLKAVWq8bbeNwnZZK1r1XQysX3xurLU">
  <meta name="google-site-verification" content="ZzhVyEFwb7w3e0-uOTltm8Jsck2F5StVihD0exw2fsA">
  <meta name="google-site-verification" content="GXs5KoUUkNCoaAZn7wPN-t01Pywp9M3sEjnt_3_ZWPc">
    <meta name="google-analytics" content="UA-3769691-2">

<meta name="octolytics-host" content="collector.githubapp.com"><meta name="octolytics-app-id" content="github"><meta name="octolytics-event-url" content="https://collector.githubapp.com/github-external/browser_event"><meta name="octolytics-dimension-request_id" content="7340:6518:D77907:134388C:5AC0FE35"><meta name="octolytics-dimension-region_edge" content="1"><meta name="octolytics-dimension-region_render" content="iad"><meta name="octolytics-actor-id" content="12552758"><meta name="octolytics-actor-login" content="Chen-Zhihui"><meta name="octolytics-actor-hash" content="756830ef2832c7e92e50d9938104614afc1e7c27bc0e459eba383a82c53fb868">
<meta name="hydro-events-url" content="https://github.com/hydro_browser_events">
<meta name="analytics-location" content="/&lt;user-name&gt;/&lt;repo-name&gt;" data-pjax-transient="true">




  <meta class="js-ga-set" name="dimension1" content="Logged In">


  

      <meta name="hostname" content="github.com">
    <meta name="user-login" content="Chen-Zhihui">

      <meta name="expected-hostname" content="github.com">
    <meta name="js-proxy-site-detection-payload" content="MThlOTlmYzZhOGYwNzdmMDRhNDk4N2RmNjM5MzU0ZjQxM2M0NjQ1NmZiNTBhZDRkYTVjMzFhOTFjOTQyODg5OXx7InJlbW90ZV9hZGRyZXNzIjoiMTA2LjQ3LjE2NS4yNDUiLCJyZXF1ZXN0X2lkIjoiNzM0MDo2NTE4OkQ3NzkwNzoxMzQzODhDOjVBQzBGRTM1IiwidGltZXN0YW1wIjoxNTIyNTk3NDMzLCJob3N0IjoiZ2l0aHViLmNvbSJ9">

    <meta name="enabled-features" content="UNIVERSE_BANNER,FREE_TRIALS,MARKETPLACE_INSIGHTS,MARKETPLACE_INSIGHTS_CONVERSION_PERCENTAGES">

  <meta name="html-safe-nonce" content="bc2c4eddcd7ead974c2214e14aa47089f1ee4bb2">

  <meta http-equiv="x-pjax-version" content="2a8622940bb010d0ebdd41ecb8362bdb">
  

      <link href="https://github.com/lihaoyi/macropy/commits/master.atom" rel="alternate" title="Recent Commits to macropy:master" type="application/atom+xml">

  <meta name="description" content="macropy - Macros in Python: quasiquotes, case classes, LINQ and more!">
  <meta name="go-import" content="github.com/lihaoyi/macropy git https://github.com/lihaoyi/macropy.git">

  <meta name="octolytics-dimension-user_id" content="934140"><meta name="octolytics-dimension-user_login" content="lihaoyi"><meta name="octolytics-dimension-repository_id" content="9450995"><meta name="octolytics-dimension-repository_nwo" content="lihaoyi/macropy"><meta name="octolytics-dimension-repository_public" content="true"><meta name="octolytics-dimension-repository_is_fork" content="false"><meta name="octolytics-dimension-repository_network_root_id" content="9450995"><meta name="octolytics-dimension-repository_network_root_nwo" content="lihaoyi/macropy"><meta name="octolytics-dimension-repository_explore_github_marketplace_ci_cta_shown" content="false">


    <link rel="canonical" href="https://github.com/lihaoyi/macropy" data-pjax-transient="">


  <meta name="browser-stats-url" content="https://api.github.com/_private/browser/stats">

  <meta name="browser-errors-url" content="https://api.github.com/_private/browser/errors">

  <link rel="mask-icon" href="https://assets-cdn.github.com/pinned-octocat.svg" color="#000000">
  <link rel="icon" type="image/x-icon" class="js-site-favicon" href="https://assets-cdn.github.com/favicon.ico">

<meta name="theme-color" content="#1e2327">



<link rel="manifest" href="https://github.com/manifest.json" crossorigin="use-credentials">

  </head>

  <body class="logged-in env-production">
    

  <div class="position-relative js-header-wrapper ">
    <a href="#start-of-content" tabindex="1" class="bg-black text-white p-3 show-on-focus js-skip-to-content">Skip to content</a>
    <div id="js-pjax-loader-bar" class="pjax-loader-bar"><div class="progress"></div></div>

    
    
    



        
<header class="Header  f5" role="banner">
  <div class="d-flex flex-justify-between px-3 container-lg">
    <div class="d-flex flex-justify-between ">
      <div class="">
        <a class="header-logo-invertocat" href="https://github.com/" data-hotkey="g d" aria-label="Homepage" data-ga-click="Header, go to dashboard, icon:logo">
  <svg height="32" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="32" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></svg>
</a>

      </div>

    </div>

    <div class="HeaderMenu d-flex flex-justify-between flex-auto">
      <div class="d-flex">
            <div class="">
              <div class="header-search scoped-search site-scoped-search js-site-search" role="search">
  <!-- '"` --><!-- </textarea></xmp> --><form class="js-site-search-form" data-scoped-search-url="/lihaoyi/macropy/search" data-unscoped-search-url="/search" action="/lihaoyi/macropy/search" accept-charset="UTF-8" method="get"><input name="utf8" value="✓" type="hidden">
    <label class="form-control header-search-wrapper  js-chromeless-input-container">
        <a class="header-search-scope no-underline" href="https://github.com/lihaoyi/macropy">This repository</a>
      <input class="form-control header-search-input  js-site-search-focus js-site-search-field is-clearable" data-hotkey="s,/" name="q" placeholder="Search" aria-label="Search this repository" data-unscoped-placeholder="Search GitHub" data-scoped-placeholder="Search" autocapitalize="off" type="text">
        <input class="js-site-search-type-field" name="type" type="hidden">
    </label>
</form></div>

            </div>

          <ul class="d-flex pl-2 flex-items-center text-bold list-style-none" role="navigation">
            <li>
              <a class="js-selected-navigation-item HeaderNavlink px-2" data-hotkey="g p" data-ga-click="Header, click, Nav menu - item:pulls context:user" aria-label="Pull requests you created" data-selected-links="/pulls /pulls/assigned /pulls/mentioned /pulls" href="https://github.com/pulls">
                Pull requests
</a>            </li>
            <li>
              <a class="js-selected-navigation-item HeaderNavlink px-2" data-hotkey="g i" data-ga-click="Header, click, Nav menu - item:issues context:user" aria-label="Issues you created" data-selected-links="/issues /issues/assigned /issues/mentioned /issues" href="https://github.com/issues">
                Issues
</a>            </li>
                <li>
                  <a class="js-selected-navigation-item HeaderNavlink px-2" data-ga-click="Header, click, Nav menu - item:marketplace context:user" data-selected-links=" /marketplace" href="https://github.com/marketplace">
                    Marketplace
</a>                </li>
            <li>
              <a class="js-selected-navigation-item HeaderNavlink px-2" data-ga-click="Header, click, Nav menu - item:explore" data-selected-links="/explore /trending /trending/developers /integrations /integrations/feature/code /integrations/feature/collaborate /integrations/feature/ship showcases showcases_search showcases_landing /explore" href="https://github.com/explore">
                Explore
</a>            </li>
          </ul>
      </div>

      <div class="d-flex">
        
<ul class="user-nav d-flex flex-items-center list-style-none" id="user-links">
  <li class="dropdown js-menu-container">
    <span class="d-inline-block  px-2">
      
    <a aria-label="You have unread notifications" class="notification-indicator tooltipped tooltipped-s  js-socket-channel js-notification-indicator" data-hotkey="g n" data-ga-click="Header, go to notifications, icon:unread" data-channel="notification-changed:12552758" href="https://github.com/notifications">
        <span class="mail-status unread"></span>
        <svg class="octicon octicon-bell" viewBox="0 0 14 16" version="1.1" width="14" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M14 12v1H0v-1l.73-.58c.77-.77.81-2.55 1.19-4.42C2.69 3.23 6 2 6 2c0-.55.45-1 1-1s1 .45 1 1c0 0 3.39 1.23 4.16 5 .38 1.88.42 3.66 1.19 4.42l.66.58H14zm-7 4c1.11 0 2-.89 2-2H5c0 1.11.89 2 2 2z"></path></svg>
</a>
    </span>
  </li>

  <li class="dropdown js-menu-container">
    <details class="dropdown-details details-reset js-dropdown-details d-flex px-2 flex-items-center">
      <summary class="HeaderNavlink" aria-label="Create new…" data-ga-click="Header, create new, icon:add">
        <svg class="octicon octicon-plus float-left mr-1 mt-1" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M12 9H7v5H5V9H0V7h5V2h2v5h5z"></path></svg>
        <span class="dropdown-caret mt-1"></span>
      </summary>

      <ul class="dropdown-menu dropdown-menu-sw">
        
<a class="dropdown-item" href="https://github.com/new" data-ga-click="Header, create new repository">
  New repository
</a>

  <a class="dropdown-item" href="https://github.com/new/import" data-ga-click="Header, import a repository">
    Import repository
  </a>

<a class="dropdown-item" href="https://gist.github.com/" data-ga-click="Header, create new gist">
  New gist
</a>

  <a class="dropdown-item" href="https://github.com/organizations/new" data-ga-click="Header, create new organization">
    New organization
  </a>



  <div class="dropdown-divider"></div>
  <div class="dropdown-header">
    <span title="lihaoyi/macropy">This repository</span>
  </div>
    <a class="dropdown-item" href="https://github.com/lihaoyi/macropy/issues/new" data-ga-click="Header, create new issue">
      New issue
    </a>

      </ul>
    </details>
  </li>

  <li class="dropdown js-menu-container">

    <details class="dropdown-details details-reset js-dropdown-details d-flex pl-2 flex-items-center">
      <summary class="HeaderNavlink name mt-1" aria-label="View profile and more" data-ga-click="Header, show menu, icon:avatar">
        <img alt="@Chen-Zhihui" class="avatar float-left mr-1" src="12552758.png" width="20" height="20">
        <span class="dropdown-caret"></span>
      </summary>

      <ul class="dropdown-menu dropdown-menu-sw">
        <li class="dropdown-header header-nav-current-user css-truncate">
          Signed in as <strong class="css-truncate-target">Chen-Zhihui</strong>
        </li>

        <li class="dropdown-divider"></li>

        <li><a class="dropdown-item" href="https://github.com/Chen-Zhihui" data-ga-click="Header, go to profile, text:your profile">
          Your profile
        </a></li>
        <li><a class="dropdown-item" href="https://github.com/Chen-Zhihui?tab=stars" data-ga-click="Header, go to starred repos, text:your stars">
          Your stars
        </a></li>
          <li><a class="dropdown-item" href="https://gist.github.com/" data-ga-click="Header, your gists, text:your gists">Your gists</a></li>

        <li class="dropdown-divider"></li>

        <li><a class="dropdown-item" href="https://help.github.com/" data-ga-click="Header, go to help, text:help">
          Help
        </a></li>

        <li><a class="dropdown-item" href="https://github.com/settings/profile" data-ga-click="Header, go to settings, icon:settings">
          Settings
        </a></li>

        <li><!-- '"` --><!-- </textarea></xmp> --><form class="logout-form" action="/logout" accept-charset="UTF-8" method="post"><input name="utf8" value="✓" type="hidden"><input name="authenticity_token" value="rLwAlsbLAxmvN8tuInDojVop9kHzdyWYX6rwsPxUkyEYP2kJsc0MMu5JxWt5LodRtWSwDw7KH87kYALBtVNqHg==" type="hidden">
          <button type="submit" class="dropdown-item dropdown-signout" data-ga-click="Header, sign out, icon:logout">
            Sign out
          </button>
        </form></li>
      </ul>
    </details>
  </li>
</ul>



        <!-- '"` --><!-- </textarea></xmp> --><form class="sr-only right-0" action="/logout" accept-charset="UTF-8" method="post"><input name="utf8" value="✓" type="hidden"><input name="authenticity_token" value="2ciWHxnH1qYxF0Yg1u+Pt61DtxTJ9Yh5viDm6A6yK7dtS/+AbsHZjXBpSCWNseBrQg7xWjRIsi8F6hSZR7XSiA==" type="hidden">
          <button type="submit" class="dropdown-item dropdown-signout" data-ga-click="Header, sign out, icon:logout">
            Sign out
          </button>
</form>      </div>
    </div>
  </div>
</header>

      

  </div>

  <div id="start-of-content" class="show-on-focus"></div>

    <div id="js-flash-container">
</div>



  <div role="main" class="application-main ">
        <div itemscope="" itemtype="http://schema.org/SoftwareSourceCode" class="">
    <div id="js-repo-pjax-container" data-pjax-container="">
      





  <div class="pagehead repohead instapaper_ignore readability-menu experiment-repo-nav  ">
    <div class="repohead-details-container clearfix container">

      <ul class="pagehead-actions">
  <li>
        <!-- '"` --><!-- </textarea></xmp> --><form data-autosubmit="true" data-remote="true" class="js-social-container" action="/notifications/subscribe" accept-charset="UTF-8" method="post"><input name="utf8" value="✓" type="hidden"><input name="authenticity_token" value="7D6CdpKFxkhnwxRzkLyBl3yyVIvF+7arqQDhdD+K87xYD3Vml8cYz4/SDqQgrL7qnDaSkFh0ECt6zo3LCEUGgQ==" type="hidden">      <input name="repository_id" id="repository_id" value="9450995" class="form-control" type="hidden">

        <div class="select-menu js-menu-container js-select-menu">
          <a href="https://github.com/lihaoyi/macropy/subscription" class="btn btn-sm btn-with-count select-menu-button js-menu-target" role="button" aria-haspopup="true" aria-expanded="false" aria-label="Toggle repository notifications menu" data-ga-click="Repository, click Watch settings, action:files#disambiguate">
            <span class="js-select-button">
                <svg class="octicon octicon-eye" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8.06 2C3 2 0 8 0 8s3 6 8.06 6C13 14 16 8 16 8s-3-6-7.94-6zM8 12c-2.2 0-4-1.78-4-4 0-2.2 1.8-4 4-4 2.22 0 4 1.8 4 4 0 2.22-1.78 4-4 4zm2-4c0 1.11-.89 2-2 2-1.11 0-2-.89-2-2 0-1.11.89-2 2-2 1.11 0 2 .89 2 2z"></path></svg>
                Watch
            </span>
          </a>
          <a class="social-count js-social-count" href="https://github.com/lihaoyi/macropy/watchers" aria-label="103 users are watching this repository">
            103
          </a>

        <div class="select-menu-modal-holder">
          <div class="select-menu-modal subscription-menu-modal js-menu-content">
            <div class="select-menu-header js-navigation-enable" tabindex="-1">
              <svg class="octicon octicon-x js-menu-close" role="img" aria-label="Close" viewBox="0 0 12 16" version="1.1" width="12" height="16"><path fill-rule="evenodd" d="M7.48 8l3.75 3.75-1.48 1.48L6 9.48l-3.75 3.75-1.48-1.48L4.52 8 .77 4.25l1.48-1.48L6 6.52l3.75-3.75 1.48 1.48z"></path></svg>
              <span class="select-menu-title">Notifications</span>
            </div>

              <div class="select-menu-list js-navigation-container" role="menu">

                <div class="select-menu-item js-navigation-item selected" role="menuitem" tabindex="0">
                  <svg class="octicon octicon-check select-menu-item-icon" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M12 5l-8 8-4-4 1.5-1.5L4 10l6.5-6.5z"></path></svg>
                  <div class="select-menu-item-text">
                    <input name="do" id="do_included" value="included" checked="checked" type="radio">
                    <span class="select-menu-item-heading">Not watching</span>
                    <span class="description">Be notified when participating or @mentioned.</span>
                    <span class="js-select-button-text hidden-select-button-text">
                      <svg class="octicon octicon-eye" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8.06 2C3 2 0 8 0 8s3 6 8.06 6C13 14 16 8 16 8s-3-6-7.94-6zM8 12c-2.2 0-4-1.78-4-4 0-2.2 1.8-4 4-4 2.22 0 4 1.8 4 4 0 2.22-1.78 4-4 4zm2-4c0 1.11-.89 2-2 2-1.11 0-2-.89-2-2 0-1.11.89-2 2-2 1.11 0 2 .89 2 2z"></path></svg>
                      Watch
                    </span>
                  </div>
                </div>

                <div class="select-menu-item js-navigation-item " role="menuitem" tabindex="0">
                  <svg class="octicon octicon-check select-menu-item-icon" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M12 5l-8 8-4-4 1.5-1.5L4 10l6.5-6.5z"></path></svg>
                  <div class="select-menu-item-text">
                    <input name="do" id="do_subscribed" value="subscribed" type="radio">
                    <span class="select-menu-item-heading">Watching</span>
                    <span class="description">Be notified of all conversations.</span>
                    <span class="js-select-button-text hidden-select-button-text">
                      <svg class="octicon octicon-eye" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8.06 2C3 2 0 8 0 8s3 6 8.06 6C13 14 16 8 16 8s-3-6-7.94-6zM8 12c-2.2 0-4-1.78-4-4 0-2.2 1.8-4 4-4 2.22 0 4 1.8 4 4 0 2.22-1.78 4-4 4zm2-4c0 1.11-.89 2-2 2-1.11 0-2-.89-2-2 0-1.11.89-2 2-2 1.11 0 2 .89 2 2z"></path></svg>
                        Unwatch
                    </span>
                  </div>
                </div>

                <div class="select-menu-item js-navigation-item " role="menuitem" tabindex="0">
                  <svg class="octicon octicon-check select-menu-item-icon" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M12 5l-8 8-4-4 1.5-1.5L4 10l6.5-6.5z"></path></svg>
                  <div class="select-menu-item-text">
                    <input name="do" id="do_ignore" value="ignore" type="radio">
                    <span class="select-menu-item-heading">Ignoring</span>
                    <span class="description">Never be notified.</span>
                    <span class="js-select-button-text hidden-select-button-text">
                      <svg class="octicon octicon-mute" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 2.81v10.38c0 .67-.81 1-1.28.53L3 10H1c-.55 0-1-.45-1-1V7c0-.55.45-1 1-1h2l3.72-3.72C7.19 1.81 8 2.14 8 2.81zm7.53 3.22l-1.06-1.06-1.97 1.97-1.97-1.97-1.06 1.06L11.44 8 9.47 9.97l1.06 1.06 1.97-1.97 1.97 1.97 1.06-1.06L13.56 8l1.97-1.97z"></path></svg>
                        Stop ignoring
                    </span>
                  </div>
                </div>

              </div>

            </div>
          </div>
        </div>
</form>
  </li>

  <li>
    
  <div class="js-toggler-container js-social-container starring-container ">
    <!-- '"` --><!-- </textarea></xmp> --><form class="starred js-social-form" action="/lihaoyi/macropy/unstar" accept-charset="UTF-8" method="post"><input name="utf8" value="✓" type="hidden"><input name="authenticity_token" value="NbQJEnS0Mm92H73As97ZfDnOiYxLutCLhfFZKk+7lSYMeOH1EmhtgWx9sJW6Bu4YyRkyWwvvZa/ouNqsUsmVSg==" type="hidden">
      <input name="context" value="repository" type="hidden">
      <button type="submit" class="btn btn-sm btn-with-count js-toggler-target" aria-label="Unstar this repository" title="Unstar lihaoyi/macropy" data-ga-click="Repository, click unstar button, action:files#disambiguate; text:Unstar">
        <svg class="octicon octicon-star" viewBox="0 0 14 16" version="1.1" width="14" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M14 6l-4.9-.64L7 1 4.9 5.36 0 6l3.6 3.26L2.67 14 7 11.67 11.33 14l-.93-4.74z"></path></svg>
        Unstar
      </button>
        <a class="social-count js-social-count" href="https://github.com/lihaoyi/macropy/stargazers" aria-label="2440 users starred this repository">
          2,440
        </a>
</form>
    <!-- '"` --><!-- </textarea></xmp> --><form class="unstarred js-social-form" action="/lihaoyi/macropy/star" accept-charset="UTF-8" method="post"><input name="utf8" value="✓" type="hidden"><input name="authenticity_token" value="fnfW+L7OPY2aC+VHrR2QTA9H4x/41aQW3qWe0W6zV0Z4pYbTyCAQrUUAfAtfXXLiQRVG/SdfTO9C844rCZjj6Q==" type="hidden">
      <input name="context" value="repository" type="hidden">
      <button type="submit" class="btn btn-sm btn-with-count js-toggler-target" aria-label="Star this repository" title="Star lihaoyi/macropy" data-ga-click="Repository, click star button, action:files#disambiguate; text:Star">
        <svg class="octicon octicon-star" viewBox="0 0 14 16" version="1.1" width="14" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M14 6l-4.9-.64L7 1 4.9 5.36 0 6l3.6 3.26L2.67 14 7 11.67 11.33 14l-.93-4.74z"></path></svg>
        Star
      </button>
        <a class="social-count js-social-count" href="https://github.com/lihaoyi/macropy/stargazers" aria-label="2440 users starred this repository">
          2,440
        </a>
</form>  </div>

  </li>

  <li>
          <a href="#fork-destination-box" class="btn btn-sm btn-with-count" title="Fork your own copy of lihaoyi/macropy to your account" aria-label="Fork your own copy of lihaoyi/macropy to your account" rel="facebox" data-ga-click="Repository, show fork modal, action:files#disambiguate; text:Fork">
              <svg class="octicon octicon-repo-forked" viewBox="0 0 10 16" version="1.1" width="10" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1a1.993 1.993 0 0 0-1 3.72V6L5 8 3 6V4.72A1.993 1.993 0 0 0 2 1a1.993 1.993 0 0 0-1 3.72V6.5l3 3v1.78A1.993 1.993 0 0 0 5 15a1.993 1.993 0 0 0 1-3.72V9.5l3-3V4.72A1.993 1.993 0 0 0 8 1zM2 4.2C1.34 4.2.8 3.65.8 3c0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2zm3 10c-.66 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2zm3-10c-.66 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2z"></path></svg>
            Fork
          </a>

          <div id="fork-destination-box" style="display: none;">
            <h2 class="facebox-header" data-facebox-id="facebox-header">Where should we fork this repository?</h2>
            <include-fragment src="" class="js-fork-select-fragment fork-select-fragment" data-url="/lihaoyi/macropy/fork?fragment=1">
              <img alt="Loading" src="octocat-spinner-128.gif" width="64" height="64">
            </include-fragment>
          </div>

    <a href="https://github.com/lihaoyi/macropy/network" class="social-count" aria-label="137 users forked this repository">
      137
    </a>
  </li>
</ul>

      <h1 class="public ">
  <svg class="octicon octicon-repo" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9H3V8h1v1zm0-3H3v1h1V6zm0-2H3v1h1V4zm0-2H3v1h1V2zm8-1v12c0 .55-.45 1-1 1H6v2l-1.5-1.5L3 16v-2H1c-.55 0-1-.45-1-1V1c0-.55.45-1 1-1h10c.55 0 1 .45 1 1zm-1 10H1v2h2v-1h3v1h5v-2zm0-10H2v9h9V1z"></path></svg>
  <span class="author" itemprop="author"><a class="url fn" rel="author" href="https://github.com/lihaoyi">lihaoyi</a></span><!--
--><span class="path-divider">/</span><!--
--><strong itemprop="name"><a data-pjax="#js-repo-pjax-container" href="https://github.com/lihaoyi/macropy">macropy</a></strong>

</h1>

    </div>
    
<nav class="reponav js-repo-nav js-sidenav-container-pjax container" itemscope="" itemtype="http://schema.org/BreadcrumbList" role="navigation" data-pjax="#js-repo-pjax-container">

  <span itemscope="" itemtype="http://schema.org/ListItem" itemprop="itemListElement">
    <a class="js-selected-navigation-item selected reponav-item" itemprop="url" data-hotkey="g c" data-selected-links="repo_source repo_downloads repo_commits repo_releases repo_tags repo_branches repo_packages /lihaoyi/macropy" href="https://github.com/lihaoyi/macropy">
      <svg class="octicon octicon-code" viewBox="0 0 14 16" version="1.1" width="14" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M9.5 3L8 4.5 11.5 8 8 11.5 9.5 13 14 8 9.5 3zm-5 0L0 8l4.5 5L6 11.5 2.5 8 6 4.5 4.5 3z"></path></svg>
      <span itemprop="name">Code</span>
      <meta itemprop="position" content="1">
</a>  </span>

    <span itemscope="" itemtype="http://schema.org/ListItem" itemprop="itemListElement">
      <a itemprop="url" data-hotkey="g i" class="js-selected-navigation-item reponav-item" data-selected-links="repo_issues repo_labels repo_milestones /lihaoyi/macropy/issues" href="https://github.com/lihaoyi/macropy/issues">
        <svg class="octicon octicon-issue-opened" viewBox="0 0 14 16" version="1.1" width="14" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg>
        <span itemprop="name">Issues</span>
        <span class="Counter">20</span>
        <meta itemprop="position" content="2">
</a>    </span>

  <span itemscope="" itemtype="http://schema.org/ListItem" itemprop="itemListElement">
    <a data-hotkey="g p" itemprop="url" class="js-selected-navigation-item reponav-item" data-selected-links="repo_pulls checks /lihaoyi/macropy/pulls" href="https://github.com/lihaoyi/macropy/pulls">
      <svg class="octicon octicon-git-pull-request" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M11 11.28V5c-.03-.78-.34-1.47-.94-2.06C9.46 2.35 8.78 2.03 8 2H7V0L4 3l3 3V4h1c.27.02.48.11.69.31.21.2.3.42.31.69v6.28A1.993 1.993 0 0 0 10 15a1.993 1.993 0 0 0 1-3.72zm-1 2.92c-.66 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2zM4 3c0-1.11-.89-2-2-2a1.993 1.993 0 0 0-1 3.72v6.56A1.993 1.993 0 0 0 2 15a1.993 1.993 0 0 0 1-3.72V4.72c.59-.34 1-.98 1-1.72zm-.8 10c0 .66-.55 1.2-1.2 1.2-.65 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2zM2 4.2C1.34 4.2.8 3.65.8 3c0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2z"></path></svg>
      <span itemprop="name">Pull requests</span>
      <span class="Counter">6</span>
      <meta itemprop="position" content="3">
</a>  </span>

    <a data-hotkey="g b" class="js-selected-navigation-item reponav-item" data-selected-links="repo_projects new_repo_project repo_project /lihaoyi/macropy/projects" href="https://github.com/lihaoyi/macropy/projects">
      <svg class="octicon octicon-project" viewBox="0 0 15 16" version="1.1" width="15" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M10 12h3V2h-3v10zm-4-2h3V2H6v8zm-4 4h3V2H2v12zm-1 1h13V1H1v14zM14 0H1a1 1 0 0 0-1 1v14a1 1 0 0 0 1 1h13a1 1 0 0 0 1-1V1a1 1 0 0 0-1-1z"></path></svg>
      Projects
      <span class="Counter">0</span>
</a>
    <a class="js-selected-navigation-item reponav-item" data-hotkey="g w" data-selected-links="repo_wiki /lihaoyi/macropy/wiki" href="https://github.com/lihaoyi/macropy/wiki">
      <svg class="octicon octicon-book" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M3 5h4v1H3V5zm0 3h4V7H3v1zm0 2h4V9H3v1zm11-5h-4v1h4V5zm0 2h-4v1h4V7zm0 2h-4v1h4V9zm2-6v9c0 .55-.45 1-1 1H9.5l-1 1-1-1H2c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h5.5l1 1 1-1H15c.55 0 1 .45 1 1zm-8 .5L7.5 3H2v9h6V3.5zm7-.5H9.5l-.5.5V12h6V3z"></path></svg>
      Wiki
</a>

  <a class="js-selected-navigation-item reponav-item" data-selected-links="repo_graphs repo_contributors dependency_graph pulse /lihaoyi/macropy/pulse" href="https://github.com/lihaoyi/macropy/pulse">
    <svg class="octicon octicon-graph" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M16 14v1H0V0h1v14h15zM5 13H3V8h2v5zm4 0H7V3h2v10zm4 0h-2V6h2v7z"></path></svg>
    Insights
</a>

</nav>


  </div>

<div class="container new-discussion-timeline experiment-repo-nav  ">
  <div class="repository-content ">

    
  

  <div class="js-repo-meta-container">
  <div class="repository-meta mb-0 mb-3 js-repo-meta-edit js-details-container ">
    <div class="repository-meta-content col-11 mb-1">
          <span class="col-11 text-gray-dark mr-2" itemprop="about">
            Macros in Python: quasiquotes, case classes, LINQ and more!
          </span>
    </div>

  </div>

</div>



  <div class="overall-summary overall-summary-bottomless">
    <div class="stats-switcher-viewport js-stats-switcher-viewport">
      <div class="stats-switcher-wrapper">
      <ul class="numbers-summary">
        <li class="commits">
          <a data-pjax="" href="https://github.com/lihaoyi/macropy/commits/master">
              <svg class="octicon octicon-history" viewBox="0 0 14 16" version="1.1" width="14" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 13H6V6h5v2H8v5zM7 1C4.81 1 2.87 2.02 1.59 3.59L0 2v4h4L2.5 4.5C3.55 3.17 5.17 2.3 7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-.34.03-.67.09-1H.08C.03 7.33 0 7.66 0 8c0 3.86 3.14 7 7 7s7-3.14 7-7-3.14-7-7-7z"></path></svg>
              <span class="num text-emphasized">
                637
              </span>
              commits
          </a>
        </li>
        <li>
          <a data-pjax="" href="https://github.com/lihaoyi/macropy/branches">
            <svg class="octicon octicon-git-branch" viewBox="0 0 10 16" version="1.1" width="10" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M10 5c0-1.11-.89-2-2-2a1.993 1.993 0 0 0-1 3.72v.3c-.02.52-.23.98-.63 1.38-.4.4-.86.61-1.38.63-.83.02-1.48.16-2 .45V4.72a1.993 1.993 0 0 0-1-3.72C.88 1 0 1.89 0 3a2 2 0 0 0 1 1.72v6.56c-.59.35-1 .99-1 1.72 0 1.11.89 2 2 2 1.11 0 2-.89 2-2 0-.53-.2-1-.53-1.36.09-.06.48-.41.59-.47.25-.11.56-.17.94-.17 1.05-.05 1.95-.45 2.75-1.25S8.95 7.77 9 6.73h-.02C9.59 6.37 10 5.73 10 5zM2 1.8c.66 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2C1.35 4.2.8 3.65.8 3c0-.65.55-1.2 1.2-1.2zm0 12.41c-.66 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2zm6-8c-.66 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2z"></path></svg>
            <span class="num text-emphasized">
              2
            </span>
            branches
          </a>
        </li>

        <li>
          <a href="https://github.com/lihaoyi/macropy/releases">
            <svg class="octicon octicon-tag" viewBox="0 0 14 16" version="1.1" width="14" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.73 1.73C7.26 1.26 6.62 1 5.96 1H3.5C2.13 1 1 2.13 1 3.5v2.47c0 .66.27 1.3.73 1.77l6.06 6.06c.39.39 1.02.39 1.41 0l4.59-4.59a.996.996 0 0 0 0-1.41L7.73 1.73zM2.38 7.09c-.31-.3-.47-.7-.47-1.13V3.5c0-.88.72-1.59 1.59-1.59h2.47c.42 0 .83.16 1.13.47l6.14 6.13-4.73 4.73-6.13-6.15zM3.01 3h2v2H3V3h.01z"></path></svg>
            <span class="num text-emphasized">
              0
            </span>
            releases
          </a>
        </li>

        <li>
            <a href="https://github.com/lihaoyi/macropy/graphs/contributors">
  <svg class="octicon octicon-organization" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M16 12.999c0 .439-.45 1-1 1H7.995c-.539 0-.994-.447-.995-.999H1c-.54 0-1-.561-1-1 0-2.634 3-4 3-4s.229-.409 0-1c-.841-.621-1.058-.59-1-3 .058-2.419 1.367-3 2.5-3s2.442.58 2.5 3c.058 2.41-.159 2.379-1 3-.229.59 0 1 0 1s1.549.711 2.42 2.088C9.196 9.369 10 8.999 10 8.999s.229-.409 0-1c-.841-.62-1.058-.59-1-3 .058-2.419 1.367-3 2.5-3s2.437.581 2.495 3c.059 2.41-.158 2.38-1 3-.229.59 0 1 0 1s3.005 1.366 3.005 4"></path></svg>
    <span class="num text-emphasized">
      10
    </span>
    contributors
</a>

        </li>
      </ul>

        <div class="repository-lang-stats">
          <ol class="repository-lang-stats-numbers">
            <li>
                <a href="https://github.com/lihaoyi/macropy/search?l=python" data-ga-click="Repository, language stats search click, location:repo overview">
                  <span class="color-block language-color" style="background-color:#3572A5;"></span>
                  <span class="lang">Python</span>
                  <span class="percent">100.0%</span>
                </a>
            </li>
          </ol>
        </div>
      </div>
    </div>
  </div>

    <div class="repository-lang-stats-graph js-toggle-lang-stats" title="Click for language details" data-ga-click="Repository, language bar stats toggle, location:repo overview">
      <span class="language-color" aria-label="Python 100.0%" style="width:100.0%; background-color:#3572A5;" itemprop="keywords">Python</span>
    </div>


    <include-fragment src="/lihaoyi/macropy/show_partial?partial=tree%2Frecently_touched_branches_list"></include-fragment>

  <div class="file-navigation in-mid-page">

    <details class="get-repo-select-menu js-get-repo-select-menu float-right position-relative dropdown-details details-reset">
  <summary class="btn btn-sm btn-primary">
    Clone or download
    <span class="dropdown-caret"></span>
  </summary>
  <div class="position-relative">
    <div class="get-repo-modal dropdown-menu dropdown-menu-sw pb-0 js-toggler-container  js-get-repo-modal">

      <div class="get-repo-modal-options">
          <div class="clone-options https-clone-options">
              <!-- '"` --><!-- </textarea></xmp> --><form data-remote="true" action="/users/set_protocol?protocol_selector=ssh&amp;protocol_type=clone" accept-charset="UTF-8" method="post"><input name="utf8" value="✓" type="hidden"><input name="authenticity_token" value="n+iI3vHtzXpOrRN4tQD1uc4PCcA4VwpLu/REfqAK9S5o+R577gOWQ99wcDmbtK64z5GF0oiygxglDiDiAeI3Vw==" type="hidden"><button type="submit" class="btn-link btn-change-protocol js-toggler-target float-right">Use SSH</button></form>

            <h4 class="mb-1">
              Clone with HTTPS
              <a class="muted-link" href="https://help.github.com/articles/which-remote-url-should-i-use" target="_blank" title="Which remote URL should I use?">
                <svg class="octicon octicon-question" viewBox="0 0 14 16" version="1.1" width="14" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M6 10h2v2H6v-2zm4-3.5C10 8.64 8 9 8 9H6c0-.55.45-1 1-1h.5c.28 0 .5-.22.5-.5v-1c0-.28-.22-.5-.5-.5h-1c-.28 0-.5.22-.5.5V7H4c0-1.5 1.5-3 3-3s3 1 3 2.5zM7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7z"></path></svg>
              </a>
            </h4>
            <p class="mb-2 get-repo-decription-text">
              Use Git or checkout with SVN using the web URL.
            </p>

            <div class="input-group">
  <input class="form-control input-monospace input-sm js-url-field" value="https://github.com/lihaoyi/macropy.git" aria-label="Clone this repository at https://github.com/lihaoyi/macropy.git" readonly="readonly" type="text">
  <div class="input-group-button">
    <clipboard-copy value="https://github.com/lihaoyi/macropy.git" aria-label="Copy to clipboard" class="btn btn-sm tooltipped tooltipped-s" copied-label="Copied!">
      <svg class="octicon octicon-clippy" viewBox="0 0 14 16" version="1.1" width="14" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M2 13h4v1H2v-1zm5-6H2v1h5V7zm2 3V8l-3 3 3 3v-2h5v-2H9zM4.5 9H2v1h2.5V9zM2 12h2.5v-1H2v1zm9 1h1v2c-.02.28-.11.52-.3.7-.19.18-.42.28-.7.3H1c-.55 0-1-.45-1-1V4c0-.55.45-1 1-1h3c0-1.11.89-2 2-2 1.11 0 2 .89 2 2h3c.55 0 1 .45 1 1v5h-1V6H1v9h10v-2zM2 5h8c0-.55-.45-1-1-1H8c-.55 0-1-.45-1-1s-.45-1-1-1-1 .45-1 1-.45 1-1 1H3c-.55 0-1 .45-1 1z"></path></svg>
    </clipboard-copy>
  </div>
</div>

          </div>

          <div class="clone-options ssh-clone-options">
              <!-- '"` --><!-- </textarea></xmp> --><form data-remote="true" action="/users/set_protocol?protocol_selector=https&amp;protocol_type=clone" accept-charset="UTF-8" method="post"><input name="utf8" value="✓" type="hidden"><input name="authenticity_token" value="Z2HZIdPU0am0PVpGQBGM3oxrl4FLk1sM7Byx5ago5XWQcE+EzDqKkCXgOQdupdffjfUbk/t20l9y5tV5CcAnDA==" type="hidden"><button type="submit" class="btn-link btn-change-protocol js-toggler-target float-right">Use HTTPS</button></form>

              <h4 class="mb-1">
                Clone with SSH
                <a class="muted-link" href="https://help.github.com/articles/which-remote-url-should-i-use" target="_blank" title="Which remote URL should I use?">
                  <svg class="octicon octicon-question" viewBox="0 0 14 16" version="1.1" width="14" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M6 10h2v2H6v-2zm4-3.5C10 8.64 8 9 8 9H6c0-.55.45-1 1-1h.5c.28 0 .5-.22.5-.5v-1c0-.28-.22-.5-.5-.5h-1c-.28 0-.5.22-.5.5V7H4c0-1.5 1.5-3 3-3s3 1 3 2.5zM7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7z"></path></svg>
                </a>
              </h4>
              <p class="mb-2 get-repo-decription-text">
                Use an SSH key and passphrase from account.
              </p>

              <div class="input-group">
  <input class="form-control input-monospace input-sm js-url-field" value="git@github.com:lihaoyi/macropy.git" aria-label="Clone this repository at git@github.com:lihaoyi/macropy.git" readonly="readonly" type="text">
  <div class="input-group-button">
    <clipboard-copy value="git@github.com:lihaoyi/macropy.git" aria-label="Copy to clipboard" class="btn btn-sm tooltipped tooltipped-s" copied-label="Copied!">
      <svg class="octicon octicon-clippy" viewBox="0 0 14 16" version="1.1" width="14" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M2 13h4v1H2v-1zm5-6H2v1h5V7zm2 3V8l-3 3 3 3v-2h5v-2H9zM4.5 9H2v1h2.5V9zM2 12h2.5v-1H2v1zm9 1h1v2c-.02.28-.11.52-.3.7-.19.18-.42.28-.7.3H1c-.55 0-1-.45-1-1V4c0-.55.45-1 1-1h3c0-1.11.89-2 2-2 1.11 0 2 .89 2 2h3c.55 0 1 .45 1 1v5h-1V6H1v9h10v-2zM2 5h8c0-.55-.45-1-1-1H8c-.55 0-1-.45-1-1s-.45-1-1-1-1 .45-1 1-.45 1-1 1H3c-.55 0-1 .45-1 1z"></path></svg>
    </clipboard-copy>
  </div>
</div>

          </div>
        <div class="mt-2">
          
<a href="https://github.com/lihaoyi/macropy/archive/master.zip" class="btn btn-outline get-repo-btn
" rel="nofollow" data-ga-click="Repository, download zip, location:repo overview">
  Download ZIP
</a>

        </div>
      </div>

      <div class="js-modal-download-mac py-2 px-3 d-none">
        <h4 class="lh-condensed mb-3">Launching GitHub Desktop<span class="animated-ellipsis-container"><span class="animated-ellipsis">...</span></span></h4>
        <p class="text-gray">If nothing happens, <a href="https://desktop.github.com/">download GitHub Desktop</a> and try again.</p>
        <p><button class="btn-link js-get-repo-modal-download-back">Go back</button></p>
      </div>

      <div class="js-modal-download-windows py-2 px-3 d-none">
        <h4 class="lh-condensed mb-3">Launching GitHub Desktop<span class="animated-ellipsis-container"><span class="animated-ellipsis">...</span></span></h4>
        <p class="text-gray">If nothing happens, <a href="https://desktop.github.com/">download GitHub Desktop</a> and try again.</p>
        <p><button class="btn-link js-get-repo-modal-download-back">Go back</button></p>
      </div>

      <div class="js-modal-download-xcode py-2 px-3 d-none">
        <h4 class="lh-condensed mb-3">Launching Xcode<span class="animated-ellipsis-container"><span class="animated-ellipsis">...</span></span></h4>
        <p class="text-gray">If nothing happens, <a href="https://developer.apple.com/xcode/">download Xcode</a> and try again.</p>
        <p><button class="btn-link js-get-repo-modal-download-back">Go back</button></p>
      </div>

      <div class="js-modal-download-visual-studio py-2 px-3 d-none">
        <h4 class="lh-condensed mb-3">Launching Visual Studio<span class="animated-ellipsis-container"><span class="animated-ellipsis">...</span></span></h4>
        <p class="text-gray">If nothing happens, <a href="https://visualstudio.github.com/">download the GitHub extension for Visual Studio</a> and try again.</p>
        <p><button class="btn-link js-get-repo-modal-download-back">Go back</button></p>
      </div>

    </div>
  </div>
</details>


  <div class="BtnGroup float-right">
      
  <!-- '"` --><!-- </textarea></xmp> --><form class="BtnGroup-form" action="/lihaoyi/macropy/new/master" accept-charset="UTF-8" method="post"><input name="utf8" value="✓" type="hidden"><input name="authenticity_token" value="0OmERNYu6a/cbuSLPh8l6k8h/1SYc9HqAPqkwIYVWKlc7/zrSH5tBJ7M9I4LKq4eIYdzHCxboNdUjsAKUKjJLw==" type="hidden">
    <button class="btn btn-sm BtnGroup-item" type="submit" data-disable-with="Creating file…">
      Create new file
    </button>
</form>

      
  <a href="https://github.com/lihaoyi/macropy/upload/master" class="btn btn-sm BtnGroup-item">
    Upload files
  </a>


    <a href="https://github.com/lihaoyi/macropy/find/master" class="btn btn-sm empty-icon float-right BtnGroup-item" data-pjax="" data-hotkey="t" data-ga-click="Repository, find file, location:repo overview">
      Find file
    </a>
  </div>

  
<div class="select-menu branch-select-menu js-menu-container js-select-menu float-left">
  <button class=" btn btn-sm select-menu-button js-menu-target css-truncate" data-hotkey="w" type="button" aria-label="Switch branches or tags" aria-expanded="false" aria-haspopup="true">
      <i>Branch:</i>
      <span class="js-select-button css-truncate-target">master</span>
  </button>

  <div class="select-menu-modal-holder js-menu-content js-navigation-container" data-pjax="">

    <div class="select-menu-modal">
      <div class="select-menu-header">
        <svg class="octicon octicon-x js-menu-close" role="img" aria-label="Close" viewBox="0 0 12 16" version="1.1" width="12" height="16"><path fill-rule="evenodd" d="M7.48 8l3.75 3.75-1.48 1.48L6 9.48l-3.75 3.75-1.48-1.48L4.52 8 .77 4.25l1.48-1.48L6 6.52l3.75-3.75 1.48 1.48z"></path></svg>
        <span class="select-menu-title">Switch branches/tags</span>
      </div>

      <div class="select-menu-filters">
        <div class="select-menu-text-filter">
          <input aria-label="Filter branches/tags" id="context-commitish-filter-field" class="form-control js-filterable-field js-navigation-enable" placeholder="Filter branches/tags" type="text">
        </div>
        <div class="select-menu-tabs">
          <ul>
            <li class="select-menu-tab">
              <a href="#" data-tab-filter="branches" data-filter-placeholder="Filter branches/tags" class="js-select-menu-tab" role="tab">Branches</a>
            </li>
            <li class="select-menu-tab">
              <a href="#" data-tab-filter="tags" data-filter-placeholder="Find a tag…" class="js-select-menu-tab" role="tab">Tags</a>
            </li>
          </ul>
        </div>
      </div>

      <div class="select-menu-list select-menu-tab-bucket js-select-menu-tab-bucket" data-tab-filter="branches" role="menu">

        <div data-filterable-for="context-commitish-filter-field" data-filterable-type="substring">


            <a class="select-menu-item js-navigation-item js-navigation-open selected" href="https://github.com/lihaoyi/macropy/tree/master" data-name="master" data-skip-pjax="true" rel="nofollow">
              <svg class="octicon octicon-check select-menu-item-icon" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M12 5l-8 8-4-4 1.5-1.5L4 10l6.5-6.5z"></path></svg>
              <span class="select-menu-item-text css-truncate-target js-select-menu-filter-text">
                master
              </span>
            </a>
            <a class="select-menu-item js-navigation-item js-navigation-open " href="https://github.com/lihaoyi/macropy/tree/python3" data-name="python3" data-skip-pjax="true" rel="nofollow">
              <svg class="octicon octicon-check select-menu-item-icon" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M12 5l-8 8-4-4 1.5-1.5L4 10l6.5-6.5z"></path></svg>
              <span class="select-menu-item-text css-truncate-target js-select-menu-filter-text">
                python3
              </span>
            </a>
        </div>

          <div class="select-menu-no-results">Nothing to show</div>
      </div>

      <div class="select-menu-list select-menu-tab-bucket js-select-menu-tab-bucket" data-tab-filter="tags">
        <div data-filterable-for="context-commitish-filter-field" data-filterable-type="substring">


        </div>

        <div class="select-menu-no-results">Nothing to show</div>
      </div>

    </div>
  </div>
</div>


        <a href="https://github.com/lihaoyi/macropy/pull/new/master" class="btn btn-sm new-pull-request-btn" data-pjax="" data-ga-click="Repository, new pull request, location:repo overview">
          New pull request
        </a>

  <div class="breadcrumb">
    
  </div>
</div>


  


  <div class="commit-tease js-details-container Details">
    <span class="float-right">
      Latest commit
      <a class="commit-tease-sha" href="https://github.com/lihaoyi/macropy/commit/13993ccb08df21a0d63b091dbaae50b9dbb3fe3e" data-pjax="">
        13993cc
      </a>
      <span itemprop="dateModified"><relative-time datetime="2014-02-16T05:41:43Z">Feb 16, 2014</relative-time></span>
    </span>


      <div class="d-flex no-wrap">
        
<div class="AvatarStack flex-self-start ">
  <div class="AvatarStack-body tooltipped tooltipped-se tooltipped-align-left-1" aria-label="lihaoyi">

        <a href="https://github.com/lihaoyi" data-skip-pjax="true" class="avatar">
          <img src="934140.jpeg" alt="@lihaoyi" width="20" height="20">
        </a>
  </div>
</div>

        <div class="flex-auto f6">
          
      <a href="https://github.com/lihaoyi/macropy/commits?author=lihaoyi" class="commit-author tooltipped tooltipped-s user-mention" aria-label="View all commits by lihaoyi">lihaoyi</a>


  



      <a href="https://github.com/lihaoyi/macropy/commit/13993ccb08df21a0d63b091dbaae50b9dbb3fe3e" class="message" data-pjax="true" title="Update readme.md

Add mention of Python3 branch, courtesy of @macobo and @Manticore">Update readme.md</a>
        <span class="hidden-text-expander inline">
          <button type="button" class="ellipsis-expander js-details-target" aria-expanded="false">…</button>
        </span>

      <div class="commit-desc"><pre class="text-small">Add mention of Python3 branch, courtesy of <a href="https://github.com/macobo" class="user-mention">@macobo</a> and <a href="https://github.com/Manticore" class="user-mention">@Manticore</a></pre></div>

        </div>
      </div>
  </div>



<div class="file-wrap">

  <a class="d-none js-permalink-shortcut" data-hotkey="y" href="https://github.com/lihaoyi/macropy/tree/13993ccb08df21a0d63b091dbaae50b9dbb3fe3e">Permalink</a>

  <table class="files js-navigation-container js-active-navigation-container" data-pjax="">


    <tbody>
      <tr class="warning include-fragment-error">
        <td class="icon"><svg class="octicon octicon-alert" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8.865 1.52c-.18-.31-.51-.5-.87-.5s-.69.19-.87.5L.275 13.5c-.18.31-.18.69 0 1 .19.31.52.5.87.5h13.7c.36 0 .69-.19.86-.5.17-.31.18-.69.01-1L8.865 1.52zM8.995 13h-2v-2h2v2zm0-3h-2V6h2v4z"></path></svg></td>
        <td class="content" colspan="3">Failed to load latest commit information.</td>
      </tr>

        <tr class="js-navigation-item">
          <td class="icon">
            <svg class="octicon octicon-file-directory" viewBox="0 0 14 16" version="1.1" width="14" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M13 4H7V3c0-.66-.31-1-1-1H1c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1V5c0-.55-.45-1-1-1zM6 4H1V3h5v1z"></path></svg>
            <img class="spinner" alt="" src="octocat-spinner-32.gif" width="16" height="16">
          </td>
          <td class="content">
            <span class="css-truncate css-truncate-target"><a class="js-navigation-open" title="docs" id="e3e2a9bfd88566b05001b02a3f51d286-8b2fcb92e97a9967b09d3ec244c66d18ca12613a" href="https://github.com/lihaoyi/macropy/tree/master/docs">docs</a></span>
          </td>
          <td class="message">
            <span class="css-truncate css-truncate-target">
                  <a data-pjax="true" title="Removed __init__.py from /docs so it doesnt get picked up as a package" class="message" href="https://github.com/lihaoyi/macropy/commit/01dccf70d7a36acba661a40e3d66423c6db184fb">Removed __init__.py from /docs so it doesnt get picked up as a package</a>
            </span>
          </td>
          <td class="age">
            <span class="css-truncate css-truncate-target"><time-ago datetime="2013-07-09T22:41:12Z">Jul 10, 2013</time-ago></span>
          </td>
        </tr>
        <tr class="js-navigation-item">
          <td class="icon">
            <svg class="octicon octicon-file-directory" viewBox="0 0 14 16" version="1.1" width="14" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M13 4H7V3c0-.66-.31-1-1-1H1c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1V5c0-.55-.45-1-1-1zM6 4H1V3h5v1z"></path></svg>
            <img class="spinner" alt="" src="octocat-spinner-32.gif" width="16" height="16">
          </td>
          <td class="content">
            <span class="css-truncate css-truncate-target"><a class="js-navigation-open" title="macropy" id="a12b0369d77b3467c4e2a60343b5e294-5d71d191883fbdd44511c5b36f0149195ac40a97" href="https://github.com/lihaoyi/macropy/tree/master/macropy">macropy</a></span>
          </td>
          <td class="message">
            <span class="css-truncate css-truncate-target">
                  <a data-pjax="true" title="touched up docstrings" class="message" href="https://github.com/lihaoyi/macropy/commit/6203a452a9044b66924c060fedc4c3b1bacb4923">touched up docstrings</a>
            </span>
          </td>
          <td class="age">
            <span class="css-truncate css-truncate-target"><time-ago datetime="2013-07-21T13:33:11Z">Jul 21, 2013</time-ago></span>
          </td>
        </tr>
        <tr class="js-navigation-item">
          <td class="icon">
            <svg class="octicon octicon-file" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M6 5H2V4h4v1zM2 8h7V7H2v1zm0 2h7V9H2v1zm0 2h7v-1H2v1zm10-7.5V14c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V2c0-.55.45-1 1-1h7.5L12 4.5zM11 5L8 2H1v12h10V5z"></path></svg>
            <img class="spinner" alt="" src="octocat-spinner-32.gif" width="16" height="16">
          </td>
          <td class="content">
            <span class="css-truncate css-truncate-target"><a class="js-navigation-open" title=".gitignore" id="a084b794bc0759e7a6b77810e01874f2-9dca85b344203e83f9bbf6a3225dc45e1091a49f" href="https://github.com/lihaoyi/macropy/blob/master/.gitignore">.gitignore</a></span>
          </td>
          <td class="message">
            <span class="css-truncate css-truncate-target">
                  <a data-pjax="true" title="tweaked stuff" class="message" href="https://github.com/lihaoyi/macropy/commit/a7a6b3e3557a381385867cb5cb642faaa5f5288f">tweaked stuff</a>
            </span>
          </td>
          <td class="age">
            <span class="css-truncate css-truncate-target"><time-ago datetime="2013-05-06T19:24:29Z">May 7, 2013</time-ago></span>
          </td>
        </tr>
        <tr class="js-navigation-item">
          <td class="icon">
            <svg class="octicon octicon-file" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M6 5H2V4h4v1zM2 8h7V7H2v1zm0 2h7V9H2v1zm0 2h7v-1H2v1zm10-7.5V14c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V2c0-.55.45-1 1-1h7.5L12 4.5zM11 5L8 2H1v12h10V5z"></path></svg>
            <img class="spinner" alt="" src="octocat-spinner-32.gif" width="16" height="16">
          </td>
          <td class="content">
            <span class="css-truncate css-truncate-target"><a class="js-navigation-open" title="changes.md" id="6aedba0e8644f6fb36eebae1c1885f7d-8c4e61c04aac1bfb05ce9004779d31d8c08c2366" href="https://github.com/lihaoyi/macropy/blob/master/changes.md">changes.md</a></span>
          </td>
          <td class="message">
            <span class="css-truncate css-truncate-target">
                  <a data-pjax="true" title="refactored `with_scope` into `Scoped`, making everything much less sketchy and adding docstrings" class="message" href="https://github.com/lihaoyi/macropy/commit/7c0f7485b343b5bc4465db5e342338d05065aae3">refactored `with_scope` into `Scoped`, making everything much less sk…</a>
            </span>
          </td>
          <td class="age">
            <span class="css-truncate css-truncate-target"><time-ago datetime="2013-07-21T12:47:08Z">Jul 21, 2013</time-ago></span>
          </td>
        </tr>
        <tr class="js-navigation-item">
          <td class="icon">
            <svg class="octicon octicon-file" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M6 5H2V4h4v1zM2 8h7V7H2v1zm0 2h7V9H2v1zm0 2h7v-1H2v1zm10-7.5V14c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V2c0-.55.45-1 1-1h7.5L12 4.5zM11 5L8 2H1v12h10V5z"></path></svg>
            <img class="spinner" alt="" src="octocat-spinner-32.gif" width="16" height="16">
          </td>
          <td class="content">
            <span class="css-truncate css-truncate-target"><a class="js-navigation-open" title="readme.md" id="0730bb7c2e8f9ea2438b52e419dd86c9-62917390866c441b77dbd7ff8f3034a457aaf1b4" href="https://github.com/lihaoyi/macropy/blob/master/readme.md">readme.md</a></span>
          </td>
          <td class="message">
            <span class="css-truncate css-truncate-target">
                  <a data-pjax="true" title="Update readme.md

Add mention of Python3 branch, courtesy of @macobo and @Manticore" class="message" href="https://github.com/lihaoyi/macropy/commit/13993ccb08df21a0d63b091dbaae50b9dbb3fe3e">Update readme.md</a>
            </span>
          </td>
          <td class="age">
            <span class="css-truncate css-truncate-target"><time-ago datetime="2014-02-16T05:41:43Z">Feb 16, 2014</time-ago></span>
          </td>
        </tr>
        <tr class="js-navigation-item">
          <td class="icon">
            <svg class="octicon octicon-file" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M6 5H2V4h4v1zM2 8h7V7H2v1zm0 2h7V9H2v1zm0 2h7v-1H2v1zm10-7.5V14c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V2c0-.55.45-1 1-1h7.5L12 4.5zM11 5L8 2H1v12h10V5z"></path></svg>
            <img class="spinner" alt="" src="octocat-spinner-32.gif" width="16" height="16">
          </td>
          <td class="content">
            <span class="css-truncate css-truncate-target"><a class="js-navigation-open" title="run_tests.py" id="0e150adfe1f55c100b4edc3a4b107418-51ad82841dd639e2a1ae67e29b3582911f838824" href="https://github.com/lihaoyi/macropy/blob/master/run_tests.py">run_tests.py</a></span>
          </td>
          <td class="message">
            <span class="css-truncate css-truncate-target">
                  <a data-pjax="true" title="Scope analysis works, usedi n hygienic quasiquotes and case classes to great effect" class="message" href="https://github.com/lihaoyi/macropy/commit/b86003e0062c4894cde6331455ffcb397f4a2e26">Scope analysis works, usedi n hygienic quasiquotes and case classes t…</a>
            </span>
          </td>
          <td class="age">
            <span class="css-truncate css-truncate-target"><time-ago datetime="2013-07-21T12:12:57Z">Jul 21, 2013</time-ago></span>
          </td>
        </tr>
        <tr class="js-navigation-item">
          <td class="icon">
            <svg class="octicon octicon-file" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M6 5H2V4h4v1zM2 8h7V7H2v1zm0 2h7V9H2v1zm0 2h7v-1H2v1zm10-7.5V14c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V2c0-.55.45-1 1-1h7.5L12 4.5zM11 5L8 2H1v12h10V5z"></path></svg>
            <img class="spinner" alt="" src="octocat-spinner-32.gif" width="16" height="16">
          </td>
          <td class="content">
            <span class="css-truncate css-truncate-target"><a class="js-navigation-open" title="setup.py" id="2eeaed663bd0d25b7e608891384b7298-7b6514dab6df2984c37e753d14d37f4aa4dce012" href="https://github.com/lihaoyi/macropy/blob/master/setup.py">setup.py</a></span>
          </td>
          <td class="message">
            <span class="css-truncate css-truncate-target">
                  <a data-pjax="true" title="Merge branch 'dev'

Conflicts:
	macropy/__init__.py
	readme.md" class="message" href="https://github.com/lihaoyi/macropy/commit/ae3c528b778772b4bbb9305e056981b60d7e19ec">Merge branch 'dev'</a>
            </span>
          </td>
          <td class="age">
            <span class="css-truncate css-truncate-target"><time-ago datetime="2013-07-05T23:41:53Z">Jul 6, 2013</time-ago></span>
          </td>
        </tr>
    </tbody>
  </table>

</div>



  <div id="readme" class="readme boxed-group clearfix announce instapaper_body md">
    <h3>
      <svg class="octicon octicon-book" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M3 5h4v1H3V5zm0 3h4V7H3v1zm0 2h4V9H3v1zm11-5h-4v1h4V5zm0 2h-4v1h4V7zm0 2h-4v1h4V9zm2-6v9c0 .55-.45 1-1 1H9.5l-1 1-1-1H2c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h5.5l1 1 1-1H15c.55 0 1 .45 1 1zm-8 .5L7.5 3H2v9h6V3.5zm7-.5H9.5l-.5.5V12h6V3z"></path></svg>
      readme.md
    </h3>

      <article class="markdown-body entry-content" itemprop="text"><h1><a href="#macropy-103" aria-hidden="true" class="anchor" id="user-content-macropy-103"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>MacroPy 1.0.3</h1>
<p><strong>MacroPy</strong> is an implementation of <a href="http://tinyurl.com/cmlls8v" rel="nofollow">Syntactic Macros</a> in the <a href="http://python.org/" rel="nofollow">Python Programming Language</a>. MacroPy provides a mechanism for user-defined functions (macros) to perform transformations on the <a href="http://en.wikipedia.org/wiki/Abstract_syntax_tree" rel="nofollow">abstract syntax tree</a> (AST) of a Python program at <em>import time</em>.
 This is an easy way to enhance the semantics of a Python program in 
ways which are otherwise impossible, for example providing an extremely 
concise way of declaring classes:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">import</span> macropy.console
<span class="pl-c1">0</span><span class="pl-k">=</span>[]<span class="pl-k">====</span><span class="pl-k">=</span><span class="pl-k">&gt;</span> MacroPy Enabled <span class="pl-k">&lt;=====</span>[]<span class="pl-k">=</span><span class="pl-c1">0</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">from</span> macropy.case_classes <span class="pl-k">import</span> macros, case

<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">@</span>case
<span class="pl-k">class</span> <span class="pl-en">Point</span>(<span class="pl-e">x</span>, <span class="pl-e">y</span>): <span class="pl-k">pass</span>

<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> p <span class="pl-k">=</span> Point(<span class="pl-c1">1</span>, <span class="pl-c1">2</span>)
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-c1">print</span> p.x
<span class="pl-c1">1</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-c1">print</span> p
Point(<span class="pl-c1">1</span>, <span class="pl-c1">2</span>)</pre></div>
<p>Try it out in the REPL, it should just work! You can also see the <a href="https://github.com/lihaoyi/macropy/blob/master/docs/examples/using_macros">docs/examples/using_macros</a> folder for a minimal example of using MacroPy's existing macros.</p>
<p>MacroPy has been used to implement features such as:</p>
<ul>
<li><a href="#case-classes">Case Classes</a>, easy Algebraic Data Types from Scala, and <a href="#enums">Enums</a></li>
<li><a href="#quick-lambdas">Quick Lambdas</a> from Scala and Groovy, and the <a href="#lazy">Lazy</a> and <a href="#interned">Interned</a> utility macros</li>
<li><a href="#string-interpolation">String Interpolation</a>, a common feature in many programming languages</li>
<li><a href="#tracing">Tracing</a> and <a href="#smart-asserts">Smart Asserts</a>, and <a href="#show_expanded">show_expanded</a>, to help in the debugging effort</li>
<li><a href="#macropeg-parser-combinators">MacroPEG</a>, Parser Combinators inspired by Scala's</li>
</ul>
<p>As well as a number of more experimental macros such as:</p>
<ul>
<li><a href="#pattern-matching">Pattern Matching</a> from the Functional Programming world</li>
<li><a href="#tail-call-optimization">Tail-call Optimization</a>, preventing unnecessary stack overflows</li>
<li><a href="#pinq-to-sqlalchemy">PINQ to SQLAlchemy</a>, a shameless clone of LINQ to SQL from C#</li>
<li><a href="#pyxl-snippets">Pyxl Snippets</a>, XML interpolation within your Python code</li>
<li><a href="#js-snippets">JS Snippets</a>, cross compiling snippets of Python into equivalent Javascript</li>
</ul>
<p>Browse the <a href="#30,000ft-overview">high-level overview</a>, or look at the <a href="#tutorials">Tutorials</a> will go into greater detail and walk you through</p>
<ul>
<li><a href="#writing-your-first-macro">Writing your first macro</a></li>
<li><a href="#making-your-macros-hygienic">Making your macros hygienic</a></li>
<li><a href="#exporting-your-expanded-code">Exporting your Expanded Code</a></li>
</ul>
<p>The <a href="#reference">Reference Documentation</a> contains information about:</p>
<ul>
<li><a href="#data-model">Data Model</a>, what MacroPy gives you to work with</li>
<li><a href="#arguments">Arguments</a>, what a macro is given to do its work</li>
<li><a href="#quasiquotes">Quasiquotes</a>, a quick way to manipulate AST fragments</li>
<li><a href="#walkers">Walkers</a>, a flexible tool to traverse and transform ASTs</li>
<li><a href="#hygiene">Hygiene</a>, how to avoid weird bugs related to name collisions and shadowing</li>
<li><a href="#expansion-failures">Expansion Failures</a>, what happens when a macro doesn't work.</li>
<li><a href="#expansion-order">Expansion Order</a> of nested macros with a file</li>
<li><a href="#line-numbers">Line Numbers</a>, or what errors you get when something goes wrong.</li>
</ul>
<p>Or just skip ahead to the <a href="#discussion">Discussion</a> and <a href="#macropy-bringing-macros-to-python">Conclusion</a>.
 We're open to contributions, so send us your 
ideas/questions/issues/pull-requests and we'll do our best to 
accommodate you! You can ask questions on the <a href="https://groups.google.com/forum/#%21forum/macropy" rel="nofollow">Google Group</a> or file bugs on thee <a href="https://github.com/lihaoyi/macropy/blob/master/issues">issues</a> page. See the <a href="https://github.com/lihaoyi/macropy/blob/master/changes.md">changelist</a> to see what's changed recently.</p>
<p>MacroPy is tested to run on <a href="http://en.wikipedia.org/wiki/CPython" rel="nofollow">CPython 2.7.2</a> and <a href="http://pypy.org/" rel="nofollow">PyPy 2.0</a>, but with only partial support for Python 3.X (You'll need to clone the <a href="https://github.com/lihaoyi/macropy/tree/python3">python3 branch</a> yourself) and no support for <a href="http://www.jython.org/" rel="nofollow">Jython</a>. MacroPy is also available on <a href="https://pypi.python.org/pypi/MacroPy" rel="nofollow">PyPI</a>, using a standard <a href="https://github.com/lihaoyi/macropy/blob/master/setup.py">setup.py</a> to manage dependencies, installation and other things. Check out <a href="https://gist.github.com/lihaoyi/5577609">this gist</a> for an example of setting it up on a clean system.</p>
<h1><a href="#30000ft-overview" aria-hidden="true" class="anchor" id="user-content-30000ft-overview"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>30,000ft Overview</h1>
<p>Macro functions are defined in three ways:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.core.macros <span class="pl-k">import</span> <span class="pl-k">*</span>

macros <span class="pl-k">=</span> Macros()

<span class="pl-en">@macros.expr</span>
<span class="pl-k">def</span> <span class="pl-en">my_expr_macro</span>(<span class="pl-smi">tree</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    <span class="pl-c1">...</span>
    <span class="pl-k">return</span> new_tree

<span class="pl-en">@macros.block</span>
<span class="pl-k">def</span> <span class="pl-en">my_block_macro</span>(<span class="pl-smi">tree</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    <span class="pl-c1">...</span>
    <span class="pl-k">return</span> new_tree

<span class="pl-en">@macros.decorator</span>
<span class="pl-k">def</span> <span class="pl-en">my_decorator_macro</span>(<span class="pl-smi">tree</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    <span class="pl-c1">...</span>
    <span class="pl-k">return</span> new_tree</pre></div>
<p>The line <code>macros = Macros()</code> is required to mark the file as providing macros, and the <code>macros</code> object then provides the methods <code>expr</code>, <code>block</code> and <code>decorator</code> which can be used to decorate functions to mark them out as the three different kinds of macros.</p>
<p>Each macro function is passed a <code>tree</code>. The <code>tree</code> is an <code>AST</code> object, the sort provided by Python's <a href="http://docs.python.org/2/library/ast.html" rel="nofollow">ast module</a>. The macro is able to do whatever transformations it wants, and it returns a modified (or even an entirely new) <code>AST</code> object which MacroPy will use to replace the original macro invocation. The macro also takes <code>**kw</code>, which contains <a href="#arguments">other useful things</a> which you may need.</p>
<p>These three types of macros are called via:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> my_macro_module <span class="pl-k">import</span> macros, my_expr_macro, my_block_macro, my_decorator_macro

val <span class="pl-k">=</span> my_expr_macro[<span class="pl-c1">...</span>]

<span class="pl-k">with</span> my_block_macro:
    <span class="pl-c1">...</span>

<span class="pl-en">@my_decorator_macro</span>
<span class="pl-k">class</span> <span class="pl-en">X</span>():
    <span class="pl-c1">...</span></pre></div>
<p>Where the line <code>from my_macro_module import macros, ...</code> is necessary to tell MacroPy which macros these module relies on. Multiple things can be imported from each module, but <code>macros</code> must come first for macros from that module to be used.</p>
<p>Any time any of these syntactic forms is seen, if a matching macro exists in any of the packages from which <code>macros</code> has been imported from, the abstract syntax tree captured by these forms (the <code>...</code>
 in the code above) is given to the respective macro to handle. The tree
 (new, modified, or even unchanged) which the macro returns is 
substituted into the original code in-place.</p>
<p>MacroPy intercepts the module-loading workflow, via the functionality provided by <a href="http://www.python.org/dev/peps/pep-0302/" rel="nofollow">PEP 302: New Import Hooks</a>. The workflow is roughly:</p>
<ul>
<li>Intercept an import</li>
<li>Parse the contents of the file into an AST</li>
<li>Walk the AST and expand any macros that it finds</li>
<li>Compile the modified AST and resume loading it as a module</li>
</ul>
<p><a href="https://github.com/lihaoyi/macropy/blob/master/docs/media/Workflow.png" target="_blank"><img src="Workflow" alt="Workflow" style="max-width:100%;"></a></p>
<p>Note that this means <strong>you cannot use macros in a file that is run directly</strong>, as it will not be passed through the import hooks. Hence the minimum viable setup is:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> run.py</span>
<span class="pl-k">import</span> macropy.activate     <span class="pl-c"><span class="pl-c">#</span> sets up macro import hooks</span>
<span class="pl-k">import</span> other                <span class="pl-c"><span class="pl-c">#</span> imports other.py and passes it through import hooks</span>


<span class="pl-c"><span class="pl-c">#</span> my_macro_module.py</span>
<span class="pl-k">from</span> macropy.core.macros <span class="pl-k">import</span> <span class="pl-k">*</span>

macros <span class="pl-k">=</span> Macros()

<span class="pl-c1">...</span> define some macros <span class="pl-c1">...</span>


<span class="pl-c"><span class="pl-c">#</span> other.py</span>
<span class="pl-k">from</span> macropy.macros.my_macro_module <span class="pl-k">import</span> macros, <span class="pl-c1">...</span>

<span class="pl-c1">...</span> do stuff <span class="pl-k">with</span> macros <span class="pl-c1">...</span></pre></div>
<p>Where you run <code>run.py</code> instead of <code>other.py</code>. For the same reason, you cannot directly run MacroPy's own unit tests directly using <code>unittest</code> or <code>nose</code>: you need to run the <a href="https://github.com/lihaoyi/macropy/blob/master/macropy/run_tests.py">macropy/run_tests.py</a> file from the project root for the tests to run. See the <a href="https://github.com/lihaoyi/macropy/blob/master/docs/examples/nop">runnable, self-contained no-op example</a> to see exactly what this looks like, or the example for <a href="https://github.com/lihaoyi/macropy/blob/master/docs/examples/using_macros">using existing macros</a>.</p>
<p>MacroPy also works in the REPL:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c1">PS</span> C:\<span class="pl-ii">Dropbox\Workspace\macropy&gt; python</span>
Python <span class="pl-c1">2.7</span> (r27:<span class="pl-c1">82525</span>, Jul  <span class="pl-c1">4</span> <span class="pl-c1">2010</span>, <span class="pl-c1">0<span class="pl-ii">7</span></span>:<span class="pl-c1">43</span>:<span class="pl-c1">0<span class="pl-ii">8</span></span>) [<span class="pl-c1">MSC</span> v.1500 <span class="pl-c1">64</span> bit (<span class="pl-c1">AMD64</span>)] on win32
Type <span class="pl-s"><span class="pl-pds">"</span>help<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>copyright<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>credits<span class="pl-pds">"</span></span> <span class="pl-k">or</span> <span class="pl-s"><span class="pl-pds">"</span>license<span class="pl-pds">"</span></span> <span class="pl-k">for</span> more information.
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">import</span> macropy.console
<span class="pl-c1">0</span><span class="pl-k">=</span>[]<span class="pl-k">====</span><span class="pl-k">=</span><span class="pl-k">&gt;</span> MacroPy Enabled <span class="pl-k">&lt;=====</span>[]<span class="pl-k">=</span><span class="pl-c1">0</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">from</span> macropy.tracing <span class="pl-k">import</span> macros, trace
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> trace[[x<span class="pl-k">*</span><span class="pl-c1">2</span> <span class="pl-k">for</span> x <span class="pl-k">in</span> <span class="pl-c1">range</span>(<span class="pl-c1">3</span>)]]
<span class="pl-c1">range</span>(<span class="pl-c1">3</span>) <span class="pl-ii">-&gt;</span> [<span class="pl-c1">0</span>, <span class="pl-c1">1</span>, <span class="pl-c1">2</span>]
x<span class="pl-k">*</span><span class="pl-c1">2</span> <span class="pl-ii">-&gt;</span> <span class="pl-c1">0</span>
x<span class="pl-k">*</span><span class="pl-c1">2</span> <span class="pl-ii">-&gt;</span> <span class="pl-c1">2</span>
x<span class="pl-k">*</span><span class="pl-c1">2</span> <span class="pl-ii">-&gt;</span> <span class="pl-c1">4</span>
x<span class="pl-k">*</span><span class="pl-c1">2</span> <span class="pl-k">for</span> x <span class="pl-k">in</span> <span class="pl-c1">range</span>(<span class="pl-c1">3</span>) <span class="pl-ii">-&gt;</span> [<span class="pl-c1">0</span>, <span class="pl-c1">2</span>, <span class="pl-c1">4</span>]
[<span class="pl-c1">0</span>, <span class="pl-c1">2</span>, <span class="pl-c1">4</span>]</pre></div>
<p>This example demonstrates the usage of the <a href="#tracing">Tracing</a>
 macro, which helps trace the evaluation of a Python expression. 
Although support for the REPL is still experimental, most examples on 
this page will work when copied and pasted into the REPL verbatim. 
MacroPy also works in the PyPy and <a href="http://ipython.org/" rel="nofollow">IPython</a> REPLs.</p>
<h1><a href="#demo-macros" aria-hidden="true" class="anchor" id="user-content-demo-macros"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Demo Macros</h1>
<p>Below are a few example uses of macros that are implemented (together with test cases!) in the <a href="https://github.com/lihaoyi/macropy/blob/master/macropy">macropy</a> and <a href="https://github.com/lihaoyi/macropy/blob/master/macropy/experimental">macropy/experimental</a> folders. These are also the ideal places to go look at to learn to write your own macros: check out the source code of the <a href="https://github.com/lihaoyi/macropy/blob/master/macropy/string_interp.py">String Interpolation</a> or <a href="https://github.com/lihaoyi/macropy/blob/master/macropy/quick_lambda.py">Quick Lambda</a> macros for some small (&lt;30 lines), self contained examples. Their <a href="https://github.com/lihaoyi/macropy/blob/master/macropy/test/string_interp.py">unit</a> <a href="https://github.com/lihaoyi/macropy/blob/master/macropy/test/quick_lambda.py">tests</a> demonstrate how these macros are used.</p>
<p>Feel free to open up a REPL and try out the examples in the console; simply <code>import macropy.console</code>,
 and most of the examples should work right off the bat when pasted in! 
Macros in this section are also relatively stable and well-tested, and 
you can rely on them to work and not to suddenly change from version to 
version (as much as can be said for a two-month-old project!).</p>
<h2><a href="#case-classes" aria-hidden="true" class="anchor" id="user-content-case-classes"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Case Classes</h2>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.case_classes <span class="pl-k">import</span> macros, case

<span class="pl-en">@case</span>
<span class="pl-k">class</span> <span class="pl-en">Point</span>(<span class="pl-e">x</span>, <span class="pl-e">y</span>): <span class="pl-k">pass</span>

p <span class="pl-k">=</span> Point(<span class="pl-c1">1</span>, <span class="pl-c1">2</span>)

<span class="pl-c1">print</span> <span class="pl-c1">str</span>(p) <span class="pl-c"><span class="pl-c">#</span> Point(1, 2)</span>
<span class="pl-c1">print</span> p.x    <span class="pl-c"><span class="pl-c">#</span> 1</span>
<span class="pl-c1">print</span> p.y    <span class="pl-c"><span class="pl-c">#</span> 2</span>
<span class="pl-c1">print</span> Point(<span class="pl-c1">1</span>, <span class="pl-c1">2</span>) <span class="pl-k">==</span> Point(<span class="pl-c1">1</span>, <span class="pl-c1">2</span>) <span class="pl-c"><span class="pl-c">#</span> True</span>
x, y <span class="pl-k">=</span> p
<span class="pl-c1">print</span> x, y   <span class="pl-c"><span class="pl-c">#</span> 1 2</span></pre></div>
<p><a href="http://www.codecommit.com/blog/scala/case-classes-are-cool" rel="nofollow">Case classes</a> are classes with extra goodies:</p>
<ul>
<li>Nice <code>__str__</code> and <code>__repr__</code> methods autogenerated</li>
<li>An autogenerated constructor</li>
<li>Structural equality by default</li>
<li>A copy-constructor, for creating modified copies of instances</li>
<li>A <code>__slots__</code> declaration, to improve memory efficiency</li>
<li>An <code>__iter__</code> method, to allow destructuring</li>
</ul>
<p>The reasoning being that although you may sometimes want complex, 
custom-built classes with custom features and fancy inheritance, very 
(very!) often you want a simple class with a constructor, pretty <code>__str__</code> and <code>__repr__</code>
 methods, and structural equality which doesn't inherit from anything. 
Case classes provide you just that, with an extremely concise 
declaration:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@case</span>
<span class="pl-k">class</span> <span class="pl-en">Point</span>(<span class="pl-e">x</span>, <span class="pl-e">y</span>): <span class="pl-k">pass</span></pre></div>
<p>As opposed to the equivalent class, written manually:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">class</span> <span class="pl-en">Point</span>(<span class="pl-c1">object</span>):
    <span class="pl-c1">__slots__</span> <span class="pl-k">=</span> [<span class="pl-s"><span class="pl-pds">'</span>x<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>y<span class="pl-pds">'</span></span>]
    <span class="pl-k">def</span> <span class="pl-c1">__init__</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>, <span class="pl-smi">x</span>, <span class="pl-smi">y</span>):
        <span class="pl-c1">self</span>.x <span class="pl-k">=</span> x
        <span class="pl-c1">self</span>.y <span class="pl-k">=</span> y

    <span class="pl-k">def</span> <span class="pl-c1">__str__</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>):
        <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>Point(<span class="pl-pds">"</span></span> <span class="pl-k">+</span> <span class="pl-c1">self</span>.x <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span>, <span class="pl-pds">"</span></span> <span class="pl-k">+</span> <span class="pl-c1">self</span>.y <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span>)<span class="pl-pds">"</span></span>

    <span class="pl-k">def</span> <span class="pl-c1">__repr__</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>):
        <span class="pl-k">return</span> <span class="pl-c1">self</span>.<span class="pl-c1">__str__</span>()

    <span class="pl-k">def</span> <span class="pl-c1">__eq__</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>, <span class="pl-smi">other</span>):
        <span class="pl-k">return</span> <span class="pl-c1">self</span>.x <span class="pl-k">==</span> other.x <span class="pl-k">and</span> <span class="pl-c1">self</span>.y <span class="pl-k">==</span> other.y

    <span class="pl-k">def</span> <span class="pl-c1">__ne__</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>, <span class="pl-smi">other</span>):
        <span class="pl-k">return</span> <span class="pl-k">not</span> <span class="pl-c1">self</span>.<span class="pl-c1">__eq__</span>(other)

    <span class="pl-k">def</span> <span class="pl-c1">__iter__</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>, <span class="pl-smi">other</span>):
        <span class="pl-k">yield</span> <span class="pl-c1">self</span>.x
        <span class="pl-k">yield</span> <span class="pl-c1">self</span>.y</pre></div>
<p>Whew, what a lot of boilerplate! This is clearly a pain to do, error prone to deal with, and violates <a href="http://en.wikipedia.org/wiki/Don%27t_repeat_yourself" rel="nofollow">DRY</a> in an extreme way: each member of the class (<code>x</code> and <code>y</code> in this case) has to be repeated <em>8 times</em>, with loads and loads of boilerplate. It is also <em>buggy</em>,
 and will fail at runtime when the above example is run, so see if you 
can spot the bug in it! Given how tedious writing all this code is, it 
is no surprise that most python classes do not come with proper <code>__str__</code> or useful <code>__eq__</code> functions! With case classes, there is no excuse, since all this will be generated for you.</p>
<p>Case classes also provide a convenient <em>copy-constructor</em>, which creates a shallow copy of the case class with modified fields, leaving the original unchanged:</p>
<div class="highlight highlight-source-python"><pre>a <span class="pl-k">=</span> Point(<span class="pl-c1">1</span>, <span class="pl-c1">2</span>)
b <span class="pl-k">=</span> a.copy(<span class="pl-v">x</span> <span class="pl-k">=</span> <span class="pl-c1">3</span>)
<span class="pl-c1">print</span> a <span class="pl-c"><span class="pl-c">#</span> Point(1, 2)</span>
<span class="pl-c1">print</span> b <span class="pl-c"><span class="pl-c">#</span> Point(3, 2)</span></pre></div>
<p>Like any other class, a case class may contain methods in its body:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@case</span>
<span class="pl-k">class</span> <span class="pl-en">Point</span>(<span class="pl-e">x</span>, <span class="pl-e">y</span>):
    <span class="pl-k">def</span> <span class="pl-en">length</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>):
        <span class="pl-k">return</span> (<span class="pl-c1">self</span>.x <span class="pl-k">**</span> <span class="pl-c1">2</span> <span class="pl-k">+</span> <span class="pl-c1">self</span>.y <span class="pl-k">**</span> <span class="pl-c1">2</span>) <span class="pl-k">**</span> <span class="pl-c1">0.5</span>

<span class="pl-c1">print</span> Point(<span class="pl-c1">3</span>, <span class="pl-c1">4</span>).length() <span class="pl-c"><span class="pl-c">#</span> 5.0</span></pre></div>
<p>or class variables. The only restrictions are that only the <code>__init__</code>, <code>__repr__</code>, <code>___str__</code>, <code>__eq__</code> methods will be set for you, and the initializer/class body and inheritance are treated specially.</p>
<p>###Body Initializer</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@case</span>
<span class="pl-k">class</span> <span class="pl-en">Point</span>(<span class="pl-e">x</span>, <span class="pl-e">y</span>):
    <span class="pl-c1">self</span>.length <span class="pl-k">=</span> (<span class="pl-c1">self</span>.x<span class="pl-k">**</span><span class="pl-c1">2</span> <span class="pl-k">+</span> <span class="pl-c1">self</span>.y<span class="pl-k">**</span><span class="pl-c1">2</span>) <span class="pl-k">**</span> <span class="pl-c1">0.5</span>

<span class="pl-c1">print</span> Point(<span class="pl-c1">3</span>, <span class="pl-c1">4</span>).length <span class="pl-c"><span class="pl-c">#</span> 5</span></pre></div>
<p>Case classes allow you to add initialization logic by simply placing 
the initialization statements in the class body: any statements within 
the class body which are not class or function definitions are taken to 
be part of the initializer, and so you can use e.g. the <code>self</code> variable to set instance members just like in a normal <code>__init__</code> method.</p>
<p>Any additional assignments to <code>self.XXX</code> in the body of the class scope are detected and the <code>XXX</code> added to the class' <code>__slots__</code> declaration, meaning you generally don't need to worry about <code>__slots__</code>
 limiting what you can do with the class. As long as there is an 
assignment to the member somewhere in the class' body, it will be added 
to slots. This means if you try to set a member of an instance via <code>my_thing.XXX = ...</code>
 somewhere else, but aren't setting it anywhere in the class' body, it 
will fail with an AttributeError. The solution to this is to simply add a
 <code>self.XXX = None</code> in the class body, which will get picked up and added to its <code>__slots__</code>.</p>
<p>The body initializer also means you cannot set <em>class</em> members on a case class, as it any bare assignments <code>XXX = ...</code> will get treated as a local variable assignment in the scope of the class' <code>__init__</code> method. This is one of <a href="#limitations">several limitations</a>.</p>
<p>###Defaults, <code>*args</code> and <code>**kwargs</code></p>
<p>Case classes also provide a syntax for default values:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@case</span>
<span class="pl-k">class</span> <span class="pl-en">Point</span>(<span class="pl-e">x</span> <span class="pl-k">|</span> <span class="pl-c1">0</span>, <span class="pl-e">y</span> <span class="pl-k">|</span> <span class="pl-c1">0</span>):
    <span class="pl-k">pass</span>

<span class="pl-c1">print</span> <span class="pl-c1">str</span>(Point(<span class="pl-v">y</span> <span class="pl-k">=</span> <span class="pl-c1">5</span>)) <span class="pl-c"><span class="pl-c">#</span> Point(0, 5)</span></pre></div>
<p>For <code>*args</code>:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@case</span>
<span class="pl-k">class</span> <span class="pl-en">PointArgs</span>(<span class="pl-e">x</span>, <span class="pl-e">y</span>, [rest]):
    <span class="pl-k">pass</span>

<span class="pl-c1">print</span> PointArgs(<span class="pl-c1">3</span>, <span class="pl-c1">4</span>, <span class="pl-c1">5</span>, <span class="pl-c1">6</span>, <span class="pl-c1">7</span>).rest <span class="pl-c"><span class="pl-c">#</span> (5, 6, 7)</span></pre></div>
<p>and <code>**kwargs</code>:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@case</span>
<span class="pl-k">class</span> <span class="pl-en">PointKwargs</span>(<span class="pl-e">x</span>, <span class="pl-e">y</span>, {rest}):
    <span class="pl-k">pass</span>

<span class="pl-c1">print</span> PointKwargs(<span class="pl-c1">1</span>, <span class="pl-c1">2</span>, <span class="pl-v">a</span><span class="pl-k">=</span><span class="pl-c1">1</span>, <span class="pl-v">b</span><span class="pl-k">=</span><span class="pl-c1">2</span>).rest <span class="pl-c"><span class="pl-c">#</span> {'a': 1, 'b': 2}</span></pre></div>
<p>All these behave as you would expect, and can be combined in all the normal ways. The strange syntax (rather than the normal <code>x=0</code>, <code>*args</code> or <code>**kwargs</code>) is due to limitations in the Python 2.7 grammar, which are removed in Python 3.3.</p>
<p>###Inheritance
Instead of manual inheritance, inheritance for case classes is defined by <em>nesting</em>, as shown below:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@case</span>
<span class="pl-k">class</span> <span class="pl-en">List</span>():
    <span class="pl-k">def</span> <span class="pl-c1">__len__</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>):
        <span class="pl-k">return</span> <span class="pl-c1">0</span>

    <span class="pl-k">def</span> <span class="pl-c1">__iter__</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>):
        <span class="pl-k">return</span> <span class="pl-c1">iter</span>([])

    <span class="pl-k">class</span> <span class="pl-en">Nil</span>:
        <span class="pl-k">pass</span>

    <span class="pl-k">class</span> <span class="pl-en">Cons</span>(<span class="pl-e">head</span>, <span class="pl-e">tail</span>):
        <span class="pl-k">def</span> <span class="pl-c1">__len__</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>):
            <span class="pl-k">return</span> <span class="pl-c1">1</span> <span class="pl-k">+</span> <span class="pl-c1">len</span>(<span class="pl-c1">self</span>.tail)

        <span class="pl-k">def</span> <span class="pl-c1">__iter__</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>):
            current <span class="pl-k">=</span> <span class="pl-c1">self</span>

            <span class="pl-k">while</span> <span class="pl-c1">len</span>(current) <span class="pl-k">&gt;</span> <span class="pl-c1">0</span>:
                <span class="pl-k">yield</span> current.head
                current <span class="pl-k">=</span> current.tail

<span class="pl-c1">print</span> <span class="pl-c1">isinstance</span>(List.Cons(<span class="pl-c1">None</span>, <span class="pl-c1">None</span>), List)    <span class="pl-c"><span class="pl-c">#</span> True</span>
<span class="pl-c1">print</span> <span class="pl-c1">isinstance</span>(List.Nil(), List)               <span class="pl-c"><span class="pl-c">#</span> True</span>

my_list <span class="pl-k">=</span> List.Cons(<span class="pl-c1">1</span>, List.Cons(<span class="pl-c1">2</span>, List.Cons(<span class="pl-c1">3</span>, List.Nil())))
empty_list <span class="pl-k">=</span> List.Nil()

<span class="pl-c1">print</span> my_list.head              <span class="pl-c"><span class="pl-c">#</span> 1</span>
<span class="pl-c1">print</span> my_list.tail              <span class="pl-c"><span class="pl-c">#</span> List.Cons(2, List.Cons(3, List.Nil()))</span>
<span class="pl-c1">print</span> <span class="pl-c1">len</span>(my_list)              <span class="pl-c"><span class="pl-c">#</span> 5</span>
<span class="pl-c1">print</span> <span class="pl-c1">sum</span>(<span class="pl-c1">iter</span>(my_list))        <span class="pl-c"><span class="pl-c">#</span> 6</span>
<span class="pl-c1">print</span> <span class="pl-c1">sum</span>(<span class="pl-c1">iter</span>(empty_list))     <span class="pl-c"><span class="pl-c">#</span> 0</span></pre></div>
<p>This is an implementation of a singly linked <a href="http://en.wikipedia.org/wiki/Cons" rel="nofollow">cons list</a>, providing both <code>head</code> and <code>tail</code> (<a href="https://en.wikipedia.org/wiki/LISP" rel="nofollow">LISP</a>'s <code>car</code> and <code>cdr</code>) as well as the ability to get the <code>len</code> or <code>iter</code> for the list.</p>
<p>As the classes <code>Nil</code> are <code>Cons</code> are nested within <code>List</code>, both of them get transformed into case  classes which inherit from it. This nesting can go arbitrarily deep.</p>
<p>###Overriding</p>
<p>Except for the <code>__init__</code> method, all the methods provided by case classes are inherited from <code>macropy.case_classes.CaseClass</code>, and can thus be overriden, with the overriden method still accessible via the normal mechanisms:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.case_classes <span class="pl-k">import</span> CaseClass

<span class="pl-en">@case</span>
<span class="pl-k">class</span> <span class="pl-en">Point</span>(<span class="pl-e">x</span>, <span class="pl-e">y</span>):
    <span class="pl-k">def</span> <span class="pl-c1">__str__</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>):
        <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>mooo <span class="pl-pds">"</span></span> <span class="pl-k">+</span> CaseClass.<span class="pl-c1">__str__</span>(<span class="pl-c1">self</span>)

<span class="pl-c1">print</span> Point(<span class="pl-c1">1</span>, <span class="pl-c1">2</span>) <span class="pl-c"><span class="pl-c">#</span> mooo Point(1, 2)</span></pre></div>
<p>The <code>__init__</code> method is generated, not inherited. For the
 common case of adding additional initialization steps after the 
assignment of arguments to members, you can use the <a href="#body-initializer">body initializer</a>
 described above. However, if you want a different modification (e.g. 
changing the number of arguments) you can achieve this by manually 
defining your own <code>__init__</code> method:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@case</span>
<span class="pl-k">class</span> <span class="pl-en">Point</span>(<span class="pl-e">x</span>, <span class="pl-e">y</span>):
    <span class="pl-k">def</span> <span class="pl-c1">__init__</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>, <span class="pl-smi">value</span>):
        <span class="pl-c1">self</span>.x <span class="pl-k">=</span> value
        <span class="pl-c1">self</span>.y <span class="pl-k">=</span> value


<span class="pl-c1">print</span> Point(<span class="pl-c1">1</span>) <span class="pl-c"><span class="pl-c">#</span> mooo Point(1, 1)</span></pre></div>
<p>You cannot access the replaced <code>__init__</code> method, due to 
fact that it's generated, not inherited. Nevertheless, this provides 
additional flexibility in the case where you really need it.</p>
<p>###Limitations
Case classes provide a lot of functionality to the user, but come with their own set of limitations:</p>
<ul>
<li><strong>No class members</strong>: a consequence of the <a href="#body-initializer">body initializer</a>, you cannot assign class variables in the body of a class via the <code>foo = ...</code> syntax. However, <code>@static</code> and <code>@class</code> methods work fine</li>
<li><strong>Restricted inheritance</strong>: A case class only inherits from <code>macropy.case_classes.CaseClass</code>, as well as any case classes it is lexically scoped within. There is no way to express any other form of inheritance</li>
<li><strong><strong>slots</strong></strong>: case classes get <code>__slots__</code> declarations by default. Thus you cannot assign ad-hoc members which are not defined in the class signature (the <code>class Point(x, y)</code> line).</li>
</ul>
<hr>
<p>Overall, case classes are similar to Python's <a href="http://docs.python.org/2/library/collections.html#collections.namedtuple" rel="nofollow"><code>namedtuple</code></a>,
 but far more flexible (methods, inheritance, etc.), and provides the 
programmer with a much better experience (e.g. no 
arguments-as-space-separated-string definition). Unlike <code>namedtuple</code>s,
 they are flexible enough that they can be used to replace a large 
fraction of user defined classes, rather than being relegated to niche 
uses.</p>
<p>In the cases where you desperately need additional flexibility <a href="#limitations">not afforded</a> by case classes, you can always fall back on normal Python classes and do without the case class functionality.</p>
<h2><a href="#enums" aria-hidden="true" class="anchor" id="user-content-enums"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Enums</h2>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.case_classes <span class="pl-k">import</span> macros, enum

<span class="pl-en">@enum</span>
<span class="pl-k">class</span> <span class="pl-en">Direction</span>:
    North, South, East, West

<span class="pl-c1">print</span> Direction(<span class="pl-v">name</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>North<span class="pl-pds">"</span></span>) <span class="pl-c"><span class="pl-c">#</span> Direction.North</span>

<span class="pl-c1">print</span> Direction.South.name    <span class="pl-c"><span class="pl-c">#</span> South</span>

<span class="pl-c1">print</span> Direction(<span class="pl-v">id</span><span class="pl-k">=</span><span class="pl-c1">2</span>)         <span class="pl-c"><span class="pl-c">#</span> Direction.East</span>

<span class="pl-c1">print</span> Direction.West.id       <span class="pl-c"><span class="pl-c">#</span> 3</span>

<span class="pl-c1">print</span> Direction.North.next    <span class="pl-c"><span class="pl-c">#</span> Direction.South</span>
<span class="pl-c1">print</span> Direction.West.prev     <span class="pl-c"><span class="pl-c">#</span> Direction.East</span>

<span class="pl-c1">print</span> Direction.all
<span class="pl-c"><span class="pl-c">#</span> [Direction.North, Direction.East, Direction.South, Direction.West]</span></pre></div>
<p>MacroPy also provides an implementation of <a href="http://en.wikipedia.org/wiki/Enumerated_type" rel="nofollow">Enumerations</a>, heavily inspired by the <a href="http://docs.oracle.com/javase/tutorial/java/javaOO/enum.html" rel="nofollow">Java implementation</a> and built upon <a href="#case-classes">Case Classes</a>. These are effectively case classes with</p>
<ul>
<li>A fixed set of instances</li>
<li>Auto-generated <code>name</code>, <code>id</code>, <code>next</code> and <code>prev</code> fields</li>
<li>Auto-generated <code>all</code> list, which enumerates all instances.</li>
<li>A <code>__new__</code> method that retrieves an existing instance, rather than creating new ones</li>
</ul>
<p>Note that instances of an Enum cannot be created manually: calls such as <code>Direction(name="North")</code> or <code>Direction(id=2)</code>
 attempt to retrieve an existing Enum with that property, throwing an 
exception if there is none. This means that reference equality is always
 used to compare instances of Enums for equality, allowing for much 
faster equality checks than if you had used <a href="#case-classes">Case Classes</a>.</p>
<p>###Definition of Instances
The instances of an Enum can be declared on a single line, as in the example above, or they can be declared on subsequent lines:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@enum</span>
<span class="pl-k">class</span> <span class="pl-en">Direction</span>:
    North
    South
    East
    West</pre></div>
<p>or in a mix of the two styles:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@enum</span>
<span class="pl-k">class</span> <span class="pl-en">Direction</span>:
    North, South
    East, West</pre></div>
<p>The basic rule here is that the body of an Enum can only contain bare
 names, function calls (show below), tuples of these, or function defs: 
no other statements are allowed. In turn the bare names and function 
calls are turned into instances of the Enum, while function defs (shown 
later) are turned into their methods. This also means that unlike <a href="#case-classes">Case Classes</a>, Enums cannot have <a href="#body-initializer">body initializers</a>.</p>
<p>###Complex Enums</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@enum</span>
<span class="pl-k">class</span> <span class="pl-en">Direction</span>(<span class="pl-e">alignment</span>, <span class="pl-e">continents</span>):
    North(<span class="pl-s"><span class="pl-pds">"</span>Vertical<span class="pl-pds">"</span></span>, [<span class="pl-s"><span class="pl-pds">"</span>Northrend<span class="pl-pds">"</span></span>])
    East(<span class="pl-s"><span class="pl-pds">"</span>Horizontal<span class="pl-pds">"</span></span>, [<span class="pl-s"><span class="pl-pds">"</span>Azeroth<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Khaz Modan<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Lordaeron<span class="pl-pds">"</span></span>])
    South(<span class="pl-s"><span class="pl-pds">"</span>Vertical<span class="pl-pds">"</span></span>, [<span class="pl-s"><span class="pl-pds">"</span>Pandaria<span class="pl-pds">"</span></span>])
    West(<span class="pl-s"><span class="pl-pds">"</span>Horizontal<span class="pl-pds">"</span></span>, [<span class="pl-s"><span class="pl-pds">"</span>Kalimdor<span class="pl-pds">"</span></span>])

    <span class="pl-en">@</span><span class="pl-c1">property</span>
    <span class="pl-k">def</span> <span class="pl-en">opposite</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>):
        <span class="pl-k">return</span> Direction(<span class="pl-v">id</span><span class="pl-k">=</span>(<span class="pl-c1">self</span>.id <span class="pl-k">+</span> <span class="pl-c1">2</span>) <span class="pl-k">%</span> <span class="pl-c1">4</span>)

    <span class="pl-k">def</span> <span class="pl-en">padded_name</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>, <span class="pl-smi">n</span>):
        <span class="pl-k">return</span> (<span class="pl-s"><span class="pl-pds">"</span>&lt;<span class="pl-pds">"</span></span> <span class="pl-k">*</span> n) <span class="pl-k">+</span> <span class="pl-c1">self</span>.name <span class="pl-k">+</span> (<span class="pl-s"><span class="pl-pds">"</span>&gt;<span class="pl-pds">"</span></span> <span class="pl-k">*</span> n)

<span class="pl-c"><span class="pl-c">#</span> members</span>
<span class="pl-c1">print</span> Direction.North.alignment <span class="pl-c"><span class="pl-c">#</span> Vertical</span>
<span class="pl-c1">print</span> Direction.East.continent  <span class="pl-c"><span class="pl-c">#</span> ["Azeroth", "Khaz Modan", "Lordaeron"]</span>

<span class="pl-c"><span class="pl-c">#</span> properties</span>
<span class="pl-c1">print</span> Direction.North.opposite  <span class="pl-c"><span class="pl-c">#</span> Direction.South</span>

<span class="pl-c"><span class="pl-c">#</span> methods</span>
<span class="pl-c1">print</span> Direction.South.padded_name(<span class="pl-c1">2</span>) <span class="pl-c"><span class="pl-c">#</span> &lt;&lt;South&gt;&gt;</span></pre></div>
<p>Enums are not limited to the auto-generated members shown above. 
Apart from the fact that Enums have no constructor, and no body 
initializer, they can contain fields, methods and properties just like <a href="#case-classes">Case Classes</a>
 do. This allows you to associate arbitrary data with each instance of 
the Enum, and have them perform as full-fledged objects rather than 
fancy integers.</p>
<h2><a href="#quick-lambdas" aria-hidden="true" class="anchor" id="user-content-quick-lambdas"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Quick Lambdas</h2>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.quick_lambda <span class="pl-k">import</span> macros, f, _

<span class="pl-c1">print</span> <span class="pl-c1">map</span>(f[_ <span class="pl-k">+</span> <span class="pl-c1">1</span>], [<span class="pl-c1">1</span>, <span class="pl-c1">2</span>, <span class="pl-c1">3</span>])    <span class="pl-c"><span class="pl-c">#</span> [2, 3, 4]</span>
<span class="pl-c1">print</span> <span class="pl-v">reduce</span>(f[_ <span class="pl-k">*</span> _], [<span class="pl-c1">1</span>, <span class="pl-c1">2</span>, <span class="pl-c1">3</span>]) <span class="pl-c"><span class="pl-c">#</span> 6</span></pre></div>
<p>Macropy provides a syntax for lambda expressions similar to Scala's <a href="http://www.codecommit.com/blog/scala/quick-explanation-of-scalas-syntax" rel="nofollow">anonymous functions</a>. Essentially, the transformation is:</p>
<div class="highlight highlight-source-python"><pre>f[_ <span class="pl-k">*</span> _] <span class="pl-ii">-&gt;</span> <span class="pl-k">lambda</span> <span class="pl-smi">a</span>, <span class="pl-smi">b</span>: a <span class="pl-k">*</span> b</pre></div>
<p>where the underscores get replaced by identifiers, which are then set to be the parameters of the enclosing <code>lambda</code>. This works too:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c1">print</span> <span class="pl-c1">map</span>(f[_.split(<span class="pl-s"><span class="pl-pds">'</span> <span class="pl-pds">'</span></span>)[<span class="pl-c1">0</span>]], [<span class="pl-s"><span class="pl-pds">"</span>i am cow<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>hear me moo<span class="pl-pds">"</span></span>])
<span class="pl-c"><span class="pl-c">#</span> ['i', 'hear']</span></pre></div>
<p>Quick Lambdas can be also used as a concise, lightweight, more-readable substitute for <code>functools.partial</code></p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.quick_lambda <span class="pl-k">import</span> macros, f
basetwo <span class="pl-k">=</span> f[<span class="pl-c1">int</span>(_, <span class="pl-v">base</span><span class="pl-k">=</span><span class="pl-c1">2</span>)]
<span class="pl-c1">print</span> basetwo(<span class="pl-s"><span class="pl-pds">'</span>10010<span class="pl-pds">'</span></span>) <span class="pl-c"><span class="pl-c">#</span> 18</span></pre></div>
<p>is equivalent to</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">import</span> functools
basetwo <span class="pl-k">=</span> functools.partial(<span class="pl-c1">int</span>, <span class="pl-v">base</span><span class="pl-k">=</span><span class="pl-c1">2</span>)
<span class="pl-c1">print</span> basetwo(<span class="pl-s"><span class="pl-pds">'</span>10010<span class="pl-pds">'</span></span>) <span class="pl-c"><span class="pl-c">#</span> 18</span></pre></div>
<p>Quick Lambdas can also be used entirely without the <code>_</code> placeholders, in which case they wrap the target in a no argument <code>lambda: ...</code> thunk:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> random <span class="pl-k">import</span> random
thunk <span class="pl-k">=</span> f[random() <span class="pl-k">*</span> <span class="pl-c1">2</span> <span class="pl-k">+</span> <span class="pl-c1">3</span>]
<span class="pl-c1">print</span> thunk() <span class="pl-c"><span class="pl-c">#</span> 4.522011062548173</span>
<span class="pl-c1">print</span> thunk() <span class="pl-c"><span class="pl-c">#</span> 4.894243231792029</span></pre></div>
<p>This cuts out reduces the number of characters needed to make a thunk from 7 (using <code>lambda</code>) to 2, making it much easier to use thunks to do things like emulating <a href="http://locrianmode.blogspot.com/2011/07/scala-by-name-parameter.html" rel="nofollow">by name parameters</a>. The implementation of quicklambda is about <a href="https://github.com/lihaoyi/macropy/blob/master/macropy/quick_lambda.py">30 lines of code</a>, and is worth a look if you want to see how a simple (but extremely useful!) macro can be written.</p>
<h2><a href="#lazy" aria-hidden="true" class="anchor" id="user-content-lazy"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Lazy</h2>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.quick_lambda <span class="pl-k">import</span> macros, lazy

<span class="pl-c"><span class="pl-c">#</span> count how many times expensive_func runs</span>
count <span class="pl-k">=</span> [<span class="pl-c1">0</span>]
<span class="pl-k">def</span> <span class="pl-en">expensive_func</span>():
    count[<span class="pl-c1">0</span>] <span class="pl-k">+=</span> <span class="pl-c1">1</span>

thunk <span class="pl-k">=</span> lazy[expensive_func()]

<span class="pl-c1">print</span> count[<span class="pl-c1">0</span>] <span class="pl-c"><span class="pl-c">#</span> 0</span>

thunk()
<span class="pl-c1">print</span> count[<span class="pl-c1">0</span>] <span class="pl-c"><span class="pl-c">#</span> 1</span>
thunk()
<span class="pl-c1">print</span> count[<span class="pl-c1">0</span>] <span class="pl-c"><span class="pl-c">#</span> 1</span></pre></div>
<p>The <code>lazy</code> macro is used to create a memoizing thunk. Wrapping an expression with <code>lazy</code> creates a thunk which needs to be applied (e.g. <code>thunk()</code>)
 in order to get the value of the expression out. This macro then 
memoizes the result of that expression, such that subsequent calls to <code>thunk()</code> will not cause re-computation.</p>
<p>This macro is a tradeoff between declaring the value as a variable:</p>
<div class="highlight highlight-source-python"><pre>var <span class="pl-k">=</span> expensive_func()</pre></div>
<p>Which evaluates exactly once, even when not used, and declaring it as a function</p>
<div class="highlight highlight-source-python"><pre>thunk <span class="pl-k">=</span> <span class="pl-k">lambda</span>: expensive_func()</pre></div>
<p>Which no longer evaluates when not used, but now re-evaluates every single time. With <code>lazy</code>,
 you get an expression that evaluates 0 or 1 times. This way, you don't 
have to pay the cost of computation if it is not used at all (the 
problems with variables) or the cost of needlessly evaluating it more 
than once (the problem with lambdas).</p>
<p>This is handy to have if you know how to compute an expression in a 
local scope that may be used repeatedly later. It may depend on many 
local variables, for example, which would be inconvenient to pass along 
to the point at which you know whether the computation is necessary. 
This way, you can simply "compute" the lazy value and pass it along, 
just as you would compute the value normally, but with the benefit of 
only-if-necessary evaluation.</p>
<h2><a href="#interned" aria-hidden="true" class="anchor" id="user-content-interned"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Interned</h2>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.quick_lambda <span class="pl-k">import</span> macros, interned

<span class="pl-c"><span class="pl-c">#</span> count how many times expensive_func runs</span>
count <span class="pl-k">=</span> [<span class="pl-c1">0</span>]
<span class="pl-k">def</span> <span class="pl-en">expensive_func</span>():
    count[<span class="pl-c1">0</span>] <span class="pl-k">+=</span> <span class="pl-c1">1</span>

<span class="pl-k">def</span> <span class="pl-en">func</span>():
    <span class="pl-k">return</span> interned[expensive_func()]

<span class="pl-c1">print</span> count[<span class="pl-c1">0</span>] <span class="pl-c"><span class="pl-c">#</span> 0</span>
func()
<span class="pl-c1">print</span> count[<span class="pl-c1">0</span>] <span class="pl-c"><span class="pl-c">#</span> 1</span>
func()
<span class="pl-c1">print</span> count[<span class="pl-c1">0</span>] <span class="pl-c"><span class="pl-c">#</span> 1</span></pre></div>
<p>The <code>interned</code> macro is similar to the <a href="#lazy">Lazy</a> macro in that the code within the <code>interned[...]</code> block is wrapped in a thunk and evaluated at most once. Unlike the <code>lazy</code> macro, however, <code>interned</code> does not created a memoizing thunk that you can pass around your program; instead, the memoization is done on a <em>per-use-site</em> basis.</p>
<p>As you can see in the example above, although <code>func</code> is called repeatedly, the <code>expensive_func()</code> call within the <code>interned</code>
 block is only ever evaluated once. This is handy in that it gives you a
 mechanism for memoizing a particular computation without worrying about
 finding a place to store the memoized values. It's just memoized 
globally (often what you want) while being scoped locally, which avoids 
polluting the global namespace with names only relevant to a single 
function (also often what you want).</p>
<h2><a href="#string-interpolation" aria-hidden="true" class="anchor" id="user-content-string-interpolation"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>String Interpolation</h2>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.string_interp <span class="pl-k">import</span> macros, s

a, b <span class="pl-k">=</span> <span class="pl-c1">1</span>, <span class="pl-c1">2</span>
<span class="pl-c1">print</span> s[<span class="pl-s"><span class="pl-pds">"</span><span class="pl-c1">{a}</span> apple and <span class="pl-c1">{b}</span> bananas<span class="pl-pds">"</span></span>]
<span class="pl-c"><span class="pl-c">#</span> 1 apple and 2 bananas</span></pre></div>
<p>Unlike the normal string interpolation in Python, MacroPy's string 
interpolation allows the programmer to specify the variables to be 
interpolated <em>inline</em> inside the string. The macro <code>s</code> then takes the string literal</p>
<div class="highlight highlight-source-python"><pre><span class="pl-s"><span class="pl-pds">"</span>{a} apple and {b} bananas<span class="pl-pds">"</span></span></pre></div>
<p>and expands it into the expression</p>
<div class="highlight highlight-source-python"><pre><span class="pl-s"><span class="pl-pds">"</span>%s apple and %s bananas<span class="pl-pds">"</span></span> <span class="pl-k">%</span> (a, b)</pre></div>
<p>Which is evaluated at run-time in the local scope, using whatever the values <code>a</code> and <code>b</code> happen to hold at the time. The contents of the <code>{...}</code> can be any arbitrary python expression, and is not limited to variable names:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.string_interp <span class="pl-k">import</span> macros, s
A <span class="pl-k">=</span> <span class="pl-c1">10</span>
B <span class="pl-k">=</span> <span class="pl-c1">5</span>
<span class="pl-c1">print</span> s[<span class="pl-s"><span class="pl-pds">"</span><span class="pl-c1">{A}</span> + <span class="pl-c1">{B}</span> = {A + B}<span class="pl-pds">"</span></span>]
<span class="pl-c"><span class="pl-c">#</span> 10 + 5 = 15</span></pre></div>
<h2><a href="#tracing" aria-hidden="true" class="anchor" id="user-content-tracing"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Tracing</h2>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.tracing <span class="pl-k">import</span> macros, log
log[<span class="pl-c1">1</span> <span class="pl-k">+</span> <span class="pl-c1">2</span>]
<span class="pl-c"><span class="pl-c">#</span> 1 + 2 -&gt; 3</span>
<span class="pl-c"><span class="pl-c">#</span> 3</span>

log[<span class="pl-s"><span class="pl-pds">"</span>omg<span class="pl-pds">"</span></span> <span class="pl-k">*</span> <span class="pl-c1">3</span>]
<span class="pl-c"><span class="pl-c">#</span> ('omg' * 3) -&gt; 'omgomgomg'</span>
<span class="pl-c"><span class="pl-c">#</span> 'omgomgomg'</span></pre></div>
<p>Tracing allows you to easily see what is happening inside your code. Many a time programmers have written code like</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c1">print</span> <span class="pl-s"><span class="pl-pds">"</span>value<span class="pl-pds">"</span></span>, value
<span class="pl-c1">print</span> <span class="pl-s"><span class="pl-pds">"</span>sqrt(x)<span class="pl-pds">"</span></span>, sqrt(x)</pre></div>
<p>and the <code>log()</code> macro (shown above) helps remove this duplication by automatically expanding <code>log(1 + 2)</code> into <code>wrap("(1 + 2)", (1 + 2))</code>. <code>wrap</code> then evaluates the expression, printing out the source code and final value of the computation.</p>
<p>In addition to simple logging, MacroPy provides the <code>trace()</code>
 macro. This macro not only logs the source and result of the given 
expression, but also the source and result of all sub-expressions nested
 within it:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.tracing <span class="pl-k">import</span> macros, trace
trace[[<span class="pl-c1">len</span>(x)<span class="pl-k">*</span><span class="pl-c1">3</span> <span class="pl-k">for</span> x <span class="pl-k">in</span> [<span class="pl-s"><span class="pl-pds">"</span>omg<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>wtf<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>b<span class="pl-pds">"</span></span> <span class="pl-k">*</span> <span class="pl-c1">2</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span>q<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>lo<span class="pl-pds">"</span></span> <span class="pl-k">*</span> <span class="pl-c1">3</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span>l<span class="pl-pds">"</span></span>]]]
<span class="pl-c"><span class="pl-c">#</span> "b" * 2 -&gt; 'bb'</span>
<span class="pl-c"><span class="pl-c">#</span> "b" * 2 + "q" -&gt; 'bbq'</span>
<span class="pl-c"><span class="pl-c">#</span> "lo" * 3 -&gt; 'lololo'</span>
<span class="pl-c"><span class="pl-c">#</span> "lo" * 3 + "l" -&gt; 'lololol'</span>
<span class="pl-c"><span class="pl-c">#</span> ["omg", "wtf", "b" * 2 + "q", "lo" * 3 + "l"] -&gt; ['omg', 'wtf', 'bbq', 'lololol']</span>
<span class="pl-c"><span class="pl-c">#</span> len(x) -&gt; 3</span>
<span class="pl-c"><span class="pl-c">#</span> len(x)*3 -&gt; 9</span>
<span class="pl-c"><span class="pl-c">#</span> len(x) -&gt; 3</span>
<span class="pl-c"><span class="pl-c">#</span> len(x)*3 -&gt; 9</span>
<span class="pl-c"><span class="pl-c">#</span> len(x) -&gt; 3</span>
<span class="pl-c"><span class="pl-c">#</span> len(x)*3 -&gt; 9</span>
<span class="pl-c"><span class="pl-c">#</span> len(x) -&gt; 7</span>
<span class="pl-c"><span class="pl-c">#</span> len(x)*3 -&gt; 21</span>
<span class="pl-c"><span class="pl-c">#</span> [len(x)*3 for x in ["omg", "wtf", "b" * 2 + "q", "lo" * 3 + "l"]] -&gt; [9, 9, 9, 21]</span>
<span class="pl-c"><span class="pl-c">#</span> [9, 9, 9, 21]</span></pre></div>
<p>As you can see, <code>trace</code> logs the source and value of all sub-expressions that get evaluated in the course of evaluating the list comprehension.</p>
<p>Lastly, <code>trace</code> can be used as a block macro:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.tracing <span class="pl-k">import</span> macros, trace
<span class="pl-k">with</span> trace:
    <span class="pl-c1">sum</span> <span class="pl-k">=</span> <span class="pl-c1">0</span>
    <span class="pl-k">for</span> i <span class="pl-k">in</span> <span class="pl-c1">range</span>(<span class="pl-c1">0</span>, <span class="pl-c1">5</span>):
        <span class="pl-c1">sum</span> <span class="pl-k">=</span> <span class="pl-c1">sum</span> <span class="pl-k">+</span> <span class="pl-c1">5</span>

<span class="pl-c"><span class="pl-c">#</span> sum = 0</span>
<span class="pl-c"><span class="pl-c">#</span> for i in range(0, 5):</span>
<span class="pl-c"><span class="pl-c">#</span>     sum = sum + 5</span>
<span class="pl-c"><span class="pl-c">#</span> range(0, 5) -&gt; [0, 1, 2, 3, 4]</span>
<span class="pl-c"><span class="pl-c">#</span> sum = sum + 5</span>
<span class="pl-c"><span class="pl-c">#</span> sum + 5 -&gt; 5</span>
<span class="pl-c"><span class="pl-c">#</span> sum = sum + 5</span>
<span class="pl-c"><span class="pl-c">#</span> sum + 5 -&gt; 10</span>
<span class="pl-c"><span class="pl-c">#</span> sum = sum + 5</span>
<span class="pl-c"><span class="pl-c">#</span> sum + 5 -&gt; 15</span>
<span class="pl-c"><span class="pl-c">#</span> sum = sum + 5</span>
<span class="pl-c"><span class="pl-c">#</span> sum + 5 -&gt; 20</span>
<span class="pl-c"><span class="pl-c">#</span> sum = sum + 5</span>
<span class="pl-c"><span class="pl-c">#</span> sum + 5 -&gt; 25</span></pre></div>
<p>Used this way, <code>trace</code> will print out the source code of every <em>statement</em> that gets executed, in addition to tracing the evaluation of any expressions within those statements.</p>
<p>Apart from simply printing out the traces, you can also redirect the traces wherever you want by having a <code>log()</code> function in scope:</p>
<div class="highlight highlight-source-python"><pre>result <span class="pl-k">=</span> []

<span class="pl-k">def</span> <span class="pl-en">log</span>(<span class="pl-smi">x</span>):
    result.append(x)</pre></div>
<p>The tracer uses whatever <code>log()</code> function it finds, falling back on printing only if none exists. Instead of printing, this <code>log()</code> function appends the traces to a list, and is used in our unit tests.</p>
<p>We think that tracing is an extremely useful macro. For debugging 
what is happening, for teaching newbies how evaluation of expressions 
works, or for a myriad of other purposes, it is a powerful tool. The 
fact that it can be written as a <a href="https://github.com/lihaoyi/macropy/blob/master/macropy/tracing.py">&lt;100 line macro</a> is a bonus.</p>
<p>###Smart Asserts</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.tracing <span class="pl-k">import</span> macros, require
require[<span class="pl-c1">3</span><span class="pl-k">**</span><span class="pl-c1">2</span> <span class="pl-k">+</span> <span class="pl-c1">4</span><span class="pl-k">**</span><span class="pl-c1">2</span> <span class="pl-k">!=</span> <span class="pl-c1">5</span><span class="pl-k">**</span><span class="pl-c1">2</span>]
<span class="pl-c"><span class="pl-c">#</span> Traceback (most recent call last):</span>
<span class="pl-c"><span class="pl-c">#</span>   File "&lt;console&gt;", line 1, in &lt;module&gt;</span>
<span class="pl-c"><span class="pl-c">#</span>   File "macropy.tracing.py", line 67, in handle</span>
<span class="pl-c"><span class="pl-c">#</span>     raise AssertionError("Require Failed\n" + "\n".join(out))</span>
<span class="pl-c"><span class="pl-c">#</span> AssertionError: Require Failed</span>
<span class="pl-c"><span class="pl-c">#</span> 3**2 -&gt; 9</span>
<span class="pl-c"><span class="pl-c">#</span> 4**2 -&gt; 16</span>
<span class="pl-c"><span class="pl-c">#</span> 3**2 + 4**2 -&gt; 25</span>
<span class="pl-c"><span class="pl-c">#</span> 5**2 -&gt; 25</span>
<span class="pl-c"><span class="pl-c">#</span> 3**2 + 4**2 != 5**2 -&gt; False</span></pre></div>
<p>MacroPy provides a variant on the <code>assert</code> keyword called <code>require(</code>. Like <code>assert</code>, <code>require</code> throws an <code>AssertionError</code> if the condition is false.</p>
<p>Unlike <code>assert</code>, <code>require</code> automatically tells 
you what code failed the condition, and traces all the sub-expressions 
within the code so you can more easily see what went wrong. Pretty 
handy!</p>
<p>`require can also be used in block form:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.tracing <span class="pl-k">import</span> macros, require
<span class="pl-k">with</span> require:
    a <span class="pl-k">&gt;</span> <span class="pl-c1">5</span>
    a <span class="pl-k">*</span> b <span class="pl-k">==</span> <span class="pl-c1">20</span>
    a <span class="pl-k">&lt;</span> <span class="pl-c1">2</span>

<span class="pl-c"><span class="pl-c">#</span> Traceback (most recent call last):</span>
<span class="pl-c"><span class="pl-c">#</span>   File "&lt;console&gt;", line 4, in &lt;module&gt;</span>
<span class="pl-c"><span class="pl-c">#</span>   File "macropy.tracing.py", line 67, in handle</span>
<span class="pl-c"><span class="pl-c">#</span>     raise AssertionError("Require Failed\n" + "\n".join(out))</span>
<span class="pl-c"><span class="pl-c">#</span> AssertionError: Require Failed</span>
<span class="pl-c"><span class="pl-c">#</span> a &lt; 2 -&gt; False</span></pre></div>
<p>This requires every statement in the block to be a boolean expression. Each expression will then be wrapped in a <code>require()</code>, throwing an <code>AssertionError</code> with a nice trace when a condition fails.</p>
<p>###<code>show_expanded</code></p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> ast <span class="pl-k">import</span> <span class="pl-k">*</span>
<span class="pl-k">from</span> macropy.core.quotes <span class="pl-k">import</span> macros, q
<span class="pl-k">from</span> macropy.tracing <span class="pl-k">import</span> macros, show_expanded

<span class="pl-c1">print</span> show_expanded[q[<span class="pl-c1">1</span> <span class="pl-k">+</span> <span class="pl-c1">2</span>]]
<span class="pl-c"><span class="pl-c">#</span> BinOp(left=Num(n=1), op=Add(), right=Num(n=2))</span></pre></div>
<p><code>show_expanded</code> is a macro which is similar to the simple <code>log</code> macro shown above, but prints out what the wrapped code looks like <em>after all macros have been expanded</em>.
 This makes it extremely useful for debugging macros, where you need to 
figure out exactly what your code is being expanded into. <code>show_expanded</code> also works in block form:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.core.quotes <span class="pl-k">import</span> macros, q
<span class="pl-k">from</span> macropy.tracing <span class="pl-k">import</span> macros, show_expanded, trace

<span class="pl-k">with</span> show_expanded:
    a <span class="pl-k">=</span> <span class="pl-c1">1</span>
    b <span class="pl-k">=</span> q[<span class="pl-c1">1</span> <span class="pl-k">+</span> <span class="pl-c1">2</span>]
    <span class="pl-k">with</span> q <span class="pl-k">as</span> code:
        <span class="pl-c1">print</span> a

<span class="pl-c"><span class="pl-c">#</span> a = 1</span>
<span class="pl-c"><span class="pl-c">#</span> b = BinOp(left=Num(n=1), op=Add(), right=Num(n=2))</span>
<span class="pl-c"><span class="pl-c">#</span> code = [Print(dest=None, values=[Name(id='a', ctx=Load())], nl=True)]</span></pre></div>
<p>These examples show how the <a href="#quasiquotes">quasiquote</a> 
macro works: it turns an expression or block of code into its AST, 
assigning the AST to a variable at runtime for other code to use.</p>
<p>Here is a less trivial example: <a href="#case-classes">case classes</a> are a pretty useful macro, which saves us the hassle of writing a pile of boilerplate ourselves. By using <code>show_expanded</code>, we can see what the case class definition expands into:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.case_classes <span class="pl-k">import</span> macros, case
<span class="pl-k">from</span> macropy.tracing <span class="pl-k">import</span> macros, show_expanded

<span class="pl-k">with</span> show_expanded:
    <span class="pl-en">@case</span>
    <span class="pl-k">class</span> <span class="pl-en">Point</span>(<span class="pl-e">x</span>, <span class="pl-e">y</span>):
        <span class="pl-k">pass</span>

<span class="pl-c"><span class="pl-c">#</span> class Point(CaseClass):</span>
<span class="pl-c"><span class="pl-c">#</span>     def __init__(self, x, y):</span>
<span class="pl-c"><span class="pl-c">#</span>         self.x = x</span>
<span class="pl-c"><span class="pl-c">#</span>         self.y = y</span>
<span class="pl-c"><span class="pl-c">#</span>         pass</span>
<span class="pl-c"><span class="pl-c">#</span>     _fields = ['x', 'y']</span>
<span class="pl-c"><span class="pl-c">#</span>     _varargs = None</span>
<span class="pl-c"><span class="pl-c">#</span>     _kwargs = None</span>
<span class="pl-c"><span class="pl-c">#</span>     __slots__ = ['x', 'y']</span></pre></div>
<p>Pretty neat!</p>
<hr>
<p>If you want to write your own custom logging, tracing or debugging macros, take a look at the <a href="https://github.com/lihaoyi/macropy/blob/master/macropy/tracing.py">100 lines of code</a> that implements all the functionality shown above.</p>
<h2><a href="#macropeg-parser-combinators" aria-hidden="true" class="anchor" id="user-content-macropeg-parser-combinators"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>MacroPEG Parser Combinators</h2>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.peg <span class="pl-k">import</span> macros, peg
<span class="pl-k">from</span> macropy.quick_lambda <span class="pl-k">import</span> macros, f

<span class="pl-s"><span class="pl-pds">"""</span></span>
<span class="pl-s">PEG grammar from Wikipedia</span>
<span class="pl-s"></span>
<span class="pl-s">Op      &lt;- "+" / "-" / "*" / "/"</span>
<span class="pl-s">Value   &lt;- [0-9]+ / '(' Expr ')'</span>
<span class="pl-s">Expr &lt;- Value (Op Value)*</span>
<span class="pl-s"></span>
<span class="pl-s">Simplified to remove operator precedence</span>
<span class="pl-s"><span class="pl-pds">"""</span></span>
<span class="pl-k">def</span> <span class="pl-en">reduce_chain</span>(<span class="pl-smi">chain</span>):
    chain <span class="pl-k">=</span> <span class="pl-c1">list</span>(<span class="pl-c1">reversed</span>(chain))
    o_dict <span class="pl-k">=</span> {
        <span class="pl-s"><span class="pl-pds">"</span>+<span class="pl-pds">"</span></span>: f[_<span class="pl-k">+</span>_],
        <span class="pl-s"><span class="pl-pds">"</span>-<span class="pl-pds">"</span></span>: f[_<span class="pl-k">-</span>_],
        <span class="pl-s"><span class="pl-pds">"</span>*<span class="pl-pds">"</span></span>: f[_<span class="pl-k">*</span>_],
        <span class="pl-s"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span>: f[_<span class="pl-k">/</span>_],
    }
    <span class="pl-k">while</span> <span class="pl-c1">len</span>(chain) <span class="pl-k">&gt;</span> <span class="pl-c1">1</span>:
        a, [o, b] <span class="pl-k">=</span> chain.pop(), chain.pop()
        chain.append(o_dict[o](a, b))
    <span class="pl-k">return</span> chain[<span class="pl-c1">0</span>]

<span class="pl-k">with</span> peg:
    op <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>+<span class="pl-pds">'</span></span> <span class="pl-k">|</span> <span class="pl-s"><span class="pl-pds">'</span>-<span class="pl-pds">'</span></span> <span class="pl-k">|</span> <span class="pl-s"><span class="pl-pds">'</span>*<span class="pl-pds">'</span></span> <span class="pl-k">|</span> <span class="pl-s"><span class="pl-pds">'</span>/<span class="pl-pds">'</span></span>
    value <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>[0-9]+<span class="pl-pds">'</span></span>.r <span class="pl-k">//</span> <span class="pl-c1">int</span> <span class="pl-k">|</span> (<span class="pl-s"><span class="pl-pds">'</span>(<span class="pl-pds">'</span></span>, expr, <span class="pl-s"><span class="pl-pds">'</span>)<span class="pl-pds">'</span></span>) <span class="pl-k">//</span> f[_[<span class="pl-c1">1</span>]]
    expr <span class="pl-k">=</span> (value, (op, value).rep <span class="pl-k">is</span> rest) <span class="pl-k">&gt;&gt;</span> reduce_chain([value] <span class="pl-k">+</span> rest)

<span class="pl-c1">print</span> expr.parse(<span class="pl-s"><span class="pl-pds">"</span>123<span class="pl-pds">"</span></span>)             <span class="pl-c"><span class="pl-c">#</span> 123</span>
<span class="pl-c1">print</span> expr.parse(<span class="pl-s"><span class="pl-pds">"</span>((123))<span class="pl-pds">"</span></span>)         <span class="pl-c"><span class="pl-c">#</span> 123</span>
<span class="pl-c1">print</span> expr.parse(<span class="pl-s"><span class="pl-pds">"</span>(123+456+789)<span class="pl-pds">"</span></span>)   <span class="pl-c"><span class="pl-c">#</span> 1368</span>
<span class="pl-c1">print</span> expr.parse(<span class="pl-s"><span class="pl-pds">"</span>(6/2)<span class="pl-pds">"</span></span>)           <span class="pl-c"><span class="pl-c">#</span> 3</span>
<span class="pl-c1">print</span> expr.parse(<span class="pl-s"><span class="pl-pds">"</span>(1+2+3)+2<span class="pl-pds">"</span></span>)       <span class="pl-c"><span class="pl-c">#</span> 8</span>
<span class="pl-c1">print</span> expr.parse(<span class="pl-s"><span class="pl-pds">"</span>(((((((11)))))+22+33)*(4+5+((6))))/12*(17+5)<span class="pl-pds">"</span></span>)    <span class="pl-c"><span class="pl-c">#</span> 1804</span></pre></div>
<p>MacroPEG is an implementation of <a href="http://en.wikipedia.org/wiki/Parser_combinator" rel="nofollow">Parser Combinators</a>, an approach to building recursive descent parsers, when the task is too large for <a href="http://en.wikipedia.org/wiki/Regex" rel="nofollow">regexes</a> but yet too small for the heavy-duty <a href="http://en.wikipedia.org/wiki/Comparison_of_parser_generators" rel="nofollow">parser generators</a>. MacroPEG is inspired by Scala's <a href="http://www.suryasuravarapu.com/2011/04/scala-parser-combinators-win.html" rel="nofollow">parser combinator library</a>, utilizing python macros to make the syntax as clean as possible .</p>
<p>The above example describes a simple parser for arithmetic expressions, which roughly follows the <a href="http://en.wikipedia.org/wiki/Parsing_expression_grammar" rel="nofollow">PEG</a>
 syntax. Note how that in the example, the bulk of the code goes into 
the loop that reduces sequences of numbers and operators to a single 
number, rather than the recursive-descent parser itself!</p>
<p>Any assignment (<code>xxx = ...</code>) within a <code>with peg:</code> block is transformed into a <code>Parser</code>. A <code>Parser</code> comes with a <code>.parse(input)</code> method, which returns the parsed result if parsing succeeds and raises a <code>ParseError</code> in the case of failure. The <code>ParseError</code> contains a nice human-readable string detailing exactly what went wrong.</p>
<div class="highlight highlight-source-python"><pre>json_exp.parse(<span class="pl-s"><span class="pl-pds">'</span>{"omg": "123", "wtf": , "bbq": "789"}<span class="pl-pds">'</span></span>)
<span class="pl-c"><span class="pl-c">#</span> ParseError: index: 22, line: 1, col: 23</span>
<span class="pl-c"><span class="pl-c">#</span> json_exp / obj / pair / json_exp</span>
<span class="pl-c"><span class="pl-c">#</span> {"omg": "123", "wtf": , "bbq": "789"}</span>
<span class="pl-c"><span class="pl-c">#</span>                       ^</span>
<span class="pl-c"><span class="pl-c">#</span> expected: (obj | array | string | true | false | null | number)</span></pre></div>
<p>In addition to <code>.parse(input)</code>, a Parser also contains:</p>
<ul>
<li><code>parse_string(input)</code>, a more program-friendly version of <code>parse</code> that returns successes and failures as boxed values (with metadata).</li>
<li>a <code>parse_partial(input)</code> method, which is identical to <code>parse_string</code>, but does not require the entire <code>input</code> to be consumed, as long as some prefix of the <code>input</code> string matches. The <code>remaining</code> attribute of the <code>Success</code> indicates how far into the <code>input</code> string parsing proceeded.</li>
</ul>
<p>###Basic Combinators</p>
<p>Parsers are generally built up from a few common building blocks. The fundamental atoms include:</p>
<ul>
<li>String literals like <code>'+'</code> match the input to their literal value (e.g. '+') and return it as the parse result, or fails if it does not match.</li>
<li>Regexes like <code>'[0-9]+'.r</code> match the regex to the input if possible, and return it.</li>
<li>Tuples like <code>('(', expr, ')')</code> match each of the elements
 within sequentially, and return a list containing the result of each 
element. It fails if any of its elements fails.</li>
<li>Parsers separated by <code>|</code>, for example <code>'+' | '-' | '*' | '/'</code>, attempt to match each of the alternatives from left to right, and return the result of the first success.</li>
<li>Parsers separated by <code>&amp;</code>, for example <code>'[1234]'.r &amp; '[3456]'.r</code>, require both parsers succeed, and return the result of the left side.</li>
<li><code>parser.rep</code> attempts to match the <code>parser</code> 0 or more times, returning a list of the results from each successful match.</li>
<li><code>-parser</code> negates the <code>parser</code>: if <code>parser</code> succeeded (with any result), <code>-parser</code> fails. If <code>parser</code> failed, <code>-parser</code> succeeds with the result <code>""</code>, the empty string.</li>
</ul>
<p>Apart from the fundamental atoms, MacroPeg also provides combinators 
which are not strictly necessary, but are nevertheless generally useful 
in almost all parsing scenarios:</p>
<ul>
<li><code>parser.rep1</code> attempts to match the <code>parser</code> 1 or more times, returning a list of the results from each successful match. If <code>parser</code> does not succeed at least once, <code>parser.rep1</code> fails. Equivalent to <code>parser.rep &amp; parser</code>.</li>
<li><code>parser.rep_with(other)</code> and <code>parser.rep1_with(other)</code> repeat the <code>parser</code> 0 or more or 1 or more times respectively, except now the <code>other</code> parser is invoked in between invocations of <code>parser</code>. The output of <code>other</code> is discarded, and these methods return a list of values similar to <code>rep</code> and <code>rep1</code>.</li>
<li><code>parser * n</code> attempts to match the <code>parser</code> exactly <code>n</code> times, returning a list of length <code>n</code> containing the result of the <code>n</code> successes. Fails otherwise.</li>
<li><code>parser.opt</code> matches the <code>parser</code> 0 or 1 times, returning either <code>[]</code> or <code>[result]</code> where <code>result</code> is the result of <code>parser</code>. Equivalent to <code>parser | Succeed([])</code></li>
<li><code>parser.join</code> takes a parser that returns a list of strings (e.g. tuples, <code>rep</code>, <code>rep1</code>, etc.) and returns a parser which returns the strings concatenated together. Equivalent to <code>parser // "".join</code>.</li>
</ul>
<p>###Transforming values using <code>//</code></p>
<p>So far, these building blocks all return the raw parse tree: all the 
things like whitespace, curly-braces, etc. will still be there. Often, 
you want to take a parser e.g.</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.peg <span class="pl-k">import</span> macros, peg
<span class="pl-k">with</span> peg:
    num <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>[0-9]+<span class="pl-pds">'</span></span>.r

<span class="pl-c1">print</span> <span class="pl-c1">repr</span>(num.parse(<span class="pl-s"><span class="pl-pds">"</span>123<span class="pl-pds">"</span></span>)) <span class="pl-c"><span class="pl-c">#</span> '123'</span></pre></div>
<p>which returns a string of digits, and convert it into a parser which returns an <code>int</code> with the value of that string. This can be done with the <code>//</code> operator:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.peg <span class="pl-k">import</span> macros, peg
<span class="pl-k">with</span> peg:
    num <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>[0-9]+<span class="pl-pds">'</span></span>.r <span class="pl-k">//</span> <span class="pl-c1">int</span>

<span class="pl-c1">print</span> <span class="pl-c1">repr</span>(num.parse(<span class="pl-s"><span class="pl-pds">"</span>123<span class="pl-pds">"</span></span>)) <span class="pl-c"><span class="pl-c">#</span> 123</span></pre></div>
<p>The <code>//</code> operator takes a function which will be used to transform the result of the parser: in this case, it is the function <code>int</code>, which transforms the returned string into an integer.</p>
<p>Another example is:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">with</span> peg:
    laugh <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>lol<span class="pl-pds">'</span></span>
    laughs1 <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>lol<span class="pl-pds">'</span></span>.rep1
    laughs2 <span class="pl-k">=</span> laughs1 <span class="pl-k">//</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>.join

<span class="pl-c1">print</span> laughs1.parse(<span class="pl-s"><span class="pl-pds">"</span>lollollol<span class="pl-pds">"</span></span>) <span class="pl-c"><span class="pl-c">#</span> ['lol', 'lol', 'lol]</span>
<span class="pl-c1">print</span> laughs2.parse(<span class="pl-s"><span class="pl-pds">"</span>lollollol<span class="pl-pds">"</span></span>) <span class="pl-c"><span class="pl-c">#</span> lollollol</span></pre></div>
<p>Where the function <code>"".join"</code> is used to join together the list of results from <code>laughs1</code> into a single string. As mentioned earlier, <code>laughs2</code> can also be written as <code>laughs2 = laughs1.join</code>.</p>
<p>###Binding Values using <code>&gt;&gt;</code></p>
<p>Although <code>//</code> is sufficient for everyone's needs, it is not always convenient. In the example above, a <code>value</code> is defined to be:</p>
<div class="highlight highlight-source-python"><pre>value <span class="pl-k">=</span> <span class="pl-c1">...</span> <span class="pl-k">|</span> (<span class="pl-s"><span class="pl-pds">'</span>(<span class="pl-pds">'</span></span>, expr, <span class="pl-s"><span class="pl-pds">'</span>)<span class="pl-pds">'</span></span>) <span class="pl-k">//</span> (<span class="pl-k">lambda</span> <span class="pl-smi">x</span>: x[<span class="pl-c1">1</span>])</pre></div>
<p>As you can see, we need to strip off the unwanted parentheses from the parse tree, and we do it with a <code>lambda</code> that only selects the middle element, which is the result of the <code>expr</code> parser. An alternate way of representing this is:</p>
<div class="highlight highlight-source-python"><pre>value <span class="pl-k">=</span> <span class="pl-c1">...</span> <span class="pl-k">|</span> (<span class="pl-s"><span class="pl-pds">'</span>(<span class="pl-pds">'</span></span>, expr <span class="pl-k">is</span> result, <span class="pl-s"><span class="pl-pds">'</span>)<span class="pl-pds">'</span></span>) <span class="pl-k">&gt;&gt;</span> result</pre></div>
<p>In this case, the <code>is</code> keyword is used to bind the result of <code>expr</code> to the name <code>result</code>. The <code>&gt;&gt;</code> ("bind") operator can be used to transform the parser by only operating on the <em>bound</em> results within the parser. <code>&gt;&gt;</code> also binds the results of <em>other parsers</em> to their name. Hence the above is equivalent to:</p>
<div class="highlight highlight-source-python"><pre>value <span class="pl-k">=</span> <span class="pl-c1">...</span> <span class="pl-k">|</span> (<span class="pl-s"><span class="pl-pds">'</span>(<span class="pl-pds">'</span></span>, expr, <span class="pl-s"><span class="pl-pds">'</span>)<span class="pl-pds">'</span></span>) <span class="pl-k">&gt;&gt;</span> expr</pre></div>
<p>The <code>expr</code> on the left refers to the parser named <code>expr</code> in the <code>with peg:</code> block, while the <code>expr</code> on the right refers to the <em>results of the parser named <code>expr</code> in case of a successful parse</em>. The parser on the left has to be outside any <code>is</code> expressions for it to be captured as above, and so in this line in the above parser:</p>
<div class="highlight highlight-source-python"><pre>expr <span class="pl-k">=</span> (value, (op, value).rep <span class="pl-k">is</span> rest) <span class="pl-k">&gt;&gt;</span> reduce_chain([value] <span class="pl-k">+</span> rest)</pre></div>
<p>The result of the first <code>value</code> on the left of <code>&gt;&gt;</code> is bound to <code>value</code> on the right, while the second <code>value</code> is not because it is within an <code>is</code> expression bound to the name <code>rest</code>. If you have multiple parsers of the same name on the left of <code>&gt;&gt;</code>, you can always refer to each individual explicitly using the <code>is</code> syntax shown above.</p>
<p>Althought this seems like a lot of shuffling variables around and 
meddling with the local scope and semantics, it goes a long way to keep 
things neat. For example, a JSON parser may define an array to be:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">with</span> peg:
    <span class="pl-c1">...</span>
    <span class="pl-c"><span class="pl-c">#</span> parses an array and extracts the relevant bits into a Python list</span>
     array <span class="pl-k">=</span> (<span class="pl-s"><span class="pl-pds">'</span>[<span class="pl-pds">'</span></span>, (json_exp, (<span class="pl-s"><span class="pl-pds">'</span>,<span class="pl-pds">'</span></span>, json_exp).rep), space.opt, <span class="pl-s"><span class="pl-pds">'</span>]<span class="pl-pds">'</span></span>) <span class="pl-k">//</span> (<span class="pl-k">lambda</span> <span class="pl-smi">x</span>: [x[<span class="pl-c1">1</span>][<span class="pl-c1">0</span>]] <span class="pl-k">+</span> [y[<span class="pl-c1">1</span>] <span class="pl-k">for</span> y <span class="pl-k">in</span> x[<span class="pl-c1">1</span>][<span class="pl-c1">1</span>]])
    <span class="pl-c1">...</span></pre></div>
<p>Where the huge <code>lambda</code> is necessary to pull out the 
necessary parts of the parse tree into a Python list. Although it works,
 it's difficult to write correctly and equally difficult to read. Using 
the <code>is</code> operator, this can be rewritten as:</p>
<div class="highlight highlight-source-python"><pre>array <span class="pl-k">=</span> (<span class="pl-s"><span class="pl-pds">'</span>[<span class="pl-pds">'</span></span>, json_exp <span class="pl-k">is</span> first, (<span class="pl-s"><span class="pl-pds">'</span>,<span class="pl-pds">'</span></span>, json_exp <span class="pl-k">is</span> rest).rep, space.opt, <span class="pl-s"><span class="pl-pds">'</span>]<span class="pl-pds">'</span></span>) <span class="pl-k">&gt;&gt;</span> [first] <span class="pl-k">+</span> rest</pre></div>
<p>Now, it is clear that we are only interested in the result of the two <code>json_exp</code> parsers. The <code>&gt;&gt;</code> operator allows us to use those, while the rest of the parse tree (<code>[</code>s, <code>,</code>s, etc.) are conveniently discarded. Of course, one could go a step further and us the <code>rep_with</code> method which is intended for exactly this purpose:</p>
<div class="highlight highlight-source-python"><pre>array <span class="pl-k">=</span> (<span class="pl-s"><span class="pl-pds">'</span>[<span class="pl-pds">'</span></span>, json_exp.rep_with(<span class="pl-s"><span class="pl-pds">'</span>,<span class="pl-pds">'</span></span>) <span class="pl-k">&gt;&gt;</span> arr, space.opt, <span class="pl-s"><span class="pl-pds">'</span>]<span class="pl-pds">'</span></span>) <span class="pl-k">&gt;&gt;</span> arr</pre></div>
<p>Which arguably looks the cleanest of all!</p>
<p>###Cut</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.peg <span class="pl-k">import</span> macros, peg, cut
<span class="pl-k">with</span> peg:
    expr1 <span class="pl-k">=</span> (<span class="pl-s"><span class="pl-pds">"</span>1<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>2<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>3<span class="pl-pds">"</span></span>) <span class="pl-k">|</span> (<span class="pl-s"><span class="pl-pds">"</span>1<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>b<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>c<span class="pl-pds">"</span></span>)
    expr2 <span class="pl-k">=</span> (<span class="pl-s"><span class="pl-pds">"</span>1<span class="pl-pds">"</span></span>, cut, <span class="pl-s"><span class="pl-pds">"</span>2<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>3<span class="pl-pds">"</span></span>) <span class="pl-k">|</span> (<span class="pl-s"><span class="pl-pds">"</span>1<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>b<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>c<span class="pl-pds">"</span></span>)

<span class="pl-c1">print</span> expr1.parse(<span class="pl-s"><span class="pl-pds">"</span>1bc<span class="pl-pds">"</span></span>) <span class="pl-c"><span class="pl-c">#</span> ['1', 'b', 'c']</span>
<span class="pl-c1">print</span> expr2.parse(<span class="pl-s"><span class="pl-pds">"</span>1bc<span class="pl-pds">"</span></span>)
<span class="pl-c"><span class="pl-c">#</span> ParseError: index: 1, line: 1, col: 2</span>
<span class="pl-c"><span class="pl-c">#</span> expr2</span>
<span class="pl-c"><span class="pl-c">#</span> 1bc</span>
<span class="pl-c"><span class="pl-c">#</span>  ^</span>
<span class="pl-c"><span class="pl-c">#</span> expected: '2'</span></pre></div>
<p><code>cut</code> is a special token used in a sequence of parsers, 
which commits the parsing to the current sequence. As you can see above,
 without <code>cut</code>, the left alternative fails and the parsing then attempts the right alternative, which succeeds. In contrast, with <code>expr2</code>, the parser is committed to the left alternative once it reaches the <code>cut</code> (after successfully parsing "1") and thus when the left alternative fails, the right alternative is not tried and the entire <code>parse</code> fails.</p>
<p>The purpose of <code>cut</code> is two-fold:</p>
<p>####Increasing performance by removing unnecessary backtracking</p>
<p>Using JSON as an example: if your parser sees a <code>{</code>, 
begins parsing a JSON object, but some time later it fails, it does not 
need to both backtracking and attempting to parse an Array (<code>[...</code>), or a String (<code>"...</code>),
 or a Number. None of those could possibly succeed, so cutting the 
backtracking and failing fast prevents this unnecessary computation.</p>
<p>####Better error reporting.</p>
<p>For example, if you try to parse the JSON String;</p>
<div class="highlight highlight-source-js"><pre>{        <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>failed lol<span class="pl-pds">"</span></span>}</pre></div>
<p>if your JSON parser looks like:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">with</span> peg:
    <span class="pl-c1">...</span>
    json_exp <span class="pl-k">=</span> obj <span class="pl-k">|</span> array <span class="pl-k">|</span> string <span class="pl-k">|</span> num <span class="pl-k">|</span> true <span class="pl-k">|</span> false <span class="pl-k">|</span> null
    obj <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>{<span class="pl-pds">'</span></span>, pair.rep_with(<span class="pl-s"><span class="pl-pds">"</span>,<span class="pl-pds">"</span></span>) , space, <span class="pl-s"><span class="pl-pds">'</span>}<span class="pl-pds">'</span></span>
    <span class="pl-c1">...</span></pre></div>
<p>Without <code>cut</code>, the only information you could gain from attempting to parse that is something like:</p>
<pre><code>index: 0, line: 1, col: 1
json_exp
{    : 1, "wtf": 12.4123}
^
expected: (obj | array | string | true | false | null | number)
</code></pre>
<p>On the other hand, using a <code>cut</code> inside the <code>object</code> parser immediately after parsing the first <code>{</code>, we could provide a much more specific error:</p>
<pre><code>index: 5, line: 1, col: 6
json_exp / obj
{    : 1, "wtf": 12.4123}
     ^
expected: '}'
</code></pre>
<p>In the first case, after failing to parse <code>obj</code>, the <code>json_exp</code> parser goes on to try all the other alternatives. After all to them fail to parse, it only knows that trying to parse <code>json_exp</code> starting from character 0 doesn't work; it has no way of knowing that the alternative that was "supposed" to work was <code>obj</code>.</p>
<p>In the second case, <code>cut</code> is inserted inside the <code>object</code> parser, something like:</p>
<div class="highlight highlight-source-python"><pre>obj <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>{<span class="pl-pds">'</span></span>, cut, pair.rep_with(<span class="pl-s"><span class="pl-pds">"</span>,<span class="pl-pds">"</span></span>) , space, <span class="pl-s"><span class="pl-pds">'</span>}<span class="pl-pds">'</span></span></pre></div>
<p>Once the first <code>{</code> is parsed, the parser is committed to that alternative. Thus, when it fails to parse <code>string</code>,
 it knows it cannot backtrack and can immediately end the parsing. It 
can now give a much more specific source location (character 10) as well
 as better information on what it was trying to parse (<code>json / object / string</code>)</p>
<p>###Full Example
MacroPEG is not limited to toy problems, like the arithmetic expression 
parser above. Below is the full source of a JSON parser, provided in the
 <a href="https://github.com/lihaoyi/macropy/blob/master/macropy/experimental/test/peg.py">unit tests</a>:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.peg <span class="pl-k">import</span> macros, peg, cut
<span class="pl-k">from</span> macropy.quick_lambda <span class="pl-k">import</span> macros, f

<span class="pl-k">def</span> <span class="pl-en">decode</span>(<span class="pl-smi">x</span>):
    x <span class="pl-k">=</span> x.decode(<span class="pl-s"><span class="pl-pds">'</span>unicode-escape<span class="pl-pds">'</span></span>)
    <span class="pl-k">try</span>:
        <span class="pl-k">return</span> <span class="pl-c1">str</span>(x)
    <span class="pl-k">except</span>:
        <span class="pl-k">return</span> x

escape_map <span class="pl-k">=</span> {
    <span class="pl-s"><span class="pl-pds">'</span>"<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span>"<span class="pl-pds">'</span></span>,
    <span class="pl-s"><span class="pl-pds">'</span>/<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span>/<span class="pl-pds">'</span></span>,
    <span class="pl-s"><span class="pl-pds">'</span><span class="pl-cce">\\</span><span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span><span class="pl-cce">\\</span><span class="pl-pds">'</span></span>,
    <span class="pl-s"><span class="pl-pds">'</span>b<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span><span class="pl-cce">\b</span><span class="pl-pds">'</span></span>,
    <span class="pl-s"><span class="pl-pds">'</span>f<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span><span class="pl-cce">\f</span><span class="pl-pds">'</span></span>,
    <span class="pl-s"><span class="pl-pds">'</span>n<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span><span class="pl-cce">\n</span><span class="pl-pds">'</span></span>,
    <span class="pl-s"><span class="pl-pds">'</span>r<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span><span class="pl-cce">\r</span><span class="pl-pds">'</span></span>,
    <span class="pl-s"><span class="pl-pds">'</span>t<span class="pl-pds">'</span></span>: <span class="pl-s"><span class="pl-pds">'</span><span class="pl-cce">\t</span><span class="pl-pds">'</span></span>
}

<span class="pl-s"><span class="pl-pds">"""</span></span>
<span class="pl-s">Sample JSON PEG grammar for reference, shameless stolen from</span>
<span class="pl-s">https://github.com/azatoth/PanPG/blob/master/grammars/JSON.peg</span>
<span class="pl-s"></span>
<span class="pl-s">JSON &lt;- S? ( Object / Array / String / True / False / Null / Number ) S?</span>
<span class="pl-s"></span>
<span class="pl-s">Object &lt;- "{"</span>
<span class="pl-s">             ( String ":" JSON ( "," String ":" JSON )*</span>
<span class="pl-s">             / S? )</span>
<span class="pl-s">         "}"</span>
<span class="pl-s"></span>
<span class="pl-s">Array &lt;- "["</span>
<span class="pl-s">            ( JSON ( "," JSON )*</span>
<span class="pl-s">            / S? )</span>
<span class="pl-s">        "]"</span>
<span class="pl-s"></span>
<span class="pl-s">String &lt;- S? ["] ( [^ " \ U+0000-U+001F ] / Escape )* ["] S?</span>
<span class="pl-s"></span>
<span class="pl-s">Escape &lt;- [\] ( [ " / \ b f n r t ] / UnicodeEscape )</span>
<span class="pl-s"></span>
<span class="pl-s">UnicodeEscape &lt;- "u" [0-9A-Fa-f]{4}</span>
<span class="pl-s"></span>
<span class="pl-s">True &lt;- "true"</span>
<span class="pl-s">False &lt;- "false"</span>
<span class="pl-s">Null &lt;- "null"</span>
<span class="pl-s"></span>
<span class="pl-s">Number &lt;- Minus? IntegralPart fractPart? expPart?</span>
<span class="pl-s"></span>
<span class="pl-s">Minus &lt;- "-"</span>
<span class="pl-s">IntegralPart &lt;- "0" / [1-9] [0-9]*</span>
<span class="pl-s">fractPart &lt;- "." [0-9]+</span>
<span class="pl-s">expPart &lt;- ( "e" / "E" ) ( "+" / "-" )? [0-9]+</span>
<span class="pl-s">S &lt;- [ U+0009 U+000A U+000D U+0020 ]+</span>
<span class="pl-s"><span class="pl-pds">"""</span></span>
<span class="pl-k">with</span> peg:
        json_doc <span class="pl-k">=</span> (space, (obj <span class="pl-k">|</span> array), space) <span class="pl-k">//</span> f[_[<span class="pl-c1">1</span>]]
        json_exp <span class="pl-k">=</span> (space, (obj <span class="pl-k">|</span> array <span class="pl-k">|</span> string <span class="pl-k">|</span> true <span class="pl-k">|</span> false <span class="pl-k">|</span> null <span class="pl-k">|</span> number), space) <span class="pl-k">//</span> f[_[<span class="pl-c1">1</span>]]

        pair <span class="pl-k">=</span> (string <span class="pl-k">is</span> k, space, <span class="pl-s"><span class="pl-pds">'</span>:<span class="pl-pds">'</span></span>, cut, json_exp <span class="pl-k">is</span> v) <span class="pl-k">&gt;&gt;</span> (k, v)
        obj <span class="pl-k">=</span> (<span class="pl-s"><span class="pl-pds">'</span>{<span class="pl-pds">'</span></span>, cut, pair.rep_with(<span class="pl-s"><span class="pl-pds">"</span>,<span class="pl-pds">"</span></span>) <span class="pl-k">//</span> <span class="pl-c1">dict</span>, space, <span class="pl-s"><span class="pl-pds">'</span>}<span class="pl-pds">'</span></span>) <span class="pl-k">//</span> f[_[<span class="pl-c1">1</span>]]
        array <span class="pl-k">=</span> (<span class="pl-s"><span class="pl-pds">'</span>[<span class="pl-pds">'</span></span>, cut, json_exp.rep_with(<span class="pl-s"><span class="pl-pds">"</span>,<span class="pl-pds">"</span></span>), space, <span class="pl-s"><span class="pl-pds">'</span>]<span class="pl-pds">'</span></span>) <span class="pl-k">//</span> f[_[<span class="pl-c1">1</span>]]

        string <span class="pl-k">=</span> (space, <span class="pl-s"><span class="pl-pds">'</span>"<span class="pl-pds">'</span></span>, (<span class="pl-sr"><span class="pl-k">r</span><span class="pl-pds">'</span>[<span class="pl-k">^</span><span class="pl-c1">"</span><span class="pl-cce">\\\t\n</span>]<span class="pl-pds">'</span></span>.r <span class="pl-k">|</span> escape <span class="pl-k">|</span> unicode_escape).rep.join <span class="pl-k">is</span> body, <span class="pl-s"><span class="pl-pds">'</span>"<span class="pl-pds">'</span></span>) <span class="pl-k">&gt;&gt;</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>.join(body)
        escape <span class="pl-k">=</span> (<span class="pl-s"><span class="pl-pds">'</span><span class="pl-cce">\\</span><span class="pl-pds">'</span></span>, (<span class="pl-s"><span class="pl-pds">'</span>"<span class="pl-pds">'</span></span> <span class="pl-k">|</span> <span class="pl-s"><span class="pl-pds">'</span>/<span class="pl-pds">'</span></span> <span class="pl-k">|</span> <span class="pl-s"><span class="pl-pds">'</span><span class="pl-cce">\\</span><span class="pl-pds">'</span></span> <span class="pl-k">|</span> <span class="pl-s"><span class="pl-pds">'</span>b<span class="pl-pds">'</span></span> <span class="pl-k">|</span> <span class="pl-s"><span class="pl-pds">'</span>f<span class="pl-pds">'</span></span> <span class="pl-k">|</span> <span class="pl-s"><span class="pl-pds">'</span>n<span class="pl-pds">'</span></span> <span class="pl-k">|</span> <span class="pl-s"><span class="pl-pds">'</span>r<span class="pl-pds">'</span></span> <span class="pl-k">|</span> <span class="pl-s"><span class="pl-pds">'</span>t<span class="pl-pds">'</span></span>) <span class="pl-k">//</span> escape_map.get) <span class="pl-k">//</span> f[_[<span class="pl-c1">1</span>]]
        unicode_escape <span class="pl-k">=</span> (<span class="pl-s"><span class="pl-pds">'</span><span class="pl-cce">\\</span><span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>u<span class="pl-pds">'</span></span>, (<span class="pl-s"><span class="pl-pds">'</span>[0-9A-Fa-f]<span class="pl-pds">'</span></span>.r <span class="pl-k">*</span> <span class="pl-c1">4</span>).join).join <span class="pl-k">//</span> decode

        true <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>true<span class="pl-pds">'</span></span> <span class="pl-k">&gt;&gt;</span> <span class="pl-c1">True</span>
        false <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>false<span class="pl-pds">'</span></span> <span class="pl-k">&gt;&gt;</span> <span class="pl-c1">False</span>
        null <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>null<span class="pl-pds">'</span></span> <span class="pl-k">&gt;&gt;</span> <span class="pl-c1">None</span>

        number <span class="pl-k">=</span> decimal <span class="pl-k">|</span> integer
        integer <span class="pl-k">=</span> (<span class="pl-s"><span class="pl-pds">'</span>-<span class="pl-pds">'</span></span>.opt, integral).join <span class="pl-k">//</span> <span class="pl-c1">int</span>
        decimal <span class="pl-k">=</span> (<span class="pl-s"><span class="pl-pds">'</span>-<span class="pl-pds">'</span></span>.opt, integral, ((fract, exp).join) <span class="pl-k">|</span> fract <span class="pl-k">|</span> exp).join <span class="pl-k">//</span> <span class="pl-c1">float</span>

        integral <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>0<span class="pl-pds">'</span></span> <span class="pl-k">|</span> <span class="pl-s"><span class="pl-pds">'</span>[1-9][0-9]*<span class="pl-pds">'</span></span>.r
        fract <span class="pl-k">=</span> (<span class="pl-s"><span class="pl-pds">'</span>.<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>[0-9]+<span class="pl-pds">'</span></span>.r).join
        exp <span class="pl-k">=</span> ((<span class="pl-s"><span class="pl-pds">'</span>e<span class="pl-pds">'</span></span> <span class="pl-k">|</span> <span class="pl-s"><span class="pl-pds">'</span>E<span class="pl-pds">'</span></span>), (<span class="pl-s"><span class="pl-pds">'</span>+<span class="pl-pds">'</span></span> <span class="pl-k">|</span> <span class="pl-s"><span class="pl-pds">'</span>-<span class="pl-pds">'</span></span>).opt, <span class="pl-s"><span class="pl-pds">"</span>[0-9]+<span class="pl-pds">"</span></span>.r).join

        space <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>\s*<span class="pl-pds">'</span></span>.r</pre></div>
<p>Testing it out with some input, we can see it works as we would expect:</p>
<div class="highlight highlight-source-python"><pre>test_string <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"""</span></span>
<span class="pl-s">    {</span>
<span class="pl-s">        "firstName": "John",</span>
<span class="pl-s">        "lastName": "Smith",</span>
<span class="pl-s">        "age": 25,</span>
<span class="pl-s">        "address": {</span>
<span class="pl-s">            "streetAddress": "21 2nd Street",</span>
<span class="pl-s">            "city": "New York",</span>
<span class="pl-s">            "state": "NY",</span>
<span class="pl-s">            "postalCode": 10021</span>
<span class="pl-s">        },</span>
<span class="pl-s">        "phoneNumbers": [</span>
<span class="pl-s">            {</span>
<span class="pl-s">                "type": "home",</span>
<span class="pl-s">                "number": "212 555-1234"</span>
<span class="pl-s">            },</span>
<span class="pl-s">            {</span>
<span class="pl-s">                "type": "fax",</span>
<span class="pl-s">                "number": "646 555-4567"</span>
<span class="pl-s">            }</span>
<span class="pl-s">        ]</span>
<span class="pl-s">    }</span>
<span class="pl-s"><span class="pl-pds">"""</span></span>

<span class="pl-k">import</span> json
<span class="pl-c1">print</span> json_exp.parse(test_string) <span class="pl-k">==</span> json.loads(test_string)
<span class="pl-c"><span class="pl-c">#</span> True</span>

<span class="pl-k">import</span> pprint
pp <span class="pl-k">=</span> pprint.PrettyPrinter(<span class="pl-c1">4</span>)
pp.pprint(json_exp.parse(test_string))
<span class="pl-c"><span class="pl-c">#</span>{   'address': {   'city': 'New York',</span>
<span class="pl-c"><span class="pl-c">#</span>                   'postalCode': 10021.0,</span>
<span class="pl-c"><span class="pl-c">#</span>                   'state': 'NY',</span>
<span class="pl-c"><span class="pl-c">#</span>                   'streetAddress': '21 2nd Street'},</span>
<span class="pl-c"><span class="pl-c">#</span>    'age': 25.0,</span>
<span class="pl-c"><span class="pl-c">#</span>    'firstName': 'John',</span>
<span class="pl-c"><span class="pl-c">#</span>    'lastName': 'Smith',</span>
<span class="pl-c"><span class="pl-c">#</span>    'phoneNumbers': [   {   'number': '212 555-1234', 'type': 'home'},</span>
<span class="pl-c"><span class="pl-c">#</span>                        {   'number': '646 555-4567', 'type': 'fax'}]}</span></pre></div>
<p>You can see that <code>json_exp</code> parses that non-trivial blob of JSON into an identical structure as Python's in-built <code>json</code>
 package. In addition, the source of the parser looks almost identical 
to the PEG grammar it is parsing, shown above. This parser makes good 
use of the <code>//</code> and <code>&gt;&gt;</code> operators to transform the output of its individual components, as well as using <code>rep_with</code> method to easily parse the comma-separated JSON objects and arrays. This parser is almost fully compliant with the <a href="http://www.json.org/JSON_checker/" rel="nofollow">test cases</a> found on the <a href="https://github.com/lihaoyi/macropy/blob/master/www.json.org">json.org</a> website (it doesn't fail, as it should, for deeply-nested JSON arrays), which isn't bad for 50 lines of code.</p>
<p>As mentioned earlier, MacroPEG parsers also provide exceptions with nice error messages when the <code>parse</code>
 method fails, and the JSON parser is no exception. Even when parsing 
larger documents, the error reporting rises to the challenge:</p>
<div class="highlight highlight-source-python"><pre>json_exp.parse(<span class="pl-s"><span class="pl-pds">"""</span></span>
<span class="pl-s">    {</span>
<span class="pl-s">        "firstName": "John",</span>
<span class="pl-s">        "lastName": "Smith",</span>
<span class="pl-s">        "age": 25,</span>
<span class="pl-s">        "address": {</span>
<span class="pl-s">            "streetAddress": "21 2nd Street",</span>
<span class="pl-s">            "city": "New York",</span>
<span class="pl-s">            "state": "NY",</span>
<span class="pl-s">            "postalCode": 10021</span>
<span class="pl-s">        },</span>
<span class="pl-s">        "phoneNumbers": [</span>
<span class="pl-s">            {</span>
<span class="pl-s">                "type": "home",</span>
<span class="pl-s">                "number": "212 555-1234"</span>
<span class="pl-s">            },</span>
<span class="pl-s">            {</span>
<span class="pl-s">                "type": "fax",</span>
<span class="pl-s">                "number": 646 555-4567"</span>
<span class="pl-s">            }</span>
<span class="pl-s">        ]</span>
<span class="pl-s">    }</span>
<span class="pl-s"><span class="pl-pds">"""</span></span>)

<span class="pl-c"><span class="pl-c">#</span> ParseError: index: 456, line: 19, col: 31</span>
<span class="pl-c"><span class="pl-c">#</span> json_exp / obj / pair / json_exp / array / json_exp / obj</span>
<span class="pl-c"><span class="pl-c">#</span>                 "number": 646 555-4567"</span>
<span class="pl-c"><span class="pl-c">#</span>                               ^</span>
<span class="pl-c"><span class="pl-c">#</span> expected: '}'</span></pre></div>
<p>Pretty neat! This full example of a JSON parser demonstrates what MacroPEG provides to a programmer trying to write a parser:</p>
<ul>
<li>Excellent error reporting</li>
<li>Simple AST processing, on the fly</li>
<li>An extremely clear PEG-like syntax</li>
<li>Extremely concise parser definitions</li>
</ul>
<p>Not bad for an implementation that spans <a href="https://github.com/lihaoyi/macropy/blob/master/macropy/peg.py">350 lines of code</a>!</p>
<h1><a href="#experimental-macros" aria-hidden="true" class="anchor" id="user-content-experimental-macros"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Experimental Macros</h1>
<p>Below are a selection of macros which demonstrate the cooler aspects 
of MacroPy, but are not currently stable or tested enough that we would 
be comfortable using them in production code.</p>
<h2><a href="#pattern-matching" aria-hidden="true" class="anchor" id="user-content-pattern-matching"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Pattern Matching</h2>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.case_classes <span class="pl-k">import</span> macros, case
<span class="pl-k">from</span> macropy.experimental.pattern <span class="pl-k">import</span> macros, switch

<span class="pl-en">@case</span>
<span class="pl-k">class</span> <span class="pl-en">Nil</span>():
    <span class="pl-k">pass</span>

<span class="pl-en">@case</span>
<span class="pl-k">class</span> <span class="pl-en">Cons</span>(<span class="pl-e">x</span>, <span class="pl-e">xs</span>):
    <span class="pl-k">pass</span>

<span class="pl-k">def</span> <span class="pl-v">reduce</span>(<span class="pl-smi">op</span>, <span class="pl-smi">my_list</span>):
    <span class="pl-k">with</span> switch(my_list):
        <span class="pl-k">if</span> Cons(x, Nil()):
            <span class="pl-k">return</span> x
        <span class="pl-k">elif</span> Cons(x, xs):
            <span class="pl-k">return</span> op(x, <span class="pl-v">reduce</span>(op, xs))

<span class="pl-c1">print</span> <span class="pl-v">reduce</span>(<span class="pl-k">lambda</span> <span class="pl-smi">a</span>, <span class="pl-smi">b</span>: a <span class="pl-k">+</span> b, Cons(<span class="pl-c1">1</span>, Cons(<span class="pl-c1">2</span>, Cons(<span class="pl-c1">4</span>, Nil()))))
<span class="pl-c"><span class="pl-c">#</span> 7</span>
<span class="pl-c1">print</span> <span class="pl-v">reduce</span>(<span class="pl-k">lambda</span> <span class="pl-smi">a</span>, <span class="pl-smi">b</span>: a <span class="pl-k">*</span> b, Cons(<span class="pl-c1">1</span>, Cons(<span class="pl-c1">3</span>, Cons(<span class="pl-c1">5</span>, Nil()))))
<span class="pl-c"><span class="pl-c">#</span> 15</span>
<span class="pl-c1">print</span> <span class="pl-v">reduce</span>(Nil(), <span class="pl-k">lambda</span> <span class="pl-smi">a</span>, <span class="pl-smi">b</span>: a <span class="pl-k">*</span> b)
<span class="pl-c"><span class="pl-c">#</span> None</span></pre></div>
<p>Pattern matching allows you to quickly check a variable against a series of possibilities, sort of like a <a href="http://en.wikipedia.org/wiki/Switch_statement" rel="nofollow">switch statement</a> on steroids. Unlike a switch statement in other languages (Java, C++), the <code>switch</code> macro allows you to match against the <em>inside</em> of a pattern: in this case, not just that <code>my_list</code> is a <code>Cons</code> object, but also that the <code>xs</code> member of <code>my_list</code> is a <code>Nil</code>
 object. This can be nested arbitrarily deep, and allows you to easily 
check if a data-structure has a particular "shape" that you are 
expecting. Out of convenience, the value of the leaf nodes in the 
pattern are bound to local variables, so you can immediately use <code>x</code> and <code>xs</code> inside the body of the if-statement without having to extract it (again) from <code>my_list</code>.</p>
<p>The <code>reduce</code> function above (an simple, cons-list specific implementation of <a href="http://docs.python.org/2/library/functions.html#reduce" rel="nofollow">reduce</a>) takes a Cons list (defined using <a href="#case-classes">case classes</a>) and quickly checks if it either a <code>Cons</code> with a <code>Nil</code> right hand side, or a <code>Cons</code> with something else. This is converted (roughly) into:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">def</span> <span class="pl-v">reduce</span>(<span class="pl-smi">my_list</span>, <span class="pl-smi">op</span>):
    <span class="pl-k">if</span> <span class="pl-c1">isinstance</span>(my_list, Cons) <span class="pl-k">and</span> <span class="pl-c1">isinstance</span>(my_list.xs, Nil):
        x <span class="pl-k">=</span> my_list.x
        <span class="pl-k">return</span> x
    <span class="pl-k">elif</span> <span class="pl-c1">isinstance</span>(my_list, Cons):
        x <span class="pl-k">=</span> my_list.x
        xs <span class="pl-k">=</span> my_list.xs
        <span class="pl-k">return</span> op(x, <span class="pl-v">reduce</span>(xs, op))</pre></div>
<p>Which is significantly messier to write, with all the <code>isinstance</code> checks cluttering up the code and having to manually extract the values you need from <code>my_list</code> after the <code>isinstance</code> checks have passed.</p>
<p>Another common use case for pattern matching is working with tree 
structures, like ASTs. This macro is a stylized version of the MacroPy 
code to identify <code>with ...:</code> macros:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">def</span> <span class="pl-en">expand_macros</span>(<span class="pl-smi">node</span>):
    <span class="pl-k">with</span> switch(node):
        <span class="pl-k">if</span> With(Name(name)):
            <span class="pl-k">return</span> handle(name)
        <span class="pl-k">else</span>:
            <span class="pl-k">return</span> node</pre></div>
<p>Compare it to the same code written manually using if-elses:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">def</span> <span class="pl-en">expand_macros</span>(<span class="pl-smi">node</span>):
    <span class="pl-k">if</span> <span class="pl-c1">isinstance</span>(node, With) \
            <span class="pl-k">and</span> <span class="pl-c1">isinstance</span>(node.context_expr, Name) \
            <span class="pl-k">and</span> node.context_expr.id <span class="pl-k">in</span> macros.block_registry:
        name <span class="pl-k">=</span> node.context_expr.id

            <span class="pl-k">return</span> handle(name)
    <span class="pl-k">else</span>:
        <span class="pl-k">return</span> node</pre></div>
<p>As you can see, matching against <code>With(Name(name))</code> is a quick and easy way of checking that the value in <code>node</code> matches a particular shape, and is much less cumbersome than a series of conditionals.</p>
<p>It is also possible to use pattern matching outside of a <code>switch</code>, by using the <code>patterns</code> macro. Within <code>patterns</code>, any left shift (<code>&lt;&lt;</code>)
 statement attempts to match the value on the right to the pattern on 
the left, allowing nested matches and binding variables as described 
earlier.</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.experimental.pattern <span class="pl-k">import</span> macros, patterns
<span class="pl-k">from</span> macropy.case_classes <span class="pl-k">import</span> macros, case

<span class="pl-en">@case</span>
<span class="pl-k">class</span> <span class="pl-en">Rect</span>(<span class="pl-e">p1</span>, <span class="pl-e">p2</span>): <span class="pl-k">pass</span>

<span class="pl-en">@case</span>
<span class="pl-k">class</span> <span class="pl-en">Line</span>(<span class="pl-e">p1</span>, <span class="pl-e">p2</span>): <span class="pl-k">pass</span>

<span class="pl-en">@case</span>
<span class="pl-k">class</span> <span class="pl-en">Point</span>(<span class="pl-e">x</span>, <span class="pl-e">y</span>): <span class="pl-k">pass</span>

<span class="pl-k">def</span> <span class="pl-en">area</span>(<span class="pl-smi">rect</span>):
    <span class="pl-k">with</span> patterns:
        Rect(Point(x1, y1), Point(x2, y2)) <span class="pl-k">&lt;&lt;</span> rect
        <span class="pl-k">return</span> (x2 <span class="pl-k">-</span> x1) <span class="pl-k">*</span> (y2 <span class="pl-k">-</span> y1)

<span class="pl-c1">print</span> area(Rect(Point(<span class="pl-c1">1</span>, <span class="pl-c1">1</span>), Point(<span class="pl-c1">3</span>, <span class="pl-c1">3</span>))) <span class="pl-c"><span class="pl-c">#</span> 4</span></pre></div>
<p>If the match fails, a <code>PatternMatchException</code> will be thrown.</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c1">print</span> area(Line(Point(<span class="pl-c1">1</span>, <span class="pl-c1">1</span>), Point(<span class="pl-c1">3</span>, <span class="pl-c1">3</span>)))
<span class="pl-c"><span class="pl-c">#</span> macropy.macros.pattern.PatternMatchException: Matchee should be of type &lt;class 'scratch.Rect'&gt;</span></pre></div>
<p>###Class Matching Details</p>
<p>When you pattern match <code>Foo(x, y)</code> against a value <code>Foo(3, 4)</code>, what happens behind the
scenes is that the constructor of <code>Foo</code> is inspected.  We may find that it takes
two parameters <code>a</code> and <code>b</code>.  We assume that the constructor then contains lines
like:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c1">self</span>.a <span class="pl-k">=</span> a
<span class="pl-c1">self</span>.b <span class="pl-k">=</span> b</pre></div>
<p>We don't have access to the source of Foo, so this is the best we can do.
Then <code>Foo(x, y) &lt;&lt; Foo(3, 4)</code> is transformed roughly into</p>
<div class="highlight highlight-source-python"><pre>tmp <span class="pl-k">=</span> Foo(<span class="pl-c1">3</span>,<span class="pl-c1">4</span>)
tmp_matcher <span class="pl-k">=</span> ClassMatcher(Foo, [NameMatcher(<span class="pl-s"><span class="pl-pds">'</span>x<span class="pl-pds">'</span></span>), NameMatcher(<span class="pl-s"><span class="pl-pds">'</span>y<span class="pl-pds">'</span></span>)])
tmp_matcher.match(tmp)
x <span class="pl-k">=</span> tmp_matcher.getVar(<span class="pl-s"><span class="pl-pds">'</span>x<span class="pl-pds">'</span></span>)
y <span class="pl-k">=</span> tmp_matcher.getVar(<span class="pl-s"><span class="pl-pds">'</span>y<span class="pl-pds">'</span></span>)</pre></div>
<p>In some cases, constructors will not be so standard.  In this case, we can use
keyword arguments to pattern match against named fields.  For example, an
equivalent to the above which doesn't rely on the specific implementation of th constructor is <code>Foo(a=x, b=y) &lt;&lt; Foo(3, 4)</code>.  Here the semantics are that the field <code>a</code> is extracted from
<code>Foo(3,4)</code> to be matched against the simple pattern <code>x</code>.  We could also replace
<code>x</code> with a more complex pattern, as in <code>Foo(a=Bar(z), b=y) &lt;&lt; Foo(Bar(2), 4)</code>.</p>
<p>###Custom Patterns
It is also possible to completely override the way in which a pattern is matched
by defining an <code>__unapply__</code> class method of the class which you are pattern
matching.  The 'class' need not actually be the type of the matched object, as
in the following example borrowed from Scala.  The <code>__unapply__</code> method takes as
arguments the value being matched, as well as a list of keywords.</p>
<p>The method should then return a tuple of a list of positional matches, and a
dictionary of the keyword matches.</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">class</span> <span class="pl-en">Twice</span>(<span class="pl-c1">object</span>):
    <span class="pl-en">@</span><span class="pl-c1">classmethod</span>
    <span class="pl-k">def</span> <span class="pl-en">__unapply__</span>(<span class="pl-smi">clazz</span>, <span class="pl-smi">x</span>, <span class="pl-smi">kw_keys</span>):
        <span class="pl-k">if</span> <span class="pl-k">not</span> <span class="pl-c1">isinstance</span>(x, <span class="pl-c1">int</span>) <span class="pl-k">or</span> x <span class="pl-k">%</span> <span class="pl-c1">2</span> <span class="pl-k">!=</span> <span class="pl-c1">0</span>:
            <span class="pl-k">raise</span> PatternMatchException()
        <span class="pl-k">else</span>:
            <span class="pl-k">return</span> ([x<span class="pl-k">/</span><span class="pl-c1">2</span>], {})

<span class="pl-k">with</span> patterns:
    Twice(n) <span class="pl-k">&lt;&lt;</span> <span class="pl-c1">8</span>
    <span class="pl-c1">print</span> n     <span class="pl-c"><span class="pl-c">#</span> 4</span></pre></div>
<h2><a href="#tail-call-optimization" aria-hidden="true" class="anchor" id="user-content-tail-call-optimization"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Tail-call Optimization</h2>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.experimental.tco <span class="pl-k">import</span> macros, tco

<span class="pl-en">@tco</span>
<span class="pl-k">def</span> <span class="pl-en">fact</span>(<span class="pl-smi">n</span>, <span class="pl-smi">acc</span><span class="pl-k">=</span><span class="pl-c1">0</span>):
    <span class="pl-k">if</span> n <span class="pl-k">==</span> <span class="pl-c1">0</span>:
        <span class="pl-k">return</span> acc
    <span class="pl-k">else</span>:
        <span class="pl-k">return</span> fact(n<span class="pl-k">-</span><span class="pl-c1">1</span>, n <span class="pl-k">*</span> acc)

<span class="pl-c1">print</span> fact(<span class="pl-c1">10000</span>)  <span class="pl-c"><span class="pl-c">#</span> doesn't stack overflow</span>
<span class="pl-c"><span class="pl-c">#</span> 28462596809170545189064132121198688901...</span></pre></div>
<p><a href="http://en.wikipedia.org/wiki/Tail_call" rel="nofollow">Tail-call Optimization</a>
 is a technique which will optimize away the stack usage of functions 
calls which are in a tail position. Intuitively, if a function <strong>A</strong> calls another function <strong>B</strong>, but does not do any computation after <strong>B</strong> returns (i.e. <strong>A</strong> returns immediately when <strong>B</strong> returns), we don't need to keep around the <a href="http://en.wikipedia.org/wiki/Call_stack" rel="nofollow">stack frame</a> for <strong>A</strong>, which is normally used to store where to resume the computation after <strong>B</strong> returns. By optimizing this, we can prevent really deep tail-recursive functions (like the factorial example above) from <a href="http://en.wikipedia.org/wiki/Stack_overflow" rel="nofollow">overflowing the stack</a>.</p>
<p>The <code>@tco</code> decorator macro doesn't just work with tail-recursive functions, but
also with any generic tail-calls (of either a function or a method) via <a href="#trampolining">trampolining</a>, such this mutually recursive example:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.experimental.tco <span class="pl-k">import</span> macros, tco

<span class="pl-k">class</span> <span class="pl-en">Example</span>(<span class="pl-c1">object</span>):

    <span class="pl-en">@tco</span>
    <span class="pl-k">def</span> <span class="pl-en">odd</span>(<span class="pl-smi">n</span>):
    <span class="pl-k">if</span> n <span class="pl-k">&lt;</span> <span class="pl-c1">0</span>:
        <span class="pl-k">return</span> odd(<span class="pl-k">-</span>n)
    <span class="pl-k">elif</span> n <span class="pl-k">==</span> <span class="pl-c1">0</span>:
        <span class="pl-k">return</span> <span class="pl-c1">False</span>
    <span class="pl-k">else</span>:
        <span class="pl-k">return</span> even(n <span class="pl-k">-</span> <span class="pl-c1">1</span>)

    <span class="pl-en">@tco</span>
    <span class="pl-k">def</span> <span class="pl-en">even</span>(<span class="pl-smi">n</span>):
        <span class="pl-k">if</span> n <span class="pl-k">==</span> <span class="pl-c1">0</span>:
            <span class="pl-k">return</span> <span class="pl-c1">True</span>
        <span class="pl-k">else</span>:
            <span class="pl-k">return</span> odd(n<span class="pl-k">-</span><span class="pl-c1">1</span>)

<span class="pl-c1">print</span> Example().even(<span class="pl-c1">100000</span>)  <span class="pl-c"><span class="pl-c">#</span> No stack overflow</span>
<span class="pl-c"><span class="pl-c">#</span> True</span></pre></div>
<p>Note that both <code>odd</code> and <code>even</code> were both decorated with <code>@tco</code>.  All functions
which would ordinarily use too many stack frames must be decorated.</p>
<p>###Trampolining
How is tail recursion implemented?  The idea is that if a function <code>f</code> would
return the result of a recursive call to some function <code>g</code>, it could instead
return <code>g</code>, along with whatever arguments it would have passed to <code>g</code>.  Then
instead of running <code>f</code> directly, we run <code>trampoline(f)</code>, which will call <code>f</code>,
call the result of <code>f</code>, call the result of that <code>f</code>, etc. until finally some
call returns an actual value.</p>
<p>A transformed (and simplified) version of the tail-call optimized factorial
would look like this</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">def</span> <span class="pl-en">trampoline_decorator</span>(<span class="pl-smi">func</span>):
    <span class="pl-k">def</span> <span class="pl-en">trampolined</span>(<span class="pl-k">*</span><span class="pl-smi">args</span>):
        <span class="pl-k">if</span> <span class="pl-k">not</span> in_trampoline():
            <span class="pl-k">return</span> trampoline(func, args)
        <span class="pl-k">return</span> func(<span class="pl-k">*</span>args)
    <span class="pl-k">return</span> trampolined

<span class="pl-k">def</span> <span class="pl-en">trampoline</span>(<span class="pl-smi">func</span>, <span class="pl-smi">args</span>):
  _enter_trampoline()
  <span class="pl-k">while</span> <span class="pl-c1">True</span>:
        result <span class="pl-k">=</span> func(<span class="pl-k">*</span>args)
        <span class="pl-k">with</span> patterns:
            <span class="pl-k">if</span> (<span class="pl-s"><span class="pl-pds">'</span>macropy-tco-call<span class="pl-pds">'</span></span>, func, args) <span class="pl-k">&lt;&lt;</span> result:
                <span class="pl-k">pass</span>
            <span class="pl-k">else</span>:
                <span class="pl-k">if</span> ignoring:
                    _exit_trampoline()
                    <span class="pl-k">return</span> <span class="pl-c1">None</span>
                <span class="pl-k">else</span>:
                    _exit_trampoline()
                    <span class="pl-k">return</span> result

<span class="pl-en">@trampoline_decorator</span>
<span class="pl-k">def</span> <span class="pl-en">fact</span>(<span class="pl-smi">n</span>, <span class="pl-smi">acc</span>):
    <span class="pl-k">if</span> n <span class="pl-k">==</span> <span class="pl-c1">0</span>:
        <span class="pl-k">return</span> <span class="pl-c1">1</span>
    <span class="pl-k">else</span>:
        <span class="pl-k">return</span> (<span class="pl-s"><span class="pl-pds">'</span>macropy-tco-call<span class="pl-pds">'</span></span>, fact, [n<span class="pl-k">-</span><span class="pl-c1">1</span>, n <span class="pl-k">*</span> acc])</pre></div>
<h2><a href="#pinq-to-sqlalchemy" aria-hidden="true" class="anchor" id="user-content-pinq-to-sqlalchemy"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>PINQ to SQLAlchemy</h2>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.experimental.pinq <span class="pl-k">import</span> macros, sql, query, generate_schema
<span class="pl-k">from</span> sqlalchemy <span class="pl-k">import</span> <span class="pl-k">*</span>

<span class="pl-c"><span class="pl-c">#</span> prepare database</span>
engine <span class="pl-k">=</span> create_engine(<span class="pl-s"><span class="pl-pds">"</span>sqlite://<span class="pl-pds">"</span></span>)
<span class="pl-k">for</span> line <span class="pl-k">in</span> <span class="pl-c1">open</span>(<span class="pl-s"><span class="pl-pds">"</span>macropy/experimental/test/world.sql<span class="pl-pds">"</span></span>).read().split(<span class="pl-s"><span class="pl-pds">"</span>;<span class="pl-pds">"</span></span>):
    engine.execute(line.strip())

db <span class="pl-k">=</span> generate_schema(engine)

<span class="pl-c"><span class="pl-c">#</span> Countries in Europe with a GNP per Capita greater than the UK</span>
results <span class="pl-k">=</span> query[(
    x.name <span class="pl-k">for</span> x <span class="pl-k">in</span> db.country
    <span class="pl-k">if</span> x.gnp <span class="pl-k">/</span> x.population <span class="pl-k">&gt;</span> (
        y.gnp <span class="pl-k">/</span> y.population <span class="pl-k">for</span> y <span class="pl-k">in</span> db.country
        <span class="pl-k">if</span> y.name <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">'</span>United Kingdom<span class="pl-pds">'</span></span>
    ).as_scalar()
    <span class="pl-k">if</span> (x.continent <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">'</span>Europe<span class="pl-pds">'</span></span>)
)]
<span class="pl-k">for</span> line <span class="pl-k">in</span> results: <span class="pl-c1">print</span> line
<span class="pl-c"><span class="pl-c">#</span> (u'Austria',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Belgium',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Switzerland',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Germany',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Denmark',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Finland',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'France',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Iceland',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Liechtenstein',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Luxembourg',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Netherlands',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Norway',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Sweden',)</span></pre></div>
<p>PINQ (Python INtegrated Query) to SQLAlchemy is inspired by <a href="http://msdn.microsoft.com/en-us/library/bb386976.aspx" rel="nofollow">C#'s LINQ to SQL</a>. In short, code used to manipulate lists is lifted into an AST which is then cross-compiled into a snippet of <a href="http://en.wikipedia.org/wiki/SQL" rel="nofollow">SQL</a>. In this case, it is the <code>query</code>
 macro which does this lifting and cross-compilation. Instead of 
performing the manipulation locally on some data structure, the compiled
 query is sent to a remote database to be performed there.</p>
<p>This allows you to write queries to a database in the same way you 
would write queries on in-memory lists, which is really very nice. The 
translation is a relatively thin layer of over the <a href="http://docs.sqlalchemy.org/ru/latest/core/tutorial.html" rel="nofollow">SQLAlchemy Query Language</a>, which does the heavy lifting of converting the query into a raw SQL string:. If we start with a simple query:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> Countries with a land area greater than 10 million square kilometers</span>
<span class="pl-c1">print</span> query[((x.name, x.surface_area) <span class="pl-k">for</span> x <span class="pl-k">in</span> db.country <span class="pl-k">if</span> x.surface_area <span class="pl-k">&gt;</span> <span class="pl-c1">10000000</span>)\
<span class="pl-c"><span class="pl-c">#</span> [(u'Antarctica', Decimal('13120000.0000000000')), (u'Russian Federation', Decimal('17075400.0000000000'))]</span></pre></div>
<p>This is to the equivalent SQLAlchemy query:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c1">print</span> engine.execute(select([country.c.name, country.c.surface_area]).where(country.c.surface_area <span class="pl-k">&gt;</span> <span class="pl-c1">10000000</span>)).fetchall()</pre></div>
<p>To verify that PINQ is actually cross-compiling the python to SQL, 
and not simply requesting everything and performing the manipulation 
locally, we can use the <code>sql</code> macro to perform the lifting of the query without executing it:</p>
<div class="highlight highlight-source-python"><pre>query_string <span class="pl-k">=</span> sql[((x.name, x.surface_area) <span class="pl-k">for</span> x <span class="pl-k">in</span> db.country <span class="pl-k">if</span> x.surface_area <span class="pl-k">&gt;</span> <span class="pl-c1">10000000</span>)]
<span class="pl-c1">print</span> <span class="pl-c1">type</span>(query_string)
<span class="pl-c"><span class="pl-c">#</span> &lt;class 'sqlalchemy.sql.expression.Select'&gt;</span>
<span class="pl-c1">print</span> query_string
<span class="pl-c"><span class="pl-c">#</span> SELECT country_1.name, country_1.surface_area</span>
<span class="pl-c"><span class="pl-c">#</span> FROM country AS country_1</span>
<span class="pl-c"><span class="pl-c">#</span> WHERE country_1.surface_area &gt; ?</span></pre></div>
<p>As we can see, PINQ converts the python list-comprehension into a SQLAlchemy <code>Select</code>, which when stringified becomes a valid SQL string. The <code>?</code>s are there because SQLAlchemy uses <a href="http://en.wikipedia.org/wiki/Prepared_statement" rel="nofollow">parametrized queries</a>, and doesn't interpolate values into the query itself.</p>
<p>Consider a less trivial example: we want to find all countries in europe who have a <a href="http://en.wikipedia.org/wiki/Gross_national_product" rel="nofollow">GNP per Capita</a> greater than the United Kingdom. This is the SQLAlchemy code to do so:</p>
<div class="highlight highlight-source-python"><pre>query <span class="pl-k">=</span> select([db.country.c.name]).where(
    db.country.c.gnp <span class="pl-k">/</span> db.country.c.population <span class="pl-k">&gt;</span> select(
        [(db.country.c.gnp <span class="pl-k">/</span> db.country.c.population)]
    ).where(
            db.country.c.name <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">'</span>United Kingdom<span class="pl-pds">'</span></span>
    ).as_scalar()
).where(
    db.country.c.continent <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">'</span>Europe<span class="pl-pds">'</span></span>
)</pre></div>
<p>The SQLAlchemy query looks pretty odd, for somebody who knows python 
but isn't familiar with the library. This is because SQLAlchemy cannot 
"lift" Python code into an AST to manipulate, and instead have to 
construct the AST manually using python objects. Although it works 
pretty well, the syntax and semantics of the queries is completely 
different from python.</p>
<p>Already we are bumping into edge cases: the <code>db.country</code> in the nested query is referred to the same way as the <code>db.country</code>
 in the outer query, although they are clearly different! One may 
wonder, what if, in the inner query, we wish to refer to the outer 
query's values? Naturally, there will be solutions to all of these 
requirements. In the end, SQLAlchemy ends up effectively creating its 
own mini programming language, with its own concept of scoping, name 
binding, etc., basically duplicating what Python already has but with 
messier syntax and subtly different semantics.</p>
<p>In the equivalent PINQ code, the scoping of which <code>db.country</code> you are referring to is much more explicit, and in general the semantics are identical to a typical python comprehension:</p>
<div class="highlight highlight-source-python"><pre>query <span class="pl-k">=</span> sql[(
    x.name <span class="pl-k">for</span> x <span class="pl-k">in</span> db.country
    <span class="pl-k">if</span> x.gnp <span class="pl-k">/</span> x.population <span class="pl-k">&gt;</span> (
        y.gnp <span class="pl-k">/</span> y.population <span class="pl-k">for</span> y <span class="pl-k">in</span> db.country
        <span class="pl-k">if</span> y.name <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">'</span>United Kingdom<span class="pl-pds">'</span></span>
    ).as_scalar()
    <span class="pl-k">if</span> (x.continent <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">'</span>Europe<span class="pl-pds">'</span></span>)
)]</pre></div>
<p>As we can see, rather than mysteriously referring to the <code>db.country</code> all over the place, we clearly bind it in two places: once to the variable <code>x</code> in the outer query, once to the variable <code>y</code>
 in the inner query. Overall, we make use of Python's syntax and 
semantics (scoping, names, etc.) rather than having to re-invent our 
own, which is a big win for anybody who already understands Python.</p>
<p>Executing either of these will give us the same answer:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c1">print</span> query
<span class="pl-c"><span class="pl-c">#</span> SELECT country_1.name</span>
<span class="pl-c"><span class="pl-c">#</span> FROM country AS country_1</span>
<span class="pl-c"><span class="pl-c">#</span> WHERE country_1.gnp / country_1.population &gt; (SELECT country_2.gnp / country_2.population AS anon_1</span>
<span class="pl-c"><span class="pl-c">#</span> FROM country AS country_2</span>
<span class="pl-c"><span class="pl-c">#</span> WHERE country_2.name = ?) AND country_1.continent = ?</span>

results <span class="pl-k">=</span> engine.execute(query).fetchall()

<span class="pl-k">for</span> line <span class="pl-k">in</span> results: <span class="pl-c1">print</span> line
<span class="pl-c"><span class="pl-c">#</span> (u'Austria',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Belgium',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Switzerland',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Germany',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Denmark',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Finland',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'France',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Iceland',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Liechtenstein',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Luxembourg',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Netherlands',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Norway',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Sweden',)</span></pre></div>
<p>Although PINQ does not support the vast capabilities of the SQL language, it supports a useful subset, like <code>JOIN</code>s:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> The number of cities in all of Asia</span>
query <span class="pl-k">=</span> sql[(
    func.count(t.name)
    <span class="pl-k">for</span> c <span class="pl-k">in</span> db.country
    <span class="pl-k">for</span> t <span class="pl-k">in</span> db.city
    <span class="pl-k">if</span> t.country_code <span class="pl-k">==</span> c.code
    <span class="pl-k">if</span> c.continent <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">'</span>Asia<span class="pl-pds">'</span></span>
)]
<span class="pl-c1">print</span> query
<span class="pl-c"><span class="pl-c">#</span> SELECT count(city_1.name) AS count_1</span>
<span class="pl-c"><span class="pl-c">#</span> FROM city AS city_1, country AS country_1</span>
<span class="pl-c"><span class="pl-c">#</span> WHERE city_1.country_code = country_1.code AND country_1.continent = ?</span>

result <span class="pl-k">=</span> engine.execute(query).fetchall()

<span class="pl-c1">print</span> result
[(<span class="pl-c1">1766</span>,)]</pre></div>
<p>As well as <code>ORDER BY</code>, with <code>LIMIT</code> and <code>OFFSET</code>s:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> The top 10 largest countries in the world by population</span>
query <span class="pl-k">=</span> sql[
    (c.name <span class="pl-k">for</span> c <span class="pl-k">in</span> db.country)
    .order_by(c.population.desc())
    .limit(<span class="pl-c1">10</span>)
]

<span class="pl-c1">print</span> query
<span class="pl-c"><span class="pl-c">#</span> SELECT country_1.name</span>
<span class="pl-c"><span class="pl-c">#</span> FROM country AS country_1</span>
<span class="pl-c"><span class="pl-c">#</span> ORDER BY country_1.population DESC</span>
<span class="pl-c"><span class="pl-c">#</span> LIMIT ? OFFSET ?</span>

res <span class="pl-k">=</span> engine.execute(query).fetchall()
<span class="pl-k">for</span> line <span class="pl-k">in</span> res:
    <span class="pl-c1">print</span> line
<span class="pl-c"><span class="pl-c">#</span> (u'China',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'India',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'United States',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Indonesia',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Brazil',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Pakistan',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Russian Federation',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Bangladesh',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Japan',)</span>
<span class="pl-c"><span class="pl-c">#</span> (u'Nigeria',)</span></pre></div>
<p>In general, apart from the translation of generator expressions (and their guards) into <code>SELECT</code> an <code>WHERE</code> clauses, the rest of the functionality of SQL (like the <code>.order_by()</code>, <code>.limit()</code>, etc. functions shown above) is accessed as in the <a href="http://docs.sqlalchemy.org/ru/latest/core/tutorial.html#ordering-grouping-limiting-offset-ing" rel="nofollow">SQLAlchemy Expression Language</a>. See the <a href="https://github.com/lihaoyi/macropy/blob/master/macropy/experimental/test/pinq.py">unit tests</a> for a fuller set of examples of what PINQ can do, or browse the SQLAlchemy docs mentioned earlier.</p>
<p>PINQ demonstrates how easy it is to use macros to lift python 
snippets into an AST and cross-compile it into another language, and how
 nice the syntax and semantics can be for these embedded DSLs. PINQ's 
entire implementation comprises about <a href="https://github.com/lihaoyi/macropy/blob/master/macropy/experimental/pinq.py">100 lines of code</a>, which really isn't much considering how much it does for you!</p>
<h2><a href="#pyxl-snippets" aria-hidden="true" class="anchor" id="user-content-pyxl-snippets"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Pyxl Snippets</h2>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.experimental.pyxl_strings <span class="pl-k">import</span> macros, p

image_name <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>bolton.png<span class="pl-pds">"</span></span>
image <span class="pl-k">=</span> p[<span class="pl-s"><span class="pl-pds">'</span>&lt;img src="/static/images/<span class="pl-c1">{image_name}</span>" /&gt;<span class="pl-pds">'</span></span>]

text <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>Michael Bolton<span class="pl-pds">"</span></span>
block <span class="pl-k">=</span> p[<span class="pl-s"><span class="pl-pds">'</span>&lt;div&gt;<span class="pl-c1">{image}{text}</span>&lt;/div&gt;<span class="pl-pds">'</span></span>]

element_list <span class="pl-k">=</span> [image, text]
block2 <span class="pl-k">=</span> p[<span class="pl-s"><span class="pl-pds">'</span>&lt;div&gt;<span class="pl-c1">{element_list}</span>&lt;/div&gt;<span class="pl-pds">'</span></span>]

<span class="pl-k">assert</span> block2.to_string() <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">'</span>&lt;div&gt;&lt;img src="/static/images/bolton.png" /&gt;Michael Bolton&lt;/div&gt;<span class="pl-pds">'</span></span></pre></div>
<p><a href="https://github.com/dropbox/pyxl">Pyxl</a> is a way of 
integrating XML markup into your Python code. By default, pyxl hooks 
into the python UTF-8 decoder in order to transform the source files at 
load-time. In this, it is similar to how MacroPy transforms source files
 at import time.</p>
<p>A major difference is that Pyxl by default leaves the HTML fragments directly in the source code:</p>
<div class="highlight highlight-source-python"><pre>image_name <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>bolton.png<span class="pl-pds">"</span></span>
image <span class="pl-k">=</span> <span class="pl-k">&lt;</span>img src<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>/static/images/<span class="pl-c1">{image_name}</span><span class="pl-pds">"</span></span> <span class="pl-k">/</span><span class="pl-k">&gt;</span>

text <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>Michael Bolton<span class="pl-pds">"</span></span>
block <span class="pl-k">=</span> <span class="pl-k">&lt;</span>div<span class="pl-k">&gt;</span>{image}{text}<span class="pl-k">&lt;</span><span class="pl-k">/</span>div<span class="pl-k">&gt;</span>

element_list <span class="pl-k">=</span> [image, text]
block2 <span class="pl-k">=</span> <span class="pl-k">&lt;</span>div<span class="pl-k">&gt;</span>{element_list}<span class="pl-k">&lt;</span><span class="pl-k">/</span>div<span class="pl-k">&gt;</span></pre></div>
<p>While the MacroPy version requires each snippet to be wrapped in a <code>p["..."]</code> wrapper. This <a href="https://github.com/lihaoyi/macropy/blob/master/macropy/experimental/pyxl_strings.py">three-line-of-code macro</a>
 simply uses pyxl as a macro (operating on string literals), rather than
 hooking into the UTF-8 decoder. In general, this demonstrates how easy 
it is to integrate an "external" DSL into your python program: MacroPy 
handles all the intricacies of hooking into the interpreter and 
intercepting the import workflow. The programmer simply needs to provide
 the source-to-source transformation, which in this case was already 
provided.</p>
<h2><a href="#js-snippets" aria-hidden="true" class="anchor" id="user-content-js-snippets"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>JS Snippets</h2>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.experimental.javascript <span class="pl-k">import</span> macros, pyjs

code, javascript <span class="pl-k">=</span> pyjs[<span class="pl-k">lambda</span> <span class="pl-smi">x</span>: x <span class="pl-k">&gt;</span> <span class="pl-c1">5</span> <span class="pl-k">and</span> x <span class="pl-k">%</span> <span class="pl-c1">2</span> <span class="pl-k">==</span> <span class="pl-c1">0</span>]

<span class="pl-c1">print</span> code
<span class="pl-c"><span class="pl-c">#</span> &lt;function &lt;lambda&gt; at 0x0000000003515C18&gt;</span>

<span class="pl-c1">print</span> javascript
<span class="pl-c"><span class="pl-c">#</span> $def(function $_lambda(x) {return $b.bool($b.do_ops(x, '&gt;', 5)) &amp;&amp; $b.bool($b.do_ops($b.mod(x, 2), '==', 0));})</span>

<span class="pl-k">for</span> i <span class="pl-k">in</span> <span class="pl-c1">range</span>(<span class="pl-c1">10</span>):
    <span class="pl-c1">print</span> i, code(i), <span class="pl-c1">self</span>.exec_js_func(javascript, i)

<span class="pl-c"><span class="pl-c">#</span> 0 False False</span>
<span class="pl-c"><span class="pl-c">#</span> 1 False False</span>
<span class="pl-c"><span class="pl-c">#</span> 2 False False</span>
<span class="pl-c"><span class="pl-c">#</span> 3 False False</span>
<span class="pl-c"><span class="pl-c">#</span> 4 False False</span>
<span class="pl-c"><span class="pl-c">#</span> 5 False False</span>
<span class="pl-c"><span class="pl-c">#</span> 6 True True</span>
<span class="pl-c"><span class="pl-c">#</span> 7 False False</span>
<span class="pl-c"><span class="pl-c">#</span> 8 True True</span>
<span class="pl-c"><span class="pl-c">#</span> 9 False False</span></pre></div>
<p>JS Snippets is a macro that allows you to mark out sections of code 
that will be cross-compiled into Javascript at module-import time. This 
cross-compilation is done using <a href="https://github.com/jabapyth/PJs">PJs</a>.
 The generated Javascript is incredibly ugly, thanks in part to the fact
 that in order to preserve semantics in the presence of features that 
Python has but JS lacks (such as <a href="http://en.wikipedia.org/wiki/Operator_overloading" rel="nofollow">operator overloading</a>),
 basically every operation in the Javascript program has to be 
virtualized into a method call. The translation also breaks down around 
the fringes of the Python language.</p>
<p>Nonetheless, as the above example demonstrates, the translation is 
entirely acceptable for simple logic. Furthermore, with macros, marking 
out snippets of Python code to be translated is as simple as prepending 
either:</p>
<ul>
<li><code>js</code>, if you only want to translate the enclosed python expression into Javascript</li>
<li><code>pyjs</code>, if you want both the original expression as well 
as the translated Javascript (as in the example above). This is given to
 you as a tuple.</li>
</ul>
<p><code>pyjs</code> is particularly interesting, because it brings us 
closer to the holy grail of HTML form validation: having validation run 
on both client and server, but still only be expressed once in the code 
base. With <code>pyjs</code>, it is trivial to fork an expression (such 
as the conditional function shown above) into both Python and Javascript
 representations. Rather than using a <a href="https://developer.mozilla.org/en-US/docs/Web/Guide/HTML/Forms/Data_form_validation?redirectlocale=en-US&amp;redirectslug=HTML%2FForms%2FData_form_validation" rel="nofollow">menagerie</a> of <a href="http://docs.jquery.com/Plugins/validation" rel="nofollow">ad-hoc</a> <a href="https://code.google.com/p/validation-js/wiki/MainDocumentation" rel="nofollow">mini-DSLs</a>, this lets you write your validation logic in plain Python.</p>
<p>As mentioned earlier, JS Snippets isn't very robust, and the translation is full of bugs:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> these work</span>
<span class="pl-k">assert</span> <span class="pl-c1">self</span>.exec_js(js[<span class="pl-c1">10</span>]) <span class="pl-k">==</span> <span class="pl-c1">10</span>
<span class="pl-k">assert</span> <span class="pl-c1">self</span>.exec_js(js[<span class="pl-s"><span class="pl-pds">"</span>i am a cow<span class="pl-pds">"</span></span>]) <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">"</span>i am a cow<span class="pl-pds">"</span></span>

<span class="pl-c"><span class="pl-c">#</span> these literals are buggy, and it seems to be PJs' fault</span>
<span class="pl-c"><span class="pl-c">#</span> ??? all the results seem to turn into strings ???</span>
<span class="pl-k">assert</span> <span class="pl-c1">self</span>.exec_js(js(<span class="pl-c1">3.14</span>)) <span class="pl-k">==</span> <span class="pl-c1">3.14</span> <span class="pl-c"><span class="pl-c">#</span> Fails</span>
<span class="pl-k">assert</span> <span class="pl-c1">self</span>.exec_js(js[[<span class="pl-c1">1</span>, <span class="pl-c1">2</span>, <span class="pl-s"><span class="pl-pds">'</span>lol<span class="pl-pds">'</span></span>]]) <span class="pl-k">==</span> [<span class="pl-c1">1</span>, <span class="pl-c1">2</span>, <span class="pl-s"><span class="pl-pds">'</span>lol<span class="pl-pds">'</span></span>] <span class="pl-c"><span class="pl-c">#</span> Fails</span>
<span class="pl-k">assert</span> <span class="pl-c1">self</span>.exec_js(js[{<span class="pl-s"><span class="pl-pds">"</span>moo<span class="pl-pds">"</span></span>: <span class="pl-c1">2</span>, <span class="pl-s"><span class="pl-pds">"</span>cow<span class="pl-pds">"</span></span>: <span class="pl-c1">1</span>}]) <span class="pl-k">==</span> {<span class="pl-s"><span class="pl-pds">"</span>moo<span class="pl-pds">"</span></span>: <span class="pl-c1">2</span>, <span class="pl-s"><span class="pl-pds">"</span>cow<span class="pl-pds">"</span></span>: <span class="pl-c1">1</span>} <span class="pl-c"><span class="pl-c">#</span> Fails</span>

<span class="pl-c"><span class="pl-c">#</span> set literals aren't supported so this throws an exception at macro-expansion time</span>
<span class="pl-c"><span class="pl-c">#</span> self.exec_js(js[{1, 2, 'lol'}])</span></pre></div>
<p>Even as such basic things fail, other, more complex operations work flawlessly:</p>
<div class="highlight highlight-source-python"><pre>script <span class="pl-k">=</span> js[<span class="pl-c1">sum</span>([x <span class="pl-k">for</span> x <span class="pl-k">in</span> <span class="pl-c1">range</span>(<span class="pl-c1">10</span>) <span class="pl-k">if</span> x <span class="pl-k">&gt;</span> <span class="pl-c1">5</span>])]
<span class="pl-c1">print</span> script
<span class="pl-c"><span class="pl-c">#</span> "$b.sum($b.listcomp([$b.range(10)], function (x) {return x;}, [function (x) { return $b.do_ops(x, '&gt;', 5); }]))"</span>
<span class="pl-c1">print</span> <span class="pl-c1">self</span>.exec_js(script)
<span class="pl-c"><span class="pl-c">#</span> 30</span></pre></div>
<p>Here's another, less trivial use case: cross compiling a function that searches for the <a href="http://en.wikipedia.org/wiki/Prime_number" rel="nofollow">prime numbers</a>:</p>
<div class="highlight highlight-source-python"><pre>code, javascript <span class="pl-k">=</span> pyjs[<span class="pl-k">lambda</span> <span class="pl-smi">n</span>: [
    x <span class="pl-k">for</span> x <span class="pl-k">in</span> <span class="pl-c1">range</span>(n)
    <span class="pl-k">if</span> <span class="pl-c1">0</span> <span class="pl-k">==</span> <span class="pl-c1">len</span>([
        y <span class="pl-k">for</span> y <span class="pl-k">in</span> <span class="pl-c1">range</span>(<span class="pl-c1">2</span>, x<span class="pl-k">-</span><span class="pl-c1">2</span>)
        <span class="pl-k">if</span> x <span class="pl-k">%</span> y <span class="pl-k">==</span> <span class="pl-c1">0</span>
    ])
]]
<span class="pl-c1">print</span> code(<span class="pl-c1">20</span>)
<span class="pl-c"><span class="pl-c">#</span> [0, 1, 2, 3, 4, 5, 7, 11, 13, 17, 19]</span>
<span class="pl-c1">print</span> <span class="pl-c1">self</span>.exec_js_func(javascript, <span class="pl-c1">20</span>)
<span class="pl-c"><span class="pl-c">#</span> [0, 1, 2, 3, 4, 5, 7, 11, 13, 17, 19]</span></pre></div>
<p>These examples are all taken from the <a href="https://github.com/lihaoyi/macropy/blob/master/macropy/experimental/test/js_snippets.py">unit tests</a>.</p>
<p>Like <a href="#pinq-to-sqlalchemy">PINQ to SQLAlchemy</a>, JS 
Snippets demonstrates the feasibility, the convenience of being able to 
mark out sections of code using macros, to be cross-compiled into 
another language and run remotely. Unlike PINQ, which is built on top of
 the stable, battle-tested and widely used <a href="http://www.sqlalchemy.org/" rel="nofollow">SQLAlchemy</a>
 library, JS Snippets is built on top of an relatively unknown and 
untested Python to Javascript cross-compiler, making it far from 
production ready.</p>
<p>Nonetheless, JS Snippets demonstrate the promise of being able to 
cross-compile bits of your program and being able to run parts of it 
remotely. The code which performs the integration of PJs and MacroPy is a
 scant <a href="https://github.com/lihaoyi/macropy/blob/master/macropy/experimental/js_snippets.py">25 lines long</a>.
 If a better, more robust Python to Javascript cross-compiler appears 
some day, we could easily make use of it to provide a stable, seamless 
developer experience of sharing code between (web) client and server.</p>
<h1><a href="#tutorials" aria-hidden="true" class="anchor" id="user-content-tutorials"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Tutorials</h1>
<p>This section contains step-by-step guides to get started writing macros using MacroPy:</p>
<ul>
<li><a href="#writing-your-first-macro">Writing your First Macro</a></li>
<li><a href="#making-your-macros-hygienic">Making your Macros Hygienic</a></li>
<li><a href="#exporting-your-expanded-code">Exporting your Expanded Code</a></li>
</ul>
<p>These tutorials proceed through a serious of examples, many of which are available in the <a href="https://github.com/lihaoyi/macropy/blob/master/docs/examples">docs/examples</a> folder.</p>
<h2><a href="#writing-your-first-macro" aria-hidden="true" class="anchor" id="user-content-writing-your-first-macro"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Writing Your First Macro</h2>
<p>Now, we will go through what it takes to write a simple macro, with some <a href="https://github.com/lihaoyi/macropy/blob/master/docs/examples">self-contained examples</a>. To begin, we need three files</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> run.py</span>
<span class="pl-c"><span class="pl-c">#</span> target.py</span>
<span class="pl-c"><span class="pl-c">#</span> macro_module.py</span></pre></div>
<p>As mentioned earlier, you cannot use macros in the <code>__main__</code> module (the file that is run directly via <code>python ...</code>) and so we have to have a separate bootstrap file <code>run.py</code>, which will then execute <code>target.py</code>, which contains macros defined in <code>macro_module.py</code>.</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> run.py</span>
<span class="pl-k">import</span> macropy.activate
<span class="pl-k">import</span> target

<span class="pl-c"><span class="pl-c">#</span> target.py</span>
<span class="pl-c"><span class="pl-c">#</span> macro_module.py</span></pre></div>
<p>Now, let us define a simple macro, in <code>macro_module.py</code></p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> run.py</span>
<span class="pl-k">import</span> macropy.activate
<span class="pl-k">import</span> target

<span class="pl-c"><span class="pl-c">#</span> target.py</span>
<span class="pl-k">from</span> macro_module <span class="pl-k">import</span> macros, expand

<span class="pl-c1">print</span> expand[<span class="pl-c1">1</span> <span class="pl-k">+</span> <span class="pl-c1">2</span>]

<span class="pl-c"><span class="pl-c">#</span> macro_module.py</span>
<span class="pl-k">from</span> macropy.core.macros <span class="pl-k">import</span> <span class="pl-k">*</span>

macros <span class="pl-k">=</span> Macros()

<span class="pl-en">@macros.expr</span>
<span class="pl-k">def</span> <span class="pl-en">expand</span>(<span class="pl-smi">tree</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    <span class="pl-k">return</span> tree</pre></div>
<p>Running this via <code>python run.py</code> will print out <code>3</code>; so far <code>expand</code> is a simple no-op macro which does not do anything to the tree it is passed. This macro is provided in <a href="https://github.com/lihaoyi/macropy/blob/master/docs/examples/nop">docs/examples/nop</a> if you want to try it out yourself; you can run it from the project root via <code>python docs/examples/nop/run.py</code>.</p>
<p>The <code>**kw</code> serves to absorb all the arguments that you did
 not declare. The macro can take additional arguments (not shown here) 
which are documented <a href="#arguments">below</a>. Alternately, you can just take a look at what the <code>**kw</code> dictionary contains.</p>
<p>The line</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macro_module <span class="pl-k">import</span> macros, expand</pre></div>
<p>is necessary to declare what macros you want to use (<code>expand</code>), and which module you want to load them from <code>macro_module</code>. Aliases also work:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macro_module <span class="pl-k">import</span> macros, expand <span class="pl-k">as</span> my_alias

<span class="pl-c1">print</span> my_alias[<span class="pl-c1">1</span> <span class="pl-k">+</span> <span class="pl-c1">2</span>]</pre></div>
<p>As you would expect. Import-alls like <code>from macro_module import *</code> do <strong>not</strong> work.</p>
<p>At this point, you can print out the tree you are receiving in various forms just to see what you're getting:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> macro_module.py</span>
<span class="pl-k">from</span> macropy.core.macros <span class="pl-k">import</span> <span class="pl-k">*</span>

macros <span class="pl-k">=</span> Macros()

<span class="pl-en">@macros.expr</span>
<span class="pl-k">def</span> <span class="pl-en">expand</span>(<span class="pl-smi">tree</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    <span class="pl-c1">print</span> tree
    <span class="pl-c1">print</span> real_repr(tree)
    <span class="pl-c1">print</span> unparse(tree)
    <span class="pl-k">return</span> tree</pre></div>
<p>When you run <code>run.py</code>, This will print:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">&lt;</span>_ast.BinOp <span class="pl-c1">object</span> at <span class="pl-c1"><span class="pl-k">0x</span>000000000206BBA8</span><span class="pl-k">&gt;</span>
BinOp(Num(<span class="pl-c1">1</span>), Add(), Num(<span class="pl-c1">2</span>))
(<span class="pl-c1">1</span> <span class="pl-k">+</span> <span class="pl-c1">2</span>)
<span class="pl-c1">3</span></pre></div>
<p>As you can see, the AST objects don't have a nice <code>__repr__</code>, but if you use the MacroPy function <code>real_repr</code>, you can see that it's made up of the  <code>BinOp</code> <code>Add</code>, which adds the two numbers <code>Num(1)</code> and <code>Num(2)</code>. Unparsing it into source code via <code>unparse()</code> gives you <code>(1 + 2)</code>,
 which is what you would expect. In general, unparsing may not give you 
exactly the original source, but it should be semantically equivalent 
when executed. Take a look at the <a href="#data-model">data model</a> to see what other useful conversions are available.</p>
<p>One (trivial) example of modifying the tree is to simply replace it with a new tree, for example:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> macro_module.py</span>
<span class="pl-k">from</span> macropy.core.macros <span class="pl-k">import</span> <span class="pl-k">*</span>

macros <span class="pl-k">=</span> Macros()

<span class="pl-en">@macros.expr</span>
<span class="pl-k">def</span> <span class="pl-en">expand</span>(<span class="pl-smi">tree</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    <span class="pl-k">return</span> Num(<span class="pl-c1">100</span>)</pre></div>
<p>When you run <code>run.py</code>, this will print out <code>100</code>, as the original expression <code>(1 + 2)</code> has now been replaced by the literal <code>100</code>. Another possible operation would be to replace the expression with the square of itself:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> macro_module.py</span>
<span class="pl-k">from</span> macropy.core.macros <span class="pl-k">import</span> <span class="pl-k">*</span>

macros <span class="pl-k">=</span> Macros()

<span class="pl-en">@macros.expr</span>
<span class="pl-k">def</span> <span class="pl-en">expand</span>(<span class="pl-smi">tree</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    newtree <span class="pl-k">=</span> BinOp(tree, Mult(), tree)
    <span class="pl-k">return</span> newtree</pre></div>
<p>This will replace the expression <code>(1 + 2)</code> with <code>((1 + 2) * (1 + 2))</code>; you can similarly print out newtree via <code>unparse</code> or <code>real_repr</code> to see what's it looks like.</p>
<p>###Using Quasiquotes</p>
<p>Building up the new tree manually, as shown above, works reasonably 
well. However, it can quickly get unwieldy, particularly for more 
complex expressions. For example, let's say we wanted to make <code>expand</code> wrap the expression <code>(1 + 2)</code> in a lambda, like <code>lambda x: x * (1 + 2) + 10</code>. Ignore, for the moment, that this transform is not very useful. Doing so manually is quite a pain:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> macro_module.py</span>
<span class="pl-k">from</span> macropy.core.macros <span class="pl-k">import</span> <span class="pl-k">*</span>

macros <span class="pl-k">=</span> Macros()

<span class="pl-en">@macros.expr</span>
<span class="pl-k">def</span> <span class="pl-en">expand</span>(<span class="pl-smi">tree</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    <span class="pl-k">return</span> Lambda(arguments([Name(<span class="pl-s"><span class="pl-pds">"</span>x<span class="pl-pds">"</span></span>, Param())], <span class="pl-c1">None</span>, <span class="pl-c1">None</span>, []), BinOp(BinOp(Name(<span class="pl-s"><span class="pl-pds">'</span>x<span class="pl-pds">'</span></span>, Load()), Mult(), tree), Add(), Num(<span class="pl-c1">10</span>)))</pre></div>
<p>This works, and when you run <code>run.py</code> it prints out:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">&lt;</span>function <span class="pl-k">&lt;</span><span class="pl-k">lambda</span>&gt; at 0x00000000020A3588&gt;</pre></div>
<p>Because now <code>target.py</code> is printing out a lambda function. If we modify <code>target.py</code> to call the expanded <code>lambda</code> with an argument:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> target.py</span>
<span class="pl-k">from</span> macro_module <span class="pl-k">import</span> macros, expand

func <span class="pl-k">=</span> expand[<span class="pl-c1">1</span> <span class="pl-k">+</span> <span class="pl-c1">2</span>]
<span class="pl-c1">print</span> func(<span class="pl-c1">5</span>)</pre></div>
<p>It prints <code>25</code>, as you would expect.</p>
<p><a href="#quasiquotes">Quasiquotes</a> are a special structure that 
lets you quote sections of code as ASTs, letting us substitute in 
sections dynamically. Quasiquotes let us turn the above code into:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> macro_module.py</span>
<span class="pl-k">from</span> macropy.core.macros <span class="pl-k">import</span> <span class="pl-k">*</span>
<span class="pl-k">from</span> macropy.core.quotes <span class="pl-k">import</span> macros, q, ast

macros <span class="pl-k">=</span> Macros()

<span class="pl-en">@macros.expr</span>
<span class="pl-k">def</span> <span class="pl-en">expand</span>(<span class="pl-smi">tree</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    <span class="pl-k">return</span> q[<span class="pl-k">lambda</span> <span class="pl-smi">x</span>: x <span class="pl-k">*</span> ast[tree] <span class="pl-k">+</span> <span class="pl-c1">10</span>]</pre></div>
<p>the <code>q[...]</code> syntax means that the section following it is quoted as an AST, while the unquote <code>ast[...]</code> syntax means to place the <em>value</em> of <code>tree</code> into that part of the quoted AST, rather than simply the node <code>Name("tree")</code>. Running <code>run.py</code>, this also prints <code>25</code>. See <a href="https://github.com/lihaoyi/macropy/blob/master/docs/examples/quasiquote">docs/examples/quasiquote</a> for the self-contained code for this example.</p>
<p>Another unquote <code>u</code> allow us to dynamically include the value <code>10</code> in the AST at run time:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> macro_module.py</span>
<span class="pl-k">from</span> macropy.core.macros <span class="pl-k">import</span> <span class="pl-k">*</span>
<span class="pl-k">from</span> macropy.core.quotes <span class="pl-k">import</span> macros, q, ast, u

macros <span class="pl-k">=</span> Macros()

<span class="pl-en">@macros.expr</span>
<span class="pl-k">def</span> <span class="pl-en">expand</span>(<span class="pl-smi">tree</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    addition <span class="pl-k">=</span> <span class="pl-c1">10</span>
    <span class="pl-k">return</span> q[<span class="pl-k">lambda</span> <span class="pl-smi">x</span>: x <span class="pl-k">*</span> ast[tree] <span class="pl-k">+</span> u[addition]]</pre></div>
<p>This will insert the a literal representing the value of <code>addition</code> into the position of the <code>u[addition]</code>, in this case <code>10</code>. This <em>also</em>
 prints 25. For a more detailed description of how quoting and unquoting
 works, and what more you can do with it, check out the documentation 
for <a href="#quasiquotes">Quaasiquotes</a>.</p>
<p>Apart from using the <code>u</code> and <code>ast</code> unquotes to put things into the AST, good old fashioned assignment works too:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> macro_module.py</span>
<span class="pl-k">from</span> macropy.core.macros <span class="pl-k">import</span> <span class="pl-k">*</span>
<span class="pl-k">from</span> macropy.core.quotes <span class="pl-k">import</span> macros, q

macros <span class="pl-k">=</span> Macros()

<span class="pl-en">@macros.expr</span>
<span class="pl-k">def</span> <span class="pl-en">expand</span>(<span class="pl-smi">tree</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    newtree <span class="pl-k">=</span> q[<span class="pl-k">lambda</span> <span class="pl-smi">x</span>: x <span class="pl-k">*</span> <span class="pl-c1">None</span> <span class="pl-k">+</span> <span class="pl-c1">10</span>]
    newtree.body.left.right <span class="pl-k">=</span> tree          <span class="pl-c"><span class="pl-c">#</span> replace the None in the AST with the given tree</span>
    <span class="pl-k">return</span> newtree</pre></div>
<p>If you run this, it will also print <code>25</code>.</p>
<p>###Walking the AST</p>
<p>Quasiquotes make it much easier for you to manipulate sections of 
code, allowing you to quickly put together snippets that look however 
you want. However, they do not provide any support for a very common use
 case: that of recursively traversing the AST and replacing sections of 
it at a time.</p>
<p>Now that you know how to make basic macros, I will walk you through 
the implementation of a less trivial (and extremely useful!) macro: <a href="#quick-lambdas">quicklambda</a>.</p>
<p>If we look at what <a href="#quick-lambdas">quicklambda</a> does, we see want to take code which looks like this:</p>
<div class="highlight highlight-source-python"><pre>f[_ <span class="pl-k">+</span> (<span class="pl-c1">1</span> <span class="pl-k">*</span> _)]</pre></div>
<p>and turn it into:</p>
<div class="highlight highlight-source-python"><pre>(arg0 <span class="pl-k">+</span> (<span class="pl-c1">1</span> <span class="pl-k">*</span> arg1))</pre></div>
<p>and wrap it in a lambda to give:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">lambda</span> <span class="pl-smi">arg0</span>, <span class="pl-smi">arg1</span>: (arg0 <span class="pl-k">+</span> (<span class="pl-c1">1</span> <span class="pl-k">*</span> arg1))</pre></div>
<p>Let's accomplish the first transform first: we need to replace all the <code>_</code>s with variables <code>arg0</code>, <code>arg1</code>, etc.. To do this, we need to recurse over the AST in order to search for the uses of <code>_</code>. A simple attempt may be:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> macro_module.py</span>

<span class="pl-k">from</span> macropy.core.macros <span class="pl-k">import</span> <span class="pl-k">*</span>

macros <span class="pl-k">=</span> Macros()

<span class="pl-en">@macros.expr</span>
<span class="pl-k">def</span> <span class="pl-en">f</span>(<span class="pl-smi">tree</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    names <span class="pl-k">=</span> (<span class="pl-s"><span class="pl-pds">'</span>arg<span class="pl-pds">'</span></span> <span class="pl-k">+</span> <span class="pl-c1">str</span>(i) <span class="pl-k">for</span> i <span class="pl-k">in</span> <span class="pl-v">xrange</span>(<span class="pl-c1">100</span>))

    <span class="pl-k">def</span> <span class="pl-en">rec</span>(<span class="pl-smi">tree</span>):
        <span class="pl-k">if</span> <span class="pl-c1">type</span>(tree) <span class="pl-k">is</span> Name <span class="pl-k">and</span> tree.id <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">'</span>_<span class="pl-pds">'</span></span>:
            tree.id <span class="pl-k">=</span> names.next()
        <span class="pl-k">if</span> <span class="pl-c1">type</span>(tree) <span class="pl-k">is</span> BinOp:
            rec(tree.left)
            rec(tree.right)
        <span class="pl-k">if</span> <span class="pl-c1">type</span>(tree) <span class="pl-k">is</span> List:
            <span class="pl-c1">map</span>(rec, tree.elts)
        <span class="pl-k">if</span> <span class="pl-c1">type</span>(tree) <span class="pl-k">is</span> UnaryOp:
            rec(tree.operand)
        <span class="pl-k">if</span> <span class="pl-c1">type</span>(tree) <span class="pl-k">is</span> BoolOp:
            <span class="pl-c1">map</span>(rec, tree.values)
        <span class="pl-c1">...</span>

    newtree <span class="pl-k">=</span> rec(tree)
    <span class="pl-k">return</span> newtree</pre></div>
<p>Note that we use <code>f</code> instead of <code>expand</code>. Also 
note that writing out the recursion manually is pretty tricky, there are
 a ton of cases to consider, and it's easy to get wrong. It turns out 
that this behavior, of walking over the AST and doing something to it, 
is an extremely common operation, common enough that MacroPy provides 
the <code>Walker</code> class to do this for you:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> macro_module.py</span>
<span class="pl-k">from</span> macropy.core.macros <span class="pl-k">import</span> <span class="pl-k">*</span>

macros <span class="pl-k">=</span> Macros()

<span class="pl-en">@macros.expr</span>
<span class="pl-k">def</span> <span class="pl-en">f</span>(<span class="pl-smi">tree</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    names <span class="pl-k">=</span> (<span class="pl-s"><span class="pl-pds">'</span>arg<span class="pl-pds">'</span></span> <span class="pl-k">+</span> <span class="pl-c1">str</span>(i) <span class="pl-k">for</span> i <span class="pl-k">in</span> <span class="pl-v">xrange</span>(<span class="pl-c1">100</span>))

    <span class="pl-en">@Walker</span>
    <span class="pl-k">def</span> <span class="pl-en">underscore_search</span>(<span class="pl-smi">tree</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
        <span class="pl-k">if</span> <span class="pl-c1">type</span>(tree) <span class="pl-k">is</span> Name <span class="pl-k">and</span> tree.id <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">'</span>_<span class="pl-pds">'</span></span>:
            tree.id <span class="pl-k">=</span> names.next()

    newtree <span class="pl-k">=</span> underscore_search.recurse(tree)
    <span class="pl-c1">print</span> unparse(newtree) <span class="pl-c"><span class="pl-c">#</span> (arg0 + (1 * arg1))</span>
    <span class="pl-k">return</span> newtree</pre></div>
<p>This snippet of code is equivalent to the one earlier, except that with a <a href="#walkers">Walker</a>, you only need to specify the AST nodes you are interested in (in this case <code>Name</code>s)
 and the Walker will do the recursion automatically. As you can see, 
when we print out the unparsed newtree, we can see that the transformed 
code looks like what we expect. You could also use the <a href="#show_expanded">show_expanded</a> macro in <code>target.py</code> to see what it looks like:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> target.py</span>
<span class="pl-k">from</span> macro_module <span class="pl-k">import</span> macros, f
<span class="pl-k">from</span> macropy.tracing <span class="pl-k">import</span> macros, show_expanded

<span class="pl-k">with</span> show_expanded:
    my_func <span class="pl-k">=</span> f[_ <span class="pl-k">+</span> (<span class="pl-c1">1</span> <span class="pl-k">*</span> _)]
<span class="pl-c"><span class="pl-c">#</span> my_func = (arg0 + (1 * arg1))</span></pre></div>
<p>Verifying that the code indeed is what we expect.</p>
<p>When run, this code then fails with a</p>
<pre><code>NameError: name 'arg0' is not defined
</code></pre>
<p>At runtime, because the names we put into the tree (<code>arg0</code> and <code>arg1</code>) haven't actually been defined in <code>target.py</code>! We will see how we can fix that.</p>
<p>###More Walking</p>
<p>The function being passed to the Walker can return a variety of 
things. In this case, let's say we want to collect the names we 
extracted from the <code>names</code> generator, so we can use them to populate the arguments of the <code>lambda</code>.</p>
<p>The Walker function request the <code>collect</code> argument, and call <code>collect(item)</code> to have the <code>Walker</code> aggregate them all in one large list which you can extract by using <code>recurse_collect</code> instead of <code>recurse</code>:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.core.macros <span class="pl-k">import</span> <span class="pl-k">*</span>
<span class="pl-k">from</span> macropy.core.quotes <span class="pl-k">import</span> macros, q, u

macros <span class="pl-k">=</span> Macros()

<span class="pl-en">@macros.expr</span>
<span class="pl-k">def</span> <span class="pl-en">f</span>(<span class="pl-smi">tree</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    names <span class="pl-k">=</span> (<span class="pl-s"><span class="pl-pds">'</span>arg<span class="pl-pds">'</span></span> <span class="pl-k">+</span> <span class="pl-c1">str</span>(i) <span class="pl-k">for</span> i <span class="pl-k">in</span> <span class="pl-v">xrange</span>(<span class="pl-c1">100</span>))

    <span class="pl-en">@Walker</span>
    <span class="pl-k">def</span> <span class="pl-en">underscore_search</span>(<span class="pl-smi">tree</span>, <span class="pl-smi">collect</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
        <span class="pl-k">if</span> <span class="pl-c1">isinstance</span>(tree, Name) <span class="pl-k">and</span> tree.id <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">"</span>_<span class="pl-pds">"</span></span>:
            name <span class="pl-k">=</span> names.next()
            tree.id <span class="pl-k">=</span> name
            collect(name)
            <span class="pl-k">return</span> tree

    new_tree, used_names <span class="pl-k">=</span> underscore_search.recurse_collect(tree)
    <span class="pl-c1">print</span> used_names <span class="pl-c"><span class="pl-c">#</span> ['arg0', 'arg1']</span>
    <span class="pl-k">return</span> new_tree</pre></div>
<p>Now we have available both the <code>new_tree</code> as well as a list of <code>used_names</code>. When we print out <code>used_names</code>,
 we see it is the names that got substituted in place of the underscores
 within the AST. If you're wondering what other useful things are hiding
 in the <code>**kw</code>, check out the section on <a href="#walkers">Walkers</a>.</p>
<p>This still fails at runtime, but now all we need now is to wrap everything in a <code>lambda</code>, set the arguments properly:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.core.macros <span class="pl-k">import</span> <span class="pl-k">*</span>
<span class="pl-k">from</span> macropy.core.quotes <span class="pl-k">import</span> macros, q, u

_ <span class="pl-k">=</span> <span class="pl-c1">None</span>  <span class="pl-c"><span class="pl-c">#</span> makes IDE happy</span>

macros <span class="pl-k">=</span> Macros()

<span class="pl-en">@macros.expr</span>
<span class="pl-k">def</span> <span class="pl-en">f</span>(<span class="pl-smi">tree</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    names <span class="pl-k">=</span> (<span class="pl-s"><span class="pl-pds">'</span>arg<span class="pl-pds">'</span></span> <span class="pl-k">+</span> <span class="pl-c1">str</span>(i) <span class="pl-k">for</span> i <span class="pl-k">in</span> <span class="pl-v">xrange</span>(<span class="pl-c1">100</span>))

    <span class="pl-en">@Walker</span>
    <span class="pl-k">def</span> <span class="pl-en">underscore_search</span>(<span class="pl-smi">tree</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
        <span class="pl-k">if</span> <span class="pl-c1">isinstance</span>(tree, Name) <span class="pl-k">and</span> tree.id <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">"</span>_<span class="pl-pds">"</span></span>:
            name <span class="pl-k">=</span> names.next()
            tree.id <span class="pl-k">=</span> name
            <span class="pl-k">return</span> tree, collect(name)

    tree, used_names <span class="pl-k">=</span> underscore_search.recurse_collect(tree)

    new_tree <span class="pl-k">=</span> q[<span class="pl-k">lambda</span>: ast[tree]]
    new_tree.args.args <span class="pl-k">=</span> [Name(<span class="pl-v">id</span> <span class="pl-k">=</span> x) <span class="pl-k">for</span> x <span class="pl-k">in</span> used_names]
    <span class="pl-c1">print</span> unparse(new_tree) <span class="pl-c"><span class="pl-c">#</span> (lambda arg0, arg1: (arg0 + (1 * arg1)))</span>
    <span class="pl-k">return</span> new_tree</pre></div>
<p>And we're done! The printed <code>new_tree</code> looks exactly like what we want. The original code:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> target.py</span>
<span class="pl-k">from</span> macro_module <span class="pl-k">import</span> macros, f

<span class="pl-c1">print</span> f[_ <span class="pl-k">+</span> (<span class="pl-c1">1</span> <span class="pl-k">*</span> _)]</pre></div>
<p>spits out</p>
<pre><code>&lt;function &lt;lambda&gt; at 0x000000000203D198&gt;
</code></pre>
<p>Showing we have successfully replaced all the underscores with 
variables and wrapped the expression in a lambda! Now when we try to run
 it:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> target.py</span>
<span class="pl-k">from</span> macro_module <span class="pl-k">import</span> macros, f

my_func <span class="pl-k">=</span> f[_ <span class="pl-k">+</span> (<span class="pl-c1">1</span> <span class="pl-k">*</span> _)]
<span class="pl-c1">print</span> my_func(<span class="pl-c1">10</span>, <span class="pl-c1">20</span>) <span class="pl-c"><span class="pl-c">#</span> 30</span></pre></div>
<p>It works! We can also use it in some less trivial cases, just to verify that it indeed does what we want:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> target.py</span>
<span class="pl-c1">print</span> <span class="pl-v">reduce</span>(f[_ <span class="pl-k">+</span> _], [<span class="pl-c1">1</span>, <span class="pl-c1">2</span>, <span class="pl-c1">3</span>])  <span class="pl-c"><span class="pl-c">#</span> 6</span>
<span class="pl-c1">print</span> <span class="pl-c1">filter</span>(f[_ <span class="pl-k">%</span> <span class="pl-c1">2</span> <span class="pl-k">!=</span> <span class="pl-c1">0</span>], [<span class="pl-c1">1</span>, <span class="pl-c1">2</span>, <span class="pl-c1">3</span>])  <span class="pl-c"><span class="pl-c">#</span> [1, 3]</span>
<span class="pl-c1">print</span> <span class="pl-c1">map</span>(f[_  <span class="pl-k">*</span> <span class="pl-c1">10</span>], [<span class="pl-c1">1</span>, <span class="pl-c1">2</span>, <span class="pl-c1">3</span>])  <span class="pl-c"><span class="pl-c">#</span> [10, 20, 30]</span></pre></div>
<p>Mission Accomplished! You can see the completed self-contained example in <a href="https://github.com/lihaoyi/macropy/blob/master/docs/examples/full">docs/examples/full</a>. This macro is also defined in our library in <a href="https://github.com/lihaoyi/macropy/blob/master/macropy/quick_lambda.py">macropy/quick_lambda.py</a>, along with a suite of <a href="https://github.com/lihaoyi/macropy/blob/master/macropy/test/quick_lambda.py">unit tests</a>. It is also used throughout the implementation of the other macros.</p>
<h2><a href="#making-your-macros-hygienic" aria-hidden="true" class="anchor" id="user-content-making-your-macros-hygienic"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Making your Macros Hygienic</h2>
<p>In <a href="#writing-your-first-macro">Writing your First Macro</a>, 
we went through how the use basic tools such as quasiquotes and Walkers 
in order to perform simple AST transforms. In this section, we will go 
through the shortcomings of doing the naive transforms, and how to use 
hygiene to make your macros more robust.</p>
<p><a href="http://en.wikipedia.org/wiki/Hygienic_macro" rel="nofollow">Hygienic</a> macros are macros which will not accidentally <a href="http://en.wikipedia.org/wiki/Variable_shadowing" rel="nofollow">shadow</a> an identifier, or have the identifiers they introduce shadowed by user code. For example, the <a href="#quick-lambdas">quicklambda</a> macro takes this:</p>
<div class="highlight highlight-source-python"><pre>func <span class="pl-k">=</span> f[_ <span class="pl-k">+</span> <span class="pl-c1">1</span>]
<span class="pl-c1">print</span> func(<span class="pl-c1">1</span>)
<span class="pl-c"><span class="pl-c">#</span> 2</span></pre></div>
<p>And turns it into a lambda expression. If we did it naively, like we did in the <a href="#tutorials">tutorials</a>, we may expand it into this:</p>
<div class="highlight highlight-source-python"><pre>func <span class="pl-k">=</span> <span class="pl-k">lambda</span> <span class="pl-smi">arg0</span>: arg0 <span class="pl-k">+</span> <span class="pl-c1">1</span>
<span class="pl-c1">print</span> func(<span class="pl-c1">1</span>)
<span class="pl-c"><span class="pl-c">#</span> 2</span></pre></div>
<p>However, if we introduce a variable called <code>arg0</code> in the enclosing scope:</p>
<div class="highlight highlight-source-python"><pre>arg0 <span class="pl-k">=</span> <span class="pl-c1">10</span>
func <span class="pl-k">=</span> f[_ <span class="pl-k">+</span> arg0]
<span class="pl-c1">print</span> func(<span class="pl-c1">1</span>)
<span class="pl-c"><span class="pl-c">#</span> 2</span>
<span class="pl-c"><span class="pl-c">#</span> should print 11</span></pre></div>
<p>It does not behave as we may expect; we probably want it to produce <code>11</code>. this is because the <code>arg0</code> identifier introduced by the <code>f</code> macro shadows the <code>arg0</code>
 in our enclosing scope. These bugs could be hard to find, since 
renaming variables could make them appear or disappear. Try executing 
the code in <a href="https://github.com/lihaoyi/macropy/blob/master/docs/examples/hygiene/hygiene_failures">docs/examples/hygiene/hygiene_failures</a> and to see this for your self.</p>
<p>###gen_sym</p>
<p>There is a way out of this: if you create a new variable, but use an 
identifier that has not been used before, you don't stand the risk of 
accidentally shadowing something you didn't intend to. To help with 
this, MacroPy provides the <code>gen_sym</code> function, which you can acquire by adding an extra parameter named <code>gen_sym</code> to your macro definition:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@macros.expr</span>
<span class="pl-k">def</span> <span class="pl-en">f</span>(<span class="pl-smi">tree</span>, <span class="pl-smi">gen_sym</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    <span class="pl-c1">...</span>
    new_name <span class="pl-k">=</span> gen_sym()
    <span class="pl-c1">...</span> use new_name <span class="pl-c1">...</span></pre></div>
<p><code>gen_sym</code> is a function which produce a new identifier (as
 a string) every time it is called. This is guaranteed to produce a 
identifier that does not appear anywhere in the original source code, or
 have been produced by an earlier call to <code>gen_sym</code>. You can 
thus use these identifiers without worrying about shadowing an 
identifier someone was using; the full code for this is given in <a href="https://github.com/lihaoyi/macropy/blob/master/docs/examples/hygiene/gen_sym">docs/examples/hygiene/gen_sym</a>, so check it out and try executing it to see it working</p>
<p>###Hygienic Quasiquotes
Let's look at another use case: the implementation of the various <a href="#tracing">tracing</a>
 macros. These macros generally can't rely solely on AST transforms, but
 also require runtime support in order to operate. Consider a simple <code>log</code> macro:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> macro_module.py</span>
<span class="pl-k">from</span> macropy.core.macros <span class="pl-k">import</span> <span class="pl-k">*</span>
<span class="pl-k">from</span> macropy.core.quotes <span class="pl-k">import</span> macros, q, u

macros <span class="pl-k">=</span> Macros()

<span class="pl-en">@macros.expr</span>
<span class="pl-k">def</span> <span class="pl-en">log</span>(<span class="pl-smi">tree</span>, <span class="pl-smi">exact_src</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    new_tree <span class="pl-k">=</span> q[wrap(u[exact_src(tree)], ast[tree])]
    <span class="pl-k">return</span> new_tree

<span class="pl-k">def</span> <span class="pl-en">wrap</span>(<span class="pl-smi">txt</span>, <span class="pl-smi">x</span>):
    <span class="pl-c1">print</span> txt <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span> -&gt; <span class="pl-pds">"</span></span> <span class="pl-k">+</span> <span class="pl-c1">repr</span>(x)
    <span class="pl-k">return</span> x</pre></div>
<p>This macro aims to perform a conversion like:</p>
<div class="highlight highlight-source-python"><pre>log[<span class="pl-c1">1</span> <span class="pl-k">+</span> <span class="pl-c1">2</span> <span class="pl-k">+</span> <span class="pl-c1">3</span>] <span class="pl-ii">-&gt;</span> wrap(<span class="pl-s"><span class="pl-pds">"</span>1 + 2 + 3<span class="pl-pds">"</span></span>, <span class="pl-c1">1</span> <span class="pl-k">+</span> <span class="pl-c1">2</span> <span class="pl-k">+</span> <span class="pl-c1">3</span>)</pre></div>
<p>Where the <code>wrap</code> function then prints out both the source code and the <code>repr</code> of the logged expression. This is but a single example of the myriad of things that expanded macros may need at run time.</p>
<p>Naively performing this transform runs into problems:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macro_module <span class="pl-k">import</span> macros, log


log[<span class="pl-c1">1</span> <span class="pl-k">+</span> <span class="pl-c1">2</span> <span class="pl-k">+</span> <span class="pl-c1">3</span>]
<span class="pl-c"><span class="pl-c">#</span> NameError: name 'wrap' is not defined</span></pre></div>
<p>This is because although <code>wrap</code> is available in <code>macro_module.py</code>, it is not available in <code>test.py</code>. Hence the expanded code fails when it tries to reference <code>wrap</code>.There are several ways which this can be accomplished:</p>
<p>###Manual Imports</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> test.py</span>
<span class="pl-k">from</span> macro_module <span class="pl-k">import</span> macros, log, wrap

log[<span class="pl-c1">1</span> <span class="pl-k">+</span> <span class="pl-c1">2</span> <span class="pl-k">+</span> <span class="pl-c1">3</span>]
<span class="pl-c"><span class="pl-c">#</span> 1 + 2 + 3 -&gt; 6</span></pre></div>
<p>You can simply import <code>wrap</code> from <code>macro_module.py</code> into <code>test.py</code>, along with the <code>log</code> macro itself. This way, the expanded code has a <code>wrap</code>
 function that it can call. Although this works in this example, it is 
somewhat fragile in the general case, as the programmer could easily 
accidentally create a variable named <code>wrap</code>, not knowing that it was being used by <code>log</code> (after all, you can't see it used anywhere in the source code!), causing it to fail:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> test.py</span>
<span class="pl-k">from</span> macro_module <span class="pl-k">import</span> macros, log, wrap

wrap <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>chicken salad<span class="pl-pds">"</span></span>

log[<span class="pl-c1">1</span> <span class="pl-k">+</span> <span class="pl-c1">1</span>]
<span class="pl-c"><span class="pl-c">#</span> TypeError: 'str' object is not callable</span></pre></div>
<p>Alternately, the programmer could simply forget to import it, for the same reason:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> test.py</span>
<span class="pl-k">from</span> macro_module <span class="pl-k">import</span> macros, log

log[<span class="pl-c1">1</span> <span class="pl-k">+</span> <span class="pl-c1">1</span>]
<span class="pl-c"><span class="pl-c">#</span> NameError: name 'wrap' is not defined</span></pre></div>
<p>which gives a rather confusing error message: <code>wrap</code> is not defined? From the programmer's perspective, <code>wrap</code> isn't used at all! These very common pitfalls mean you should probably avoid this approach in favor of the latter two.</p>
<p>###<code>hq</code></p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> macro_module.py</span>
<span class="pl-k">from</span> macropy.core.macros <span class="pl-k">import</span> <span class="pl-k">*</span>
<span class="pl-k">from</span> macropy.core.hquotes <span class="pl-k">import</span> macros, hq, u

macros <span class="pl-k">=</span> Macros()

<span class="pl-en">@macros.expr</span>
<span class="pl-k">def</span> <span class="pl-en">log</span>(<span class="pl-smi">tree</span>, <span class="pl-smi">exact_src</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    new_tree <span class="pl-k">=</span> hq[wrap(u[exact_src(tree)], ast[tree])]
    <span class="pl-k">return</span> new_tree

<span class="pl-k">def</span> <span class="pl-en">wrap</span>(<span class="pl-smi">txt</span>, <span class="pl-smi">x</span>):
    <span class="pl-c1">print</span> txt <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span> -&gt; <span class="pl-pds">"</span></span> <span class="pl-k">+</span> <span class="pl-c1">repr</span>(x)
    <span class="pl-k">return</span> x</pre></div>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> test.py</span>
<span class="pl-k">from</span> macro_module <span class="pl-k">import</span> macros, log

wrap <span class="pl-k">=</span> <span class="pl-c1">3</span> <span class="pl-c"><span class="pl-c">#</span> try to confuse it</span>

log[<span class="pl-c1">1</span> <span class="pl-k">+</span> <span class="pl-c1">2</span> <span class="pl-k">+</span> <span class="pl-c1">3</span>]
<span class="pl-c"><span class="pl-c">#</span> 1 + 2 + 3 -&gt; 6</span>
<span class="pl-c"><span class="pl-c">#</span> it still works despite trying to confuse it with `wrap`</span></pre></div>
<p>The important changes in this snippet, as compared to the previous, are:</p>
<ul>
<li>The removal of <code>wrap</code> from the import statement.</li>
<li>Replacement of <code>q</code> with <code>hq</code></li>
</ul>
<p><code>hq</code> is the hygienic quasiquote macro. Unlike traditional quasiquotes (<code>q</code>), <code>hq</code> jumps through some hoops in order to ensure that the <code>wrap</code> you are using inside the <code>hq[...]</code> expression really-truly refers to the <code>wrap</code> that is in scope <em>at the macro definition point</em>, not at tbe macro expansion point (as would be the case using the normal <code>q</code> macro). The end-result is that <code>wrap</code> refers to the <code>wrap</code> you want in <code>macro_module.py</code>, and not whatever <code>wrap</code> happened to be defined in <code>test.py</code>. See <a href="https://github.com/lihaoyi/macropy/blob/master/docs/examples/hygiene/hygienic_quasiquotes">docs/examples/hygiene/hygienic_quasiquotes</a> to see it working.</p>
<p>In general, <code>hq</code> allows you to refer to anything that is in scope where <code>hq</code>
 is being used. Apart from module-level global variables and functions, 
this includes things like locally scoped variables, which will be 
properly saved so they can be referred to later even when the macro has 
completed:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> macro_module.py</span>
<span class="pl-en">@macros.block</span>
<span class="pl-k">def</span> <span class="pl-en">expand</span>(<span class="pl-smi">tree</span>, <span class="pl-smi">gen_sym</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    v <span class="pl-k">=</span> <span class="pl-c1">5</span>
    <span class="pl-k">with</span> hq <span class="pl-k">as</span> new_tree:
        <span class="pl-k">return</span> v
    <span class="pl-k">return</span> new_tree</pre></div>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> test.py</span>
<span class="pl-k">def</span> <span class="pl-en">run</span>():
    x <span class="pl-k">=</span> <span class="pl-c1">1</span>
    <span class="pl-k">with</span> expand:
        <span class="pl-k">pass</span>

<span class="pl-c1">print</span> run() <span class="pl-c"><span class="pl-c">#</span> prints 5</span></pre></div>
<p>In this case, the value of <code>v</code> is captured by the <code>hq</code>, such that even when <code>expand</code> has returned, it can still be used to return <code>5</code> to the caller of the <code>run()</code> function.</p>
<p>###Breaking Hygiene
By default, all top-level names in the <code>hq[...]</code> expression (this excludes things like the contents of <code>u[]</code> <code>name[]</code> <code>ast[]</code>
 unquotes) are hygienic, and are bound to the variable of that name at 
the macro definition point. This means that if you want a name to bind 
to some variable <em>at the macro expansion point</em>, you can always manually break hygiene by using the <code>name[]</code> or <code>ast[]</code> unquotes. The <code>hq</code> macro also provides an <code>unhygienic[...]</code> unquote just to streamline this common requirement:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@macros.block</span>
<span class="pl-k">def</span> <span class="pl-en">expand</span>(<span class="pl-smi">tree</span>, <span class="pl-smi">gen_sym</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    v <span class="pl-k">=</span> <span class="pl-c1">5</span>
    <span class="pl-k">with</span> hq <span class="pl-k">as</span> new_tree:
        <span class="pl-c"><span class="pl-c">#</span> all these do the same thing, and will refer to the variable named</span>
        <span class="pl-c"><span class="pl-c">#</span> 'v' whereever the macro is expanded</span>
        <span class="pl-k">return</span> name[<span class="pl-s"><span class="pl-pds">"</span>v<span class="pl-pds">"</span></span>]
        <span class="pl-k">return</span> ast[Name(<span class="pl-v">id</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>v<span class="pl-pds">"</span></span>)]
        <span class="pl-k">return</span> unhygienic[v]
    <span class="pl-k">return</span> new_tree</pre></div>
<p>Although all these do the same thing, you should prefer to use <code>unhygienic[...]</code> as it makes the intention clearer than using <code>name[...]</code> or <code>ast[...]</code> with hard-coded strings.</p>
<p>###<code>expose_unhygienic</code>
Going back to the <code>log</code> example:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> macro_module.py</span>
<span class="pl-k">from</span> macropy.core.macros <span class="pl-k">import</span> <span class="pl-k">*</span>
<span class="pl-k">from</span> macropy.core.hquotes <span class="pl-k">import</span> macros, hq, u, unhygienic

macros <span class="pl-k">=</span> Macros()

<span class="pl-en">@macros.expr</span>
<span class="pl-k">def</span> <span class="pl-en">log</span>(<span class="pl-smi">tree</span>, <span class="pl-smi">exact_src</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    new_tree <span class="pl-k">=</span> hq[wrap(unhygienic[log_func], u[exact_src(tree)], ast[tree])]
    <span class="pl-k">return</span> new_tree


<span class="pl-k">def</span> <span class="pl-en">wrap</span>(<span class="pl-smi">printer</span>, <span class="pl-smi">txt</span>, <span class="pl-smi">x</span>):
    printer(txt <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span> -&gt; <span class="pl-pds">"</span></span> <span class="pl-k">+</span> <span class="pl-c1">repr</span>(x))
    <span class="pl-k">return</span> x

<span class="pl-en">@macros.expose_unhygienic</span>
<span class="pl-k">def</span> <span class="pl-en">log_func</span>(<span class="pl-smi">txt</span>):
    <span class="pl-c1">print</span> txt</pre></div>
<p><code>expose_unhygienic</code> is a hybrid between manual importing and <code>hq</code>. Like manual importing, decorating functions with <code>expose_unhygienic</code>
 causes them to be imported under their un-modified name, meaning they 
can shadow and be shadowed by other identifiers in the macro-expanded 
code. Like <code>expose</code>, it does not require the source file 
using the macros to put the identifier in the import list. This helps 
match what users of the macro expect: since the name doesn't ever appear
 anywhere in the source, it doesn't make sense for the macro to require 
the name being imported to work.</p>
<p>In this example, the <code>log</code> macro uses <code>expose_unhygienic</code> on a <code>log_func</code> function. The macro-expanded code by default will capture the <code>log_func</code> function imported from <code>macro_module.py</code>, which prints the log to the console:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> test.py</span>
<span class="pl-k">from</span> macro_module <span class="pl-k">import</span> macros, log

log[<span class="pl-c1">1</span> <span class="pl-k">+</span> <span class="pl-c1">1</span>]
<span class="pl-c"><span class="pl-c">#</span> 1 + 1 -&gt; 2</span></pre></div>
<p>But a user can intentionally shadow <code>log_func</code> in order to redirect the logging, for example to a list</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> test.py</span>
<span class="pl-k">from</span> macro_module <span class="pl-k">import</span> macros, log

buffer <span class="pl-k">=</span> []
<span class="pl-k">def</span> <span class="pl-en">log_func</span>(<span class="pl-smi">txt</span>):
    buffer.append(txt)

log[<span class="pl-c1">1</span> <span class="pl-k">+</span> <span class="pl-c1">2</span> <span class="pl-k">+</span> <span class="pl-c1">3</span>]
log[<span class="pl-c1">1</span> <span class="pl-k">+</span> <span class="pl-c1">2</span>]
<span class="pl-c"><span class="pl-c">#</span> doesn't print anything</span>

<span class="pl-c1">print</span> buffer
<span class="pl-c"><span class="pl-c">#</span> ['1 + 2 + 3 -&gt; 6', '1 + 2 -&gt; 3']</span></pre></div>
<p>See <a href="https://github.com/lihaoyi/macropy/blob/master/docs/examples/hygiene/unhygienic">docs/examples/hygiene/unhygienic</a> to see this example in action. In general, <code>expose_unhygienic</code>
 is useful when you want the macro to use a name that can be 
intentionally shadowed by the programmer using the macro, allowing the 
programmer to implicitly modify the behavior of the macro via this 
shadowing.</p>
<hr>
<p>This section has covered how to use the various tools available (<code>gen_sym</code>, <code>hq</code>, <code>expose_unhygienic</code>) in order to carefully control the scoping and variable binding in the code generated by macros. See the section on <a href="#hygiene">Hygiene</a> for a more detailed explanation of what's going on behind the scenes.</p>
<h2><a href="#exporting-your-expanded-code" aria-hidden="true" class="anchor" id="user-content-exporting-your-expanded-code"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Exporting your Expanded Code</h2>
<p>Although MacroPy is designed to work seamlessly on-line, seamlessly 
translating your code on the fly as it gets imported, without having to 
trouble the programmer with a multi-stage expansion/execution process. 
However, there are use reasons for performing an explicit expansion:</p>
<ul>
<li><strong>Performance</strong>: walking the AST takes time, which may 
grow unbearable as the amount of code grows large. Pre-compiling (or at 
least caching) the macro-expanded code would save some frustration</li>
<li><strong>Deployment</strong>: you may be deploying your code in a 
Python environment where MacroPy doesn't function (e.g. Jython), or you 
may want to package your code as a library without forcing your users to
 have a dependency on MacroPy</li>
<li><strong>Debugging</strong>: although MacroPy provides tools to help figure out what's happening when things go wrong (e.g. <code>show_expanded</code>)
 it may sometimes to easier just to take a compile source dump of the 
entire source-tree after macro expansion so you can debug it directly, 
rather than through the expansion process</li>
</ul>
<p>MacroPy allows you to hook into the macro-expansion process via the <code>macropy.exporter</code> variable, which comes with three bundled values which can satisfy these constraints:</p>
<ul>
<li><a href="#nullexporter">NullExporter()</a>: this is the default exporter, which does nothing</li>
<li><a href="#saveexportertarget-root">SaveExporter(target, root)</a>: this saves a copy of your code tree (rooted at <code>root</code>), with macros expanded, in the <code>target</code> directory. This is a convenient way of exporting the entire source tree with macros expanded</li>
<li><a href="#PycExporter">PycExporter()</a>: this emulates the normal <code>.pyc</code> compilation and caching based on file <code>mtime</code>s. This is a convenient transparent-ish cache to avoid needlessly performing macro-expansion repeatedly.</li>
</ul>
<p>###NullExporter()
This is the default Exporter, and although it does not do anything, it 
illustrates the general contract of what an Exporter must look like:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">class</span> <span class="pl-en">NullExporter</span>(<span class="pl-c1">object</span>):
    <span class="pl-k">def</span> <span class="pl-en">find</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>, <span class="pl-smi">file</span>, <span class="pl-smi">pathname</span>, <span class="pl-smi">description</span>, <span class="pl-smi">module_name</span>, <span class="pl-smi">package_path</span>):
        <span class="pl-k">pass</span>

    <span class="pl-k">def</span> <span class="pl-en">export_transformed</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>, <span class="pl-smi">code</span>, <span class="pl-smi">tree</span>, <span class="pl-smi">module_name</span>, <span class="pl-smi">file_name</span>):
        <span class="pl-k">pass</span></pre></div>
<p>In short, it has two methods: <code>find</code> and <code>export_transformed</code>.</p>
<ul>
<li><code>find</code> is called after a file has been loaded and the use of macros have been detected inside. It can either return <code>None</code>, in which case macro-expansion goes ahead, or a <code>module</code> object, in which case macro-expansion is simply skipped and the returned <code>module</code> object is used instead.</li>
<li><code>export_transformed</code> is called after macro-expansion has 
been successfully completed (It is not triggered on failures). Whatever 
it returns doesn't matter.</li>
</ul>
<p>The arguments to these methods are relatively self explanatory, but feel free to inject <code>print</code> statements into <code>NullExporter</code> if you want to see what's what.</p>
<p>###SaveExporter(target, root)</p>
<p>This exporter is activated immediately after the initial <code>import macropy.activate</code> statement, via:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">import</span> macropy.activate
macropy.exporter <span class="pl-k">=</span> SaveExporter(<span class="pl-s"><span class="pl-pds">"</span>exported<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>.<span class="pl-pds">"</span></span>)</pre></div>
<p>It creates a copy of your source tree (rooted at <code>root</code>) in the <code>target</code>
 directory, and any file which is macro-expanded will have its expanded 
representation saved in that directory. For example, if you have a 
project:</p>
<pre><code>run.py
my_macro.py
file.py
stuff/
    thing.py
</code></pre>
<p>Assuming <code>run.py</code> is the entry point containing the <code>import macropy.activate</code> statement, we need to:</p>
<ul>
<li>Modify it, as shown above, to contain the <code>macropy.exporter = SaveExporter(..., ...)</code> line</li>
<li>Run it, via <code>python run.py</code> or similar</li>
</ul>
<pre><code>run.py
my_macro.py
file.py
stuff/
    thing.py
saved/
    run.py
    my_macro.py
    file.py
    stuff/
        thing.py
</code></pre>
<p>Where all macros within the files in the <code>saved/</code> subdirectory which were executed in the course of execution have been expanded. You can verify this by removing the <code>import macropy.activate</code> and <code>macropy.exporter = ...</code> lines from <code>saved/run.py</code> (Thereby disabling MacroPy) and executing <code>saved/run.py</code>
 directly. Everything should run as normal, demonstrating that all 
macros have been expanded the dependencies on MacroPy's import hooks and
 AST transformations have been removed.</p>
<p>Note that <em>only macros in files which get expanded in the execution of the program will have their expanded versions saved</em>.
 This allows you to control which files you want to perform the 
macro-expansion-and-save on: for example, most projects have utility 
scripts which cannot be imported from the root, or example files which 
are similarly not directly importable.</p>
<p>In most cases, activating the <code>SaveExporter</code> and executing
 your test suite should cause all files necessary to be imported, 
expanded and saved. If you need more customization, you could easily 
create a script that performs exactly the imports you need, or <a href="http://stackoverflow.com/questions/1057431/loading-all-modules-in-a-folder-in-python" rel="nofollow">imports all modules in a folder</a>, or any other behavior your want.</p>
<p>###Pre-expanding the MacroPy Test Suite</p>
<p>The following example can be used to expand-and-save MacroPy's own test suite, such that it can be run without macros:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> run_tests.py</span>
<span class="pl-k">import</span> unittest
<span class="pl-k">import</span> macropy.activate
<span class="pl-k">from</span> macropy.core.exporters <span class="pl-k">import</span> SaveExporter
macropy.exporter <span class="pl-k">=</span> SaveExporter(<span class="pl-s"><span class="pl-pds">"</span>exported<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>.<span class="pl-pds">"</span></span>)
<span class="pl-k">import</span> macropy.test

unittest.TextTestRunner().run(macropy.test.Tests)</pre></div>
<p>MacroPy's test suite clearly makes <em>extremely extensive</em> use of macros. Nevertheless, activating <code>SaveExporter</code>
 before running the test suite makes a copy of the entire source-tree 
with all macros expanded; inspecting any of the previously-macro-using 
files in the newly-created <code>exported/</code> directory demonstrates that the macros have really, truly, been expanded:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> exported/macropy/string_interp.py</span>
<span class="pl-k">from</span> pickle <span class="pl-k">import</span> loads <span class="pl-k">as</span> sym1
<span class="pl-k">import</span> re
<span class="pl-k">from</span> macropy.core.macros <span class="pl-k">import</span> <span class="pl-k">*</span>
<span class="pl-k">from</span> macropy.core.hquotes <span class="pl-k">import</span> macros, u, ast_list
macros <span class="pl-k">=</span> Macros()

<span class="pl-en">@macros.expr</span>
<span class="pl-k">def</span> <span class="pl-en">s</span>(<span class="pl-smi">tree</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    captured <span class="pl-k">=</span> []
    new_string <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span><span class="pl-pds">'</span></span>
    chunks <span class="pl-k">=</span> re.split(<span class="pl-s"><span class="pl-pds">'</span>{(.*?)}<span class="pl-pds">'</span></span>, tree.s)
    <span class="pl-k">for</span> i <span class="pl-k">in</span> <span class="pl-c1">range</span>(<span class="pl-c1">0</span>, <span class="pl-c1">len</span>(chunks)):
        <span class="pl-k">if</span> ((i <span class="pl-k">%</span> <span class="pl-c1">2</span>) <span class="pl-k">==</span> <span class="pl-c1">0</span>):
            new_string <span class="pl-k">+=</span> chunks[i]
        <span class="pl-k">else</span>:
            new_string <span class="pl-k">+=</span> <span class="pl-s"><span class="pl-pds">'</span><span class="pl-c1">%s</span><span class="pl-pds">'</span></span>
            captured <span class="pl-k">+=</span> [chunks[i]]
    result <span class="pl-k">=</span> BinOp(<span class="pl-v">left</span><span class="pl-k">=</span>ast_repr(new_string), <span class="pl-v">op</span><span class="pl-k">=</span>Mod(), <span class="pl-v">right</span><span class="pl-k">=</span>Call(<span class="pl-v">func</span><span class="pl-k">=</span>Captured(<span class="pl-c1">tuple</span>, <span class="pl-s"><span class="pl-pds">'</span>tuple<span class="pl-pds">'</span></span>), <span class="pl-v">args</span><span class="pl-k">=</span>[List(<span class="pl-v">elts</span><span class="pl-k">=</span><span class="pl-c1">map</span>(parse_expr, captured))], <span class="pl-v">keywords</span><span class="pl-k">=</span>[], <span class="pl-v">starargs</span><span class="pl-k">=</span><span class="pl-c1">None</span>, <span class="pl-v">kwargs</span><span class="pl-k">=</span><span class="pl-c1">None</span>))
    <span class="pl-k">return</span> result</pre></div>
<p>We can disable MacroPy's runtime transformations completely by removing the import hook:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> exported/macropy/__init__.py</span>
<span class="pl-k">import</span> sys
<span class="pl-k">import</span> core.import_hooks
<span class="pl-k">import</span> core.exporters
<span class="pl-k">import</span> os
<span class="pl-c"><span class="pl-c">#</span> sys.meta_path.append(core.import_hooks.MacroFinder)</span>
<span class="pl-c1">__version__</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>0.2.0<span class="pl-pds">"</span></span>
exporter <span class="pl-k">=</span> core.exporters.NullExporter()</pre></div>
<p>And when we run the saved, macro-expanded, macro-less version via <code>cd exported; python run_tests.py</code>:</p>
<pre><code>----------------------------------------------------------------------
Ran 76 tests in 0.150s

FAILED (failures=4, errors=1)
</code></pre>
<p>A few minor failures, mainly in the error-message/line-numbers tests,
 as the pre-expanded code will have different line numbers than the 
just-in-time-expanded ASTs. Nonetheless, on the whole it works.</p>
<hr>
<p>The SaveExporter should be of great help to any library-author who wants to use
Macros internally (e.g. <a href="#case-classes">case classes</a> to simplify class
declarations, or <a href="#macropeg-parser-combinators">MacroPeg</a> to write a parser)
but does not want to saddle users of the library with having to activate import
hooks, or wants to run the code in an environment where such functionality is
not supported (e.g. Jython).</p>
<p>By using the <code>SaveExporter</code>, the macro-using code is expanded into plain
Python, and although it may rely on MacroPy as a library (e.g. the <code>CaseClass</code>
class in <a href="https://github.com/lihaoyi/macropy/blob/master/macropy/experimental/peg.py">macropy/experimental/peg.py</a>) it won't
need any of MacroPy's import-code-intercepting AST-transforming capabilities at
run-time.</p>
<p>###PycExporter()
The PycExporter makes MacroPy perform the same <code>*.pc -&gt; *.pyc</code> caching that the
normal Python import process does. This can be activated via:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">import</span> macropy.activate
macropy.exporter <span class="pl-k">=</span> PycExporter()</pre></div>
<p>The macro-expansion process takes significantly longer than normal imports, and
this may be helpful if you have a large number of large files using macros and
you want to save having to re-expand them every execution.</p>
<p>Although <code>PycExporter</code> automatically does the recompilation of the
macro-expanded files when they are modified, it notably <em>does not</em> do
recompilation of the macro-expanded files when <em>the macros</em> are modified. This
means that <code>PycExporter</code> is not useful when doing development on the macros
themselves, since the output files will not get properly recompiled when the
macros change. For now it is best to simply use the
<a href="#nullexporter">NullExporter</a> when messing with your macros, and only using the
<a href="#pycexporter">PycExporter</a> when your macros are stable and you are working on
the target code.</p>
<h1><a href="#reference" aria-hidden="true" class="anchor" id="user-content-reference"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Reference</h1>
<p>This section contains reference documentation on various facets of MacroPy:</p>
<h2><a href="#data-model" aria-hidden="true" class="anchor" id="user-content-data-model"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Data Model</h2>
<p>As mentioned earlier, MacroPy uses PEP 302 for much of its functionality. It
looks out in particular for the syntactic forms (<code>import macros, ...</code>,
<code>my_macro[...]</code>, <code>with my_macro:</code>, <code>@my_macro</code>) to decide which
parts of the AST need to be expanded by which macros. MacroPy uses the inbuilt
Python infrastructure for <a href="http://docs.python.org/2/library/ast.html#ast.parse" rel="nofollow">parsing the
source</a> and <a href="http://docs.python.org/2/library/ast.html#abstract-grammar" rel="nofollow">representing
it as an AST</a>. You
should familiarize yourself with the classes which make up the Python AST,
since you will be interacting with them a great deal while writing macros.</p>
<p>Once you have an AST, there are a few possible forms that code can take:</p>
<ul>
<li>A <strong>String</strong></li>
<li>An <strong>AST</strong></li>
<li>A computed <strong>Value</strong></li>
</ul>
<p>This map maps out how to convert from form to form:</p>
<p><a href="https://github.com/lihaoyi/macropy/blob/master/docs/media/Transforms.png" target="_blank"><img src="Transforms" alt="Transforms" style="max-width:100%;"></a></p>
<p>Except for <code>eval</code>, these are all functions defined in the
<a href="https://github.com/lihaoyi/macropy/blob/master/macropy/core/__init__.py">macropy/core/<strong>init</strong>.py</a>. For instance, in order to
convert from a AST back into source code (for example if you want to print out
the code which is being run), you would use the <code>unparse()</code> method. These
transformations will be used throughout this documentation, to convert from one
form to another or to print out the AST for inspection.</p>
<p>###<code>parse_stmt(src)</code> &amp; <code>parse_expr(src)</code>
Thin wrappers around <a href="https://github.com/lihaoyi/macropy/blob/master/...">ast.parse</a>, these functions simplify the common case
where you want to convert a code snippet into a list of <code>stmt</code>s or a single
<code>expr</code>.</p>
<p>###<code>unparse(tree)</code>
This function performs the conversion of the Python AST back into semantically
equivalent source code; using <code>parse_stmt</code> or <code>parse_expr</code> on the generated
should return the original AST.</p>
<p>Although the generated code preserves semantic equivalence, this function does
not preserve <code>lineno</code>s, <code>col_offset</code>s or syntactic equivalence in general.
Hence your indentation may change, there may be extra parentheses added, etc..
The code is not obfuscated (It's typically straightforward to see what its
doing, even with the syntactic changes) but you will not get back the exact
original source.</p>
<p>###<code>exact_src(tree)</code>
This function differs from <code>unparse</code> in that instead of generating source code
from the AST, it searches the original source of the file being macro-expanded
for the exact original source code which generated this AST, using the <code>lineno</code>
and <code>col_offset</code> as a guide. This means that it will generally fail on
synthetic ASTs (which will not have a matching snippet in the source code)
and raise an <code>ExactSrcException</code>. Unlike the rest of these functions, which
are global, <code>exact_src</code> is provided to your macro as an <a href="#argument">argument</a>
as the <code>exact_src</code> for the same AST could vary between macro expansions.</p>
<p>###<code>real_repr</code>
A combination of <code>repr</code> and <code>ast.dump</code>, this 
function generally does the right thing in converting arbitrary values 
into Python source code which can be evaluated to re-create those 
values.</p>
<p>###<code>ast_repr</code>
Similar to <code>real_repr</code>, <code>ast_repr</code> directly generates a Python AST instead of generating strings. This AST can be unparsed and <code>eval</code>ed, or just directly <code>eval</code>ed, to re-create the original value</p>
<p>###<code>eval</code>
Unlike the rest of the functions listed here, <code>eval</code> is the standard Python function provided as a builtin. It evaluates either source code or an AST to produce a value.</p>
<h2><a href="#arguments" aria-hidden="true" class="anchor" id="user-content-arguments"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Arguments</h2>
<p>Any macro which is called receives a number of things from MacroPy in
 order to perform its duties (the syntax transformation). A simple macro
 may just require</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@macros.expr</span>
<span class="pl-k">def</span> <span class="pl-en">my_simple_macro</span>(<span class="pl-smi">tree</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    <span class="pl-c1">...</span></pre></div>
<p>While a more complex macro may require more of the functionality provided by MacroPy:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@macros.expr</span>
<span class="pl-k">def</span> <span class="pl-en">my_complex_macro</span>(<span class="pl-smi">tree</span>, <span class="pl-smi">args</span>, <span class="pl-smi">gen_sym</span>, <span class="pl-smi">target</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    <span class="pl-c1">...</span></pre></div>
<p>These additional arguments given to the macro as keyword arguments. The macro
can declare the arguments as part of its parameter list in order to use it
directly, otherwise it gets chucked into the <code>**kw</code> dict at the end of the
macro's parameter list. This section details what each argument means and why
it is useful.</p>
<p>###<code>tree</code>
This is, the AST provided to the macro, which it can transform/replace. 
It contains the code captured by the macro, which varies depending on 
the macro used:</p>
<ul>
<li>The right hand side of an <strong>expression macro</strong>: <code>my_macro(A + B)</code> captures the tree for <code>(A + B)</code>.</li>
<li>The body of a <strong>block macro</strong>:</li>
</ul>
<div class="highlight highlight-source-python"><pre><span class="pl-k">with</span> my_macro:
    do_stuff()
    <span class="pl-k">return</span> blah</pre></div>
<p>will capture the statements in the body of the <code>with</code>: in this case a list
containing the AST for <code>do_stuff()</code> and <code>return blah</code>.</p>
<ul>
<li>The entire class or function definition for a <strong>decorator macro</strong>, including
<em>any decorators below the macro itself</em>:</li>
</ul>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@dec</span>
<span class="pl-en">@my_macro</span>
<span class="pl-en">@inner_dec</span>
<span class="pl-k">class</span> <span class="pl-en">Cls</span>():
    blah</pre></div>
<p>Captures the AST for:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@inner_dec</span>
<span class="pl-k">class</span> <span class="pl-en">Cls</span>():
    blah</pre></div>
<p>###<code>args</code></p>
<p>Macros can take addition arguments when invoked, apart from the primary tree
that it receives. For example a macro can be invoked as follows:</p>
<div class="highlight highlight-source-python"><pre>my_macro(a)[<span class="pl-c1">...</span>]

<span class="pl-k">with</span> my_macro(a):
    <span class="pl-c1">...</span>

<span class="pl-en">@my_macro</span>(a)
<span class="pl-k">def</span> <span class="pl-en">func</span>():
    <span class="pl-c1">...</span></pre></div>
<p>In these cases, <code>args</code> contains a list of additional arguments, a length-1 list
containing the AST for <code>a</code>. Multiple arguments works as you would expect,
although named arguments, <code>*args* and</code>**kwargs` are not supported. This is
used in <a href="#pattern-matching">pattern matching</a>'s switch macro to indicate what
value to switch on.</p>
<p>###<code>gen_sym</code></p>
<p>As <a href="#hygiene">described below</a>, <code>gen_sym</code> provides a mechanism for creating
identifiers that are guaranteed not to clash with any other identifier in the
same source file. <code>gen_sym</code> is a 0-argument function, which when called via:</p>
<div class="highlight highlight-source-python"><pre>gen_sym()</pre></div>
<p>Will produce a new identifier (as a string) which does not exist in the source
code, and has not been provided before. This is used in the (quick lambda
macro)[#quick-lambda) to ensure that the new arguments do not collide.</p>
<p>###<code>target</code></p>
<p>This argument is only provided for <strong>block macros</strong>. It provides a way to
capture the bound name in the <code>with</code> statement:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">with</span> my_macro <span class="pl-k">as</span> blah:
    <span class="pl-c1">...</span></pre></div>
<p><code>target</code> will contain the AST for <code>blah</code>. This is used in the
<a href="#quasiquotes">quasiquotes</a> macro.</p>
<p>###<code>exact_src</code></p>
<p>This is a function that attempts to retrieve the source code of the target AST,
exactly as written in the source code. This is in contrast to <code>unparse</code>, which
produces semantically correct code that may differ in syntax from what was
originally parsed, for example it may have extra parentheses, be missing
comments, and have the whitespace and layout modified, and a variety of other
syntactic changes:</p>
<div class="highlight highlight-source-python"><pre>(<span class="pl-c1">1</span> <span class="pl-k">+</span> <span class="pl-c1">2</span> <span class="pl-k">+</span> <span class="pl-c1">3</span> <span class="pl-k">+</span> <span class="pl-c1">4</span>) <span class="pl-ii">-&gt;</span> (((<span class="pl-c1">1</span> <span class="pl-k">+</span> <span class="pl-c1">2</span>) <span class="pl-k">+</span> <span class="pl-c1">3</span>) <span class="pl-k">+</span> <span class="pl-c1">4</span>)
<span class="pl-s"><span class="pl-pds">"</span>lol<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">'</span>rofl<span class="pl-pds">'</span></span> <span class="pl-ii">-&gt;</span> (<span class="pl-s"><span class="pl-pds">'</span>lol<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>rofl<span class="pl-pds">'</span></span>)</pre></div>
<p>In contrast <code>exact_src(tree)</code> promises that you get exactly what was written in
the source code, down to the choice of single quotes vs double quotes:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-s"><span class="pl-pds">"</span>lol<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">'</span>rofl<span class="pl-pds">'</span></span> <span class="pl-ii">-&gt;</span> <span class="pl-s"><span class="pl-pds">"</span>lol<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">'</span>rofl<span class="pl-pds">'</span></span></pre></div>
<p>It does this by analyzing the <code>lineno</code> and <code>col_offset</code> values on the AST it is
passed, comparing those against the known values within the source file the AST
originates from and making a best-effort attempt to extract the corresponding
snippet of code. This obviously only really works on ASTs that originated
directly from the source code, and will fail on ASTs you synthesized manually.</p>
<p>###<code>expand_macros</code></p>
<p><code>expand_macros</code> is a function that can be called by a macro to expand any
macros in the target AST. For example, the <code>tracing</code> module's <code>show_expanded</code>
macro uses it to print out what the captured AST looks like after expansion:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@macros.expr</span>
<span class="pl-k">def</span> <span class="pl-en">show_expanded</span>(<span class="pl-smi">tree</span>, <span class="pl-smi">expand_macros</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    expanded_tree <span class="pl-k">=</span> expand_macros(tree)
    new_tree <span class="pl-k">=</span> q[wrap_simple(log, u[unparse(expanded_tree)], ast[expanded_tree])]
    <span class="pl-k">return</span> new_tree</pre></div>
<p>Note that macro expansion <em>mutates the tree being expanded</em>. In the case of the
<code>show_expanded</code> macro, it doesn't really matter (since the tree was going to
get expanded anyway). However, if you want to preserve the original AST for any
reason, you should
<a href="http://docs.python.org/2/library/copy.html#copy.deepcopy" rel="nofollow">deepcopy</a> the
original AST and do your expansion on the copy.</p>
<h2><a href="#quasiquotes" aria-hidden="true" class="anchor" id="user-content-quasiquotes"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Quasiquotes</h2>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.core.quotes <span class="pl-k">import</span> macros, q, name, ast

a <span class="pl-k">=</span> <span class="pl-c1">10</span>
b <span class="pl-k">=</span> <span class="pl-c1">2</span>
tree <span class="pl-k">=</span> q[<span class="pl-c1">1</span> <span class="pl-k">+</span> u[a <span class="pl-k">+</span> b]]
<span class="pl-c1">print</span> ast.dump(tree)
<span class="pl-c"><span class="pl-c">#</span>BinOp(Num(1), Add(), Num(12))</span></pre></div>
<p>Quasiquotes are the foundation for many macro systems, such as that found in <a href="http://en.wikipedia.org/wiki/LISP" rel="nofollow">LISP</a>.
 Quasiquotes save you from having to manually construct code trees from 
the nodes they are made of. For example, if you want the code tree for</p>
<div class="highlight highlight-source-python"><pre>(<span class="pl-c1">1</span> <span class="pl-k">+</span> <span class="pl-c1">2</span>)</pre></div>
<p>Without quasiquotes, you would have to build it up by hand:</p>
<div class="highlight highlight-source-python"><pre>tree <span class="pl-k">=</span> BinOp(Num(<span class="pl-c1">1</span>), Add(), Num(<span class="pl-c1">2</span>))</pre></div>
<p>But with quasiquotes, you can simply write the code <code>(1 + 2)</code>, quoting it with <code>q</code> to lift it from an expression (to be evaluated) to a tree (to be returned):</p>
<div class="highlight highlight-source-python"><pre>tree <span class="pl-k">=</span> q[<span class="pl-c1">1</span> <span class="pl-k">+</span> <span class="pl-c1">2</span>]</pre></div>
<p>Furthermore, quasiquotes allow you to <em>unquote</em> things: if you wish to insert the <strong>value</strong> of an expression into the tree, rather than the <strong>tree</strong> making up the expression, you unquote it using <code>u</code>. In the example above:</p>
<div class="highlight highlight-source-python"><pre>tree <span class="pl-k">=</span> q[<span class="pl-c1">1</span> <span class="pl-k">+</span> u[a <span class="pl-k">+</span> b]]
<span class="pl-c1">print</span> ast.dump(tree)
<span class="pl-c"><span class="pl-c">#</span>BinOp(Num(1), Add(), Num(12))</span></pre></div>
<p>the expression <code>(a + b)</code> is unquoted. Hence <code>a + b</code> gets evaluated to the value of <code>12</code>, which is then inserted into the tree, giving the final tree.</p>
<p>Apart from interpolating values in the AST, you can also interpolate:</p>
<p>###Other ASTs</p>
<div class="highlight highlight-source-python"><pre>a <span class="pl-k">=</span> q[<span class="pl-c1">1</span> <span class="pl-k">+</span> <span class="pl-c1">2</span>]
b <span class="pl-k">=</span> q[ast[a] <span class="pl-k">+</span> <span class="pl-c1">3</span>]
<span class="pl-c1">print</span> ast.dump(b)
<span class="pl-c"><span class="pl-c">#</span>BinOp(BinOp(Num(1), Add(), Num(2)), Add(), Num(3))</span></pre></div>
<p>This is necessary to join together ASTs directly, without converting the interpolated AST into its <code>repr</code>. If we had used the <code>u</code> interpolator, it fails with an error</p>
<p>###Names</p>
<div class="highlight highlight-source-python"><pre>n <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>x<span class="pl-pds">"</span></span>
x <span class="pl-k">=</span> <span class="pl-c1">1</span>
y <span class="pl-k">=</span> q[name[n] <span class="pl-k">+</span> name[n]]
<span class="pl-c1">print</span> ast.dump(y)
<span class="pl-c"><span class="pl-c">#</span>BinOp(Name('x'), Add(), Name('x'))</span></pre></div>
<p>This is convenient in order to interpolate a string variable as an 
identifier, rather than interpolating it as a string literal. In this 
case, I want the syntax tree for the expression <code>x + x</code>, and not <code>'x' + 'x'</code>, so I use the <code>name</code> macro to unquote it.</p>
<p>Overall, quasiquotes are an incredibly useful tool for assembling or 
manipulating the ASTs, and are used in the implementation in all of the 
following examples. See the <a href="https://github.com/lihaoyi/macropy/blob/master/macropy/string_interp.py">String Interpolation</a> or <a href="https://github.com/lihaoyi/macropy/blob/master/macropy/quick_lambda.py">Quick Lambda</a> macros for short, practical examples of their usage.</p>
<h2><a href="#walkers" aria-hidden="true" class="anchor" id="user-content-walkers"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Walkers</h2>
<p>The Walker is a uniform abstraction to use for recursively traversing a Python AST. Defined in <a href="https://github.com/lihaoyi/macropy/blob/master/macropy/core/walkers.py">macropy/core/walkers.py</a>, it is used throughout MacroPy, both in the core logic as well as the implementation of most of the macros.</p>
<p>In its most basic form, a Walker is used as follows:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@Walker</span>
<span class="pl-k">def</span> <span class="pl-en">transform</span>(<span class="pl-smi">tree</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    <span class="pl-c1">...</span>
    <span class="pl-k">return</span> new_tree</pre></div>
<p>This walker applies the <code>transform</code> function to every node in the AST it recurses over, and is called via:</p>
<div class="highlight highlight-source-python"><pre>new_tree <span class="pl-k">=</span> transform.recurse(old_tree)</pre></div>
<p>The <code>transform</code> function can either mutate the given <code>tree</code>
 (e.g. by changing its attributes, swapping out children, etc.) or 
replace it by returning a new one (like in the example above). Returning
 <code>None</code> leaves the tree as-is without replacing it (although it still could have been mutated).</p>
<p>Apart from receiving and returning a <code>tree</code>, the <code>transform</code> function can receive a range of other arguments. By default, these all go into the <code>**kw</code>, but can be explicitly declared for ease of use:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@Walker</span>
<span class="pl-k">def</span> <span class="pl-en">transform</span>(<span class="pl-smi">tree</span>, <span class="pl-smi">ctx</span>, <span class="pl-smi">set_ctx</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    <span class="pl-c1">...</span> do stuff <span class="pl-k">with</span> ctx <span class="pl-c1">...</span>
    set_ctx(<span class="pl-c1">...</span>)
    <span class="pl-k">return</span> new_tree</pre></div>
<p>This section documents what each one does.</p>
<p>###<code>ctx</code></p>
<p>The Walker allows the programmer to provide a <em>context</em>:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@Walker</span>
<span class="pl-k">def</span> <span class="pl-en">transform</span>(<span class="pl-smi">tree</span>, <span class="pl-smi">ctx</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    <span class="pl-c1">...</span> do stuff <span class="pl-k">with</span> ctx <span class="pl-c1">...</span>
    <span class="pl-k">return</span> new_tree

new_tree <span class="pl-k">=</span> transform.recurse(old_tree)
new_tree <span class="pl-k">=</span> transform.recurse(old_tree, init_ctx)</pre></div>
<p>If the <code>transform</code> function takes an additional argument, it will be given the <code>init_ctx</code> that is passed in as the second argument to the <code>.recurse()</code> method (default <code>None</code>).</p>
<p>###<code>set_ctx</code>
Apart from using the <code>ctx</code> passed in to the <code>recurse</code> method, <code>transform</code> can request for the <code>set_ctx</code> function:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@Walker</span>
<span class="pl-k">def</span> <span class="pl-en">transform</span>(<span class="pl-smi">tree</span>, <span class="pl-smi">ctx</span>, <span class="pl-smi">set_ctx</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    <span class="pl-c1">...</span> do stuff <span class="pl-k">with</span> ctx <span class="pl-c1">...</span>
    set_ctx(new_ctx)
    <span class="pl-k">return</span> new_tree</pre></div>
<p>This will cause all children of the current <code>tree</code> to receive <code>new_ctx</code> as their <code>ctx</code> argument.</p>
<p>###<code>collect</code></p>
<p>The Walker provides an easy way for  the programmer to aggregate data
 as it recurses over the AST. This is done by requesting the <code>collect</code> argument:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@Walker</span>
<span class="pl-k">def</span> <span class="pl-en">transform</span>(<span class="pl-smi">tree</span>, <span class="pl-smi">collect</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    <span class="pl-c1">...</span>
    collect(value)
    <span class="pl-k">return</span> new_tree

new_tree, collected <span class="pl-k">=</span> transform.recurse_collect(old_tree)
collected <span class="pl-k">=</span> transform.collect(old_tree)</pre></div>
<p>Using the <code>recurse_collect</code> instead of the <code>recurse</code> method to return both the new <code>tree</code> as well as the collected data, as a list. This is a simple way of aggregating values as you traverse the AST.</p>
<p>###<code>stop</code></p>
<p>Lastly, the Walker provides a way to end the recursion, via the <code>stop</code> functionm:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@Walker</span>
<span class="pl-k">def</span> <span class="pl-en">transform</span>(<span class="pl-smi">tree</span>, <span class="pl-smi">stop</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    <span class="pl-c1">...</span>
    <span class="pl-k">if</span> <span class="pl-c1">...</span>:
        <span class="pl-k">return</span> new_tree
    <span class="pl-k">else</span>:
        stop()</pre></div>
<p>Calling <code>stop</code> prevents the <code>Walker</code> from 
recursing over the children of the current node. This is useful, for 
example, if you know that the current node's AST subtree does not 
contain anything of interest to you and wish to save some computation. 
Another use case would be if you wish to delimit your transformation: if
 you want any code within a certain construct to be passed over by <code>transform</code>, you can simply have <code>transform</code> return <code>stop</code> when it sees that construct.</p>
<p>###A Flexible Tool
The <code>transform</code> function can take any combination of the above arguments. For example, you could have a walker such as:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@Walker</span>
<span class="pl-k">def</span> <span class="pl-en">transform</span>(<span class="pl-smi">tree</span>, <span class="pl-smi">ctx</span>, <span class="pl-smi">set_ctx</span>, <span class="pl-smi">collect</span>, <span class="pl-smi">stop</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    <span class="pl-c1">...</span>
    <span class="pl-k">return</span> new_tree

new_tree, collected <span class="pl-k">=</span> transform.recurse_collect(old_tree, initial_ctx)</pre></div>
<p>This provides it a large amount of versatility, and lets you use the <code>Walker</code> to recursively traverse and transform Python ASTs in interesting ways. If you inspect the source code of the macros in the <a href="https://github.com/lihaoyi/macropy/blob/master/macropy">macropy</a> and <a href="https://github.com/lihaoyi/macropy/blob/master/macropy/experimental">macropy/experimental</a> folders, you will see most of them make extensive use of <code>Walker</code>s
 in order to concisely perform their transformations. If you find 
yourself needing a recursive traversal, you should think hard about why 
you cannot use a Walker before writing the recursion yourself.</p>
<h2><a href="#hygiene" aria-hidden="true" class="anchor" id="user-content-hygiene"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Hygiene</h2>
<p>MacroPy provides a number of tools for writing Hygienic macros:</p>
<p>###<code>gen_sym</code>
<code>gen_sym</code> is a function MacroPy provides to your macro as an <a href="#arguments">argument</a> that generates a new, un-used name every time it is called:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.core.macros <span class="pl-k">import</span> <span class="pl-k">*</span>

macros <span class="pl-k">=</span> Macros()

<span class="pl-en">@macros.expr</span>
<span class="pl-k">def</span> <span class="pl-en">f</span>(<span class="pl-smi">tree</span>, <span class="pl-smi">gen_sym</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    <span class="pl-c1">print</span> gen_sym() <span class="pl-c"><span class="pl-c">#</span> sym0</span>
    <span class="pl-c1">print</span> gen_sym() <span class="pl-c"><span class="pl-c">#</span> sym1</span>
    <span class="pl-c1">print</span> gen_sym() <span class="pl-c"><span class="pl-c">#</span> sym2</span>
    <span class="pl-c1">print</span> gen_sym() <span class="pl-c"><span class="pl-c">#</span> sym3</span>
    <span class="pl-c"><span class="pl-c">#</span> skipping sym4 because it's already used in the target file</span>
    <span class="pl-c1">print</span> gen_sym() <span class="pl-c"><span class="pl-c">#</span> sym5</span>
</pre></div>
<p>This works by first scanning the entire macro-using file to see which
 names are currently in use, and thereafter providing names which do not
 appear on that list. This should generally work, for a name that is 
neither defined nor referenced in a file is almost certainly not used. 
However, due to Python's dynamic nature, this cannot be guaranteed, and 
there are cases where <code>gen_sym</code> will fail:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> module_a.py</span>
<span class="pl-k">from</span> macro_module <span class="pl-k">import</span> macros, my_macro

<span class="pl-k">with</span> my_macro: <span class="pl-c"><span class="pl-c">#</span> a macro which uses gen_sym()</span>
    <span class="pl-c1">...</span></pre></div>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> module_b.py</span>
<span class="pl-k">import</span> module_a
module_a.sym0 <span class="pl-k">=</span> <span class="pl-c1">10</span>
<span class="pl-c1">...</span>
do_stuff_with(module_a.sym0)</pre></div>
<p>In this case, a separate file <code>module_b</code> is using <code>module_a</code> as a convenient namespace to store the value 10. <code>module_a</code> has no way of knowing this, and <code>gen_sym</code> does not see <code>sym0</code> used anywhere in that file, and so assumes <code>sym0</code> is safe to use. If <code>my_macro</code> ends up writing to and reading from <code>sym0</code> in module-scope, this could cause <code>my_macro</code>'s and <code>module_b</code>'s read/writes to conflict, resulting in the weird bugs that <code>gen_sym</code> is meant to avoid. Another unfortunate scenario is:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> module_a.py</span>
sym0 <span class="pl-k">=</span> <span class="pl-c1">10</span></pre></div>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> module_b.py</span>
<span class="pl-k">from</span> module_a <span class="pl-k">import</span> <span class="pl-k">*</span>
<span class="pl-k">from</span> macro_module <span class="pl-k">import</span> macros, my_macro

<span class="pl-k">with</span> my_macro: <span class="pl-c"><span class="pl-c">#</span> a macro which uses gen_sym()</span>
    <span class="pl-c1">...</span></pre></div>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> module_c.py</span>
<span class="pl-k">from</span> module_b <span class="pl-k">import</span> sym0
do_stuff_with(sym0)</pre></div>
<p>Again, due to the nature of <code>import *</code>, <code>module_c</code> can rely on <code>sym0</code> being present in <code>module_b</code> while <code>module_b</code> itself is completely unaware.</p>
<p>These edge cases are unavoidable, but luckily this sort of code is 
frowned upon in general (not just in Python!). Although Python's 
philosophy of "We're all adults" means that it's always possible to go 
out of your way and cause <code>gen_sym</code> to fail, this is the case for other code too, and in practice this should not be a problem.</p>
<p>###Hygienic Quasiquotes
Hygienic quasiquotes, created using the <code>hq[...]</code> macro, are 
quasiquotes who automatically bind identifiers from the lexical scope of
 the macro definition, rather than from that of the macro expansion 
point. Thus, in the following <code>log</code> macro:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> macro_module.py</span>
<span class="pl-k">from</span> macropy.core.macros <span class="pl-k">import</span> <span class="pl-k">*</span>
<span class="pl-k">from</span> macropy.core.hquotes <span class="pl-k">import</span> macros, hq, u

macros <span class="pl-k">=</span> Macros()

<span class="pl-en">@macros.expr</span>
<span class="pl-k">def</span> <span class="pl-en">log</span>(<span class="pl-smi">tree</span>, <span class="pl-smi">exact_src</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    new_tree <span class="pl-k">=</span> hq[wrap(u[exact_src(tree)], ast[tree])]
    <span class="pl-k">return</span> new_tree

<span class="pl-k">def</span> <span class="pl-en">wrap</span>(<span class="pl-smi">txt</span>, <span class="pl-smi">x</span>):
    <span class="pl-c1">print</span> txt <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span> -&gt; <span class="pl-pds">"</span></span> <span class="pl-k">+</span> <span class="pl-c1">repr</span>(x)
    <span class="pl-k">return</span> x</pre></div>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> test.py</span>
<span class="pl-k">from</span> macro_module <span class="pl-k">import</span> macros, log

wrap <span class="pl-k">=</span> <span class="pl-c1">3</span> <span class="pl-c"><span class="pl-c">#</span> try to confuse it</span>

log[<span class="pl-c1">1</span> <span class="pl-k">+</span> <span class="pl-c1">2</span> <span class="pl-k">+</span> <span class="pl-c1">3</span>]
<span class="pl-c"><span class="pl-c">#</span> 1 + 2 + 3 -&gt; 6</span>
<span class="pl-c"><span class="pl-c">#</span> it still works despite trying to confuse it with `wraps`</span></pre></div>
<p>We can be sure that the <code>wrap</code> we referred to inside the <code>hq[...]</code> macro is guaranteed to be the <code>wrap</code> you see in <code>macro_module.py</code>, and not some other <code>wrap</code> that a user may have created in <code>test.py</code>.</p>
<p>This is accomplished by having the <code>hq[...]</code> macro expand each identifier, roughly, via:</p>
<div class="highlight highlight-source-python"><pre>hq[wrap]
q[name[hygienic_self_ref].macros.registered[u[macros.register(<span class="pl-k">%</span>s)]]]</pre></div>
<p>Where <code>hygienic_self_ref</code> is a special identifier (found in <a href="https://github.com/lihaoyi/macropy/blob/master/macropy/core/macros.py">macropy/core/macros.py</a> which tells MacroPy to insert an identifier referring back to the module of the currently-executing macro.</p>
<p>Using <code>wrap</code> as an example, <code>hq</code> uses <code>macros.register</code> to save the current value of <code>wrap</code>. <code>macros.register</code> returns an index, which can be used to retrieve it later. <code>hq</code> then, using the identifier which takes the place of <code>hygienic_self_ref</code>, returns a code snippet that will look up the correct <code>macros.registered</code> at run-time and retrieve the value. This effectively saves every identifier seen by the <code>hq</code> macro and provides it to the macro-expanded code.</p>
<p>One thing to note is that <code>hq</code> pickles all captured names 
and saves them in the expanded module, which unpickles them for usage. 
This is done in order to ensure consistency of behavior with <a href="#exporting-your-expanded-code">exported</a> code, but it comes with a small number of caveats:</p>
<ul>
<li>Unpickleable values (e.g. module objects, nested functions, lambdas) can't be captured in a <code>hq</code></li>
<li>Values get copied in the pickling/unpickling process. If a macro's <code>hq</code>s
 capture the same mutable object when the macro is used to expand 
different modules, each module gets its own version of that mutable 
object.</li>
</ul>
<p>Although this behavior is slightly unintuitive, in general they 
should only affect you in the edge cases. In the vast majority of use 
cases, you will not bump into these issues at all, and when you do, they
 are easy enough to work around.</p>
<p>###<code>expose_unhygienic</code>
Annotating something with <code>@expose_unhygienic</code> simply 
synthesizes an import in the macro-expanded module to pull in the name 
from the macro's own module. E.g. in the case of the <code>log</code> macro, it converts</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macro_module <span class="pl-k">import</span> macros, log</pre></div>
<p>into</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macro_module <span class="pl-k">import</span> macros, log, log_func</pre></div>
<p>Thus, the imported name (<code>log_func</code>) is subject to shadowing and name collisions just like any other import, with the caveat that unlike other imports, <code>log_func</code>
 doesn't appear anywhere in the source code of the macro-expanded 
module! This adds a certain amount of potential implicitness, and thus 
confusion to the system. On the other hand, the implicitness is a boon 
in cases like the <code>log</code> macro, where forcing the user to explicitly pass in the <code>log_func</code> into every invocation of <code>log[...]</code> gets tiring extremely quickly. <code>@expose_unhygienic</code> is therefore best use sparingly, and only after thinking carefully about whether the convenience is worth the added confusion.</p>
<hr>
<p>In general, MacroPy does not enforce hygiene on the macros you write;
 it is entirely possible to write macros which require manual importing,
 or whose identifiers collide with identifiers in the macro-expanded 
file with unpredictable results. At any time, the entire AST of the 
Python code fragment is directly available to you, and you can stich 
together raw quasiquotes any way you like.</p>
<p>Nonetheless, by providing <code>gen_sym</code> and the <code>hq</code> hygienic quasiquote macro, MacroPy makes it trivially easy to have hygiene. <code>gen_sym</code>
 provides a way of creating temporary names which are guaranteed not to 
collide with names already in use, and hygienic quasiquotes take it a 
step further and allow you to directly reference anything in scope at 
the macro definition point without having to worry about things like 
name collisions or fiddling with imports. These tools should be 
sufficient to make your macros hygienic, and are used throughout the 
suite of macros bundled with MacroPy.</p>
<h2><a href="#expansion-failures" aria-hidden="true" class="anchor" id="user-content-expansion-failures"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Expansion Failures</h2>
<div class="highlight highlight-source-python"><pre><span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">import</span> macropy.console
<span class="pl-c1">0</span><span class="pl-k">=</span>[]<span class="pl-k">====</span><span class="pl-k">=</span><span class="pl-k">&gt;</span> MacroPy Enabled <span class="pl-k">&lt;=====</span>[]<span class="pl-k">=</span><span class="pl-c1">0</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">from</span> macropy.case_classes <span class="pl-k">import</span> macros, enum
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">@</span>enum
<span class="pl-c1">...</span> <span class="pl-k">class</span> <span class="pl-en">X</span>:
<span class="pl-c1">...</span>     <span class="pl-c1">1</span> <span class="pl-k">+</span> <span class="pl-c1">2</span>
<span class="pl-c1">...</span>
Traceback (most recent call last):
  File <span class="pl-s"><span class="pl-pds">"</span>&lt;console&gt;<span class="pl-pds">"</span></span>, line <span class="pl-c1">1</span>, <span class="pl-k">in</span> <span class="pl-k">&lt;</span>module<span class="pl-k">&gt;</span>
  File <span class="pl-s"><span class="pl-pds">"</span>macropy\core<span class="pl-cce">\f</span>ailure.py<span class="pl-pds">"</span></span>, line <span class="pl-c1">13</span>, <span class="pl-k">in</span> raise_error
    <span class="pl-k">raise</span> ex
MacroExpansionError: Can<span class="pl-s"><span class="pl-pds">'</span>t have `(1 + 2)` in body of enum<span class="pl-ii"></span></span></pre></div>
<p>Macros can fail for a variety of reasons. Chief among them is that 
the macro contains a bug, which causes an uncaught exception to occur at
 run-time, but there are other scenarios, for example the user of the 
macro violating the contract of that macro. In the above example, the <code>enum</code>
 macro only allows instance definitions and method definitions in the 
body of the enumeration, and the macro therefore fails with a helpful 
error message to allow the user to rectify the problem.</p>
<p>The errors thrown by failed macros are just normal exceptions, and can be caught just like any others:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">try</span>:
<span class="pl-c1">...</span>     <span class="pl-k">@</span>enum
<span class="pl-c1">...</span>     <span class="pl-k">class</span> <span class="pl-en">X</span>:
<span class="pl-c1">...</span>         <span class="pl-c1">1</span> <span class="pl-k">+</span> <span class="pl-c1">2</span>
<span class="pl-c1">...</span> <span class="pl-k">except</span>:
<span class="pl-c1">...</span>     <span class="pl-c1">print</span> <span class="pl-s"><span class="pl-pds">"</span>caught!<span class="pl-pds">"</span></span>
<span class="pl-c1">...</span>
caught!</pre></div>
<p>Macros that fail "naturally", e.g. because of an uncaught exception, 
have an added benefit: their error message will contain the stack trace 
of both the original error (deep within the code of the macro) and the 
point where the macro was used, to help in the debugging effort:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> macropy/core/test/failure_macro.py</span>
<span class="pl-k">from</span> macropy.core.failure <span class="pl-k">import</span> MacroExpansionError
<span class="pl-k">from</span> macropy.core.macros <span class="pl-k">import</span> <span class="pl-k">*</span>

macros <span class="pl-k">=</span> Macros()

<span class="pl-en">@macros.expr</span>
<span class="pl-k">def</span> <span class="pl-en">f</span>(<span class="pl-smi">tree</span>, <span class="pl-smi">gen_sym</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    <span class="pl-k">raise</span> <span class="pl-c1">Exception</span>(<span class="pl-s"><span class="pl-pds">"</span>i am a cow<span class="pl-pds">"</span></span>)</pre></div>
<div class="highlight highlight-source-python"><pre><span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">from</span> macropy.core.test.failure_macro <span class="pl-k">import</span> macros, f
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> <span class="pl-k">def</span> <span class="pl-en">failing_func</span>():
<span class="pl-c1">...</span>     <span class="pl-k">return</span> f[<span class="pl-c1">10</span>]
<span class="pl-c1">...</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span> failing_func()
Traceback (most recent call last):
  File <span class="pl-s"><span class="pl-pds">"</span>&lt;console&gt;<span class="pl-pds">"</span></span>, line <span class="pl-c1">1</span>, <span class="pl-k">in</span> <span class="pl-k">&lt;</span>module<span class="pl-k">&gt;</span>
  File <span class="pl-s"><span class="pl-pds">"</span>&lt;console&gt;<span class="pl-pds">"</span></span>, line <span class="pl-c1">2</span>, <span class="pl-k">in</span> failing_func
  File <span class="pl-s"><span class="pl-pds">"</span>macropy\core<span class="pl-cce">\f</span>ailure.py<span class="pl-pds">"</span></span>, line <span class="pl-c1">13</span>, <span class="pl-k">in</span> raise_error
    <span class="pl-k">raise</span> ex
MacroExpansionError: i am a cow
Caused by Macro<span class="pl-k">-</span>Expansion Error:
Traceback (most recent call last):
  File <span class="pl-s"><span class="pl-pds">"</span>macropy\core\macros.py<span class="pl-pds">"</span></span>, line <span class="pl-c1">117</span>, <span class="pl-k">in</span> expand_if_in_registry
    <span class="pl-k">**</span><span class="pl-c1">dict</span>(kwargs.items() <span class="pl-k">+</span> file_vars.items())
  File <span class="pl-s"><span class="pl-pds">"</span>macropy\core\macros.py<span class="pl-pds">"</span></span>, line <span class="pl-c1">28</span>, <span class="pl-k">in</span> <span class="pl-c1">__call__</span>
    <span class="pl-k">return</span> <span class="pl-c1">self</span>.func(<span class="pl-k">*</span>args, <span class="pl-k">**</span>kwargs)
  File <span class="pl-s"><span class="pl-pds">"</span>macropy\core<span class="pl-cce">\t</span>est<span class="pl-cce">\f</span>ailure_macro.py<span class="pl-pds">"</span></span>, line <span class="pl-c1">8</span>, <span class="pl-k">in</span> f
    <span class="pl-k">raise</span> <span class="pl-c1">Exception</span>(<span class="pl-s"><span class="pl-pds">"</span>i am a cow<span class="pl-pds">"</span></span>)
<span class="pl-c1">Exception</span>: i am a cow</pre></div>
<p>###Implementation of Failures
MacroPy accomplishes this by performing a wrapping a catch-all block 
around every macro invocation. This block intercepts the exception, and 
rather than allowing it to terminate the import process, serializes and 
returns a snippet in place of the expanded AST (the expansion failed 
afterall) that will re-raise the exception at run-time. This is what 
allows the magical transfer of exceptions from expansion-time to 
run-time, so they can be dealt with by normal means at the macro 
call-site instead of bubbling up from the import-site of the 
error-inducing file.</p>
<p>MacroPy also appends the expansion-time stack-trace of the exception onto the exception's <code>message</code>,
 providing much more information to help the programmer debug the 
problem. In order to avoid swamping the programmer with irrelevant 
details when the macro's failure is expected, MacroPy special cases 
macros of the form:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c1">AssertionError</span>(<span class="pl-s"><span class="pl-pds">"</span>...<span class="pl-pds">"</span></span>)</pre></div>
<p>That is, <code>AssertionError</code>s with a non-empty <code>message</code>,
 to ignore the expansion-time stack trace and only provide the run-time 
stack trace when the exception is finally thrown. This means that the 
macro-writer can use statements like:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">assert</span> <span class="pl-c1">False</span>, <span class="pl-s"><span class="pl-pds">"</span>Can't have `<span class="pl-c1">%s</span>` in body of enum<span class="pl-pds">"</span></span> <span class="pl-k">%</span> unparse(stmt).strip(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>)</pre></div>
<p>To provide friendly, custom error messages to the macro-user in the cases where the failure of the macro was anticipated.</p>
<h2><a href="#expansion-order" aria-hidden="true" class="anchor" id="user-content-expansion-order"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Expansion Order</h2>
<p>Macros are expanded in an outside-in order, with macros higher up in 
the AST being expanded before their children. Hence, if we have two 
macros inside each other, such as:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> macropy.quick_lambda <span class="pl-k">import</span> macros, f
<span class="pl-k">from</span> macropy.tracing <span class="pl-k">import</span> macros, trace
trace[<span class="pl-c1">map</span>(f[_ <span class="pl-k">+</span> <span class="pl-c1">1</span>], [<span class="pl-c1">1</span>, <span class="pl-c1">2</span>, <span class="pl-c1">3</span>])]
<span class="pl-c"><span class="pl-c">#</span> f[_ + 1] -&gt; &lt;function &lt;lambda&gt; at 0x00000000021F9128&gt;</span>
<span class="pl-c"><span class="pl-c">#</span> _ + 1 -&gt; 2</span>
<span class="pl-c"><span class="pl-c">#</span> _ + 1 -&gt; 3</span>
<span class="pl-c"><span class="pl-c">#</span> _ + 1 -&gt; 4</span>
<span class="pl-c1">print</span> <span class="pl-c1">map</span>(f[_ <span class="pl-k">+</span> <span class="pl-c1">1</span>], [<span class="pl-c1">1</span>, <span class="pl-c1">2</span>, <span class="pl-c1">3</span>]) <span class="pl-ii">-&gt;</span> [<span class="pl-c1">2</span>, <span class="pl-c1">3</span>, <span class="pl-c1">4</span>]
<span class="pl-c"><span class="pl-c">#</span> [2, 3, 4]</span>
<span class="pl-k">&gt;&gt;</span><span class="pl-k">&gt;</span></pre></div>
<p>As you can see, the <code>trace</code> macro is expanded first, and hence the when it prints out the expressions being executed, we see the un-expanded <code>f[_ + 1]</code> rather than the expanded <code>(lammbda arg0: arg0 + 1)</code>. After the tracing is inserted, the <code>f</code> is finally expanded into a <code>lambda</code> and the final output of this expression is <code>[2, 3, 4]</code>.</p>
<p>If your macro needs to perform an operation <em>after</em> all macros in its sub-tree have been expanded, simply use the <a href="#expand_macros">expand_macros</a>
 function on the sub-tree. This recursively expands all the macros in 
that sub-tree before returning, after which your macro can then do what 
it needs to do. The implementation of the <code>show_expanded</code> macro illustrates this:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-en">@macros.expr</span>
<span class="pl-k">def</span> <span class="pl-en">show_expanded</span>(<span class="pl-smi">tree</span>, <span class="pl-smi">expand_macros</span>,  <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    expanded_tree <span class="pl-k">=</span> expand_macros(tree)
    new_tree <span class="pl-k">=</span> hq[wrap_simple(unhygienic[log], u[unparse(expanded_tree)], ast[expanded_tree])]
    <span class="pl-k">return</span> new_tree</pre></div>
<h2><a href="#line-numbers" aria-hidden="true" class="anchor" id="user-content-line-numbers"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Line Numbers</h2>
<p>MacroPy makes a best-effort attempt to preserve the line numbers 
inside the macro-expanded code; generally, line numbers which are not 
within macros should be unchanged:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span> target.py</span>
<span class="pl-k">from</span> my_macros <span class="pl-k">import</span> macros, expand

<span class="pl-k">with</span> expand:
    x <span class="pl-k">=</span> x <span class="pl-k">+</span> <span class="pl-c1">1</span>

<span class="pl-k">raise</span> <span class="pl-c1">Exception</span>(<span class="pl-s"><span class="pl-pds">"</span>lol<span class="pl-pds">"</span></span>)


<span class="pl-c"><span class="pl-c">#</span> my_macros.py</span>
<span class="pl-k">from</span> macropy.core.macros <span class="pl-k">import</span> <span class="pl-k">*</span>

macros <span class="pl-k">=</span> Macros()

<span class="pl-en">@macros.block</span>
<span class="pl-k">def</span> <span class="pl-en">expand</span>(<span class="pl-smi">tree</span>, <span class="pl-k">**</span><span class="pl-smi">kw</span>):
    <span class="pl-k">import</span> copy
    <span class="pl-k">return</span> tree.body <span class="pl-k">*</span> <span class="pl-c1">10</span></pre></div>
<p>This prints</p>
<div class="highlight highlight-source-python"><pre>Traceback (most recent call last):
  File <span class="pl-s"><span class="pl-pds">"</span>target.py<span class="pl-pds">"</span></span>, line <span class="pl-c1">22</span>, <span class="pl-k">in</span> <span class="pl-k">&lt;</span>module<span class="pl-k">&gt;</span>
    <span class="pl-k">raise</span> e
<span class="pl-c1">Exception</span>: lol</pre></div>
<p>As you can see, even though the line <code>x = x + 1</code> is expanded into 10 equivalent lines, the traceback for the <code>Exception("lol")</code> is unchanged. On the other hand, if the exception happens within the macro expanded code:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"><span class="pl-c">#</span>target.py</span>
<span class="pl-k">from</span> macropy.core.test.macros.line_number_macro <span class="pl-k">import</span> macros, expand

y <span class="pl-k">=</span> <span class="pl-c1">0</span>
<span class="pl-k">with</span> expand:
    x <span class="pl-k">=</span> x <span class="pl-k">-</span> <span class="pl-c1">1</span>
    y <span class="pl-k">=</span> <span class="pl-c1">1</span> <span class="pl-k">/</span> x</pre></div>
<p>The error messages can be rather silly:</p>
<div class="highlight highlight-source-python"><pre>Traceback (most recent call last):
  File <span class="pl-s"><span class="pl-pds">"</span>target.py<span class="pl-pds">"</span></span>, line <span class="pl-c1">2311</span>, <span class="pl-k">in</span> <span class="pl-k">&lt;</span>module<span class="pl-k">&gt;</span>
<span class="pl-c1">ZeroDivisionError</span>: integer division <span class="pl-k">or</span> modulo by zero</pre></div>
<p>Line 2311! In a 7 line file! This may improve in the future, but that's the current state of error reporting in MacroPy.</p>
<h1><a href="#discussion" aria-hidden="true" class="anchor" id="user-content-discussion"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Discussion</h1>
<p>Writing macros is not easy, to say the least. Thus, although you 
could theoretically "do whatever the hell you want" when writing macros,
 you probably don't want to. Instead, you should <a href="#minimize-macro-magic">minimize</a> what the macros do, <a href="#no-macros-necessary">avoid them</a> entirely when not necessary, be concious of the amount of <a href="#levels-of-magic">magic</a> you introduce and think hard about <a href="#whither-macropy">what, exactly</a> you want to do with them.</p>
<h2><a href="#minimize-macro-magic" aria-hidden="true" class="anchor" id="user-content-minimize-macro-magic"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Minimize Macro Magic</h2>
<p>This may seem counter-intuitive, but just because you have the 
ability to do AST transformations does not mean you should use it! In 
fact, you probably should do as little as is humanely possible in order 
to hand over control to traditional functions and objects, who can then 
take over.</p>
<p>For example, let us look at the <a href="#parser-combinators">Parser Combinator</a> macro, shown in the examples above. You may look at the syntax:</p>
<div class="highlight highlight-source-python"><pre>value <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>[0-9]+<span class="pl-pds">'</span></span>.r <span class="pl-k">//</span> <span class="pl-c1">int</span> <span class="pl-k">|</span> (<span class="pl-s"><span class="pl-pds">'</span>(<span class="pl-pds">'</span></span>, expr, <span class="pl-s"><span class="pl-pds">'</span>)<span class="pl-pds">'</span></span>) <span class="pl-k">//</span> f[_[<span class="pl-c1">1</span>]]
op <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>+<span class="pl-pds">'</span></span> <span class="pl-k">|</span> <span class="pl-s"><span class="pl-pds">'</span>-<span class="pl-pds">'</span></span> <span class="pl-k">|</span> <span class="pl-s"><span class="pl-pds">'</span>*<span class="pl-pds">'</span></span> <span class="pl-k">|</span> <span class="pl-s"><span class="pl-pds">'</span>/<span class="pl-pds">'</span></span>
expr <span class="pl-k">=</span> (value <span class="pl-k">is</span> first, (op, value).rep <span class="pl-k">is</span> rest) <span class="pl-k">&gt;&gt;</span> reduce_chain([first] <span class="pl-k">+</span> rest)</pre></div>
<p>And think this may be an ideal situation to go all-out, just handle 
the whole thing using AST transforms and do some code-generation to 
create a working parser! It turns out, the <code>peg</code> module does none of this. It has about 30 lines of code which does a very shallow transform from the above code into:</p>
<div class="highlight highlight-source-python"><pre>value <span class="pl-k">=</span> Named(<span class="pl-k">lambda</span>: Raw(<span class="pl-s"><span class="pl-pds">'</span>[0-9]+<span class="pl-pds">'</span></span>).r <span class="pl-k">//</span> <span class="pl-c1">int</span> <span class="pl-k">|</span> Seq(Raw(<span class="pl-s"><span class="pl-pds">'</span>(<span class="pl-pds">'</span></span>), expr, Raw(<span class="pl-s"><span class="pl-pds">'</span>)<span class="pl-pds">'</span></span>)) <span class="pl-k">//</span> (<span class="pl-k">lambda</span> <span class="pl-smi">x</span>: x[<span class="pl-c1">1</span>]), <span class="pl-s"><span class="pl-pds">"</span>value<span class="pl-pds">"</span></span>)
op <span class="pl-k">=</span> Named(<span class="pl-k">lambda</span>: Raw(<span class="pl-s"><span class="pl-pds">'</span>+<span class="pl-pds">'</span></span>) <span class="pl-k">|</span> Raw(<span class="pl-s"><span class="pl-pds">'</span>-<span class="pl-pds">'</span></span>) <span class="pl-k">|</span> Raw(<span class="pl-s"><span class="pl-pds">'</span>*<span class="pl-pds">'</span></span>) <span class="pl-k">|</span> Raw(<span class="pl-s"><span class="pl-pds">'</span>/<span class="pl-pds">'</span></span>), <span class="pl-s"><span class="pl-pds">"</span>op<span class="pl-pds">"</span></span>)
expr <span class="pl-k">=</span> Named(<span class="pl-k">lambda</span>: Seq(Named(<span class="pl-k">lambda</span>: value, <span class="pl-s"><span class="pl-pds">"</span>first<span class="pl-pds">"</span></span>), Named(Seq(op, value).rep, <span class="pl-s"><span class="pl-pds">"</span>rest<span class="pl-pds">"</span></span>)) <span class="pl-k">&gt;&gt;</span> (<span class="pl-k">lambda</span> <span class="pl-smi">first</span>, <span class="pl-smi">rest</span>: reduce_chain([first] <span class="pl-k">+</span> rest)), <span class="pl-s"><span class="pl-pds">"</span>expr<span class="pl-pds">"</span></span>)</pre></div>
<p>That's the extent of the macro! It just wraps the raw strings in <code>Raw</code>s, tuples in <code>Seq</code>s, converts the <code>a is b</code> syntax into <code>a.bind_to("b")</code>
 and wraps each assignement in a named, lazy parser to facilitate error 
reporting and to allow circular references between them. The rest, all 
the operators <code>|</code> <code>//</code> <code>&gt;&gt;</code>, the <code>.r</code> syntax for regexes and <code>.rep</code> syntax for repetitions, that's all just implemented on the <code>Raw</code> objects using plain-old operator overloading and properties.</p>
<p>Why do this, instead of simply implementing the behavior of <code>|</code> <code>//</code> and friends as macros? There are a few reasons</p>
<ul>
<li><strong>Maintainability</strong>: tree transforms are messy, methods and operators are pretty simple. If you want to change what <code>.r</code> does, for example, you'll have a much easier time if it's a <code>@property</code> rather than some macro-defined transform</li>
<li><strong>Consistency</strong>: methods already have a great deal of 
pre-defined semantics built in: how the arguments are evaluated 
(eagerly, left to right, by-value), whether they can be assigned to or 
monkey-patched. All this behavior is what people already come to expect 
when programming in Python. By greatly limiting the macro transforms, 
you leave the rest up to the Python language which will behave as people
 expect.</li>
</ul>
<p>It's not just the <a href="#parser-combinators">Parser Combinators</a> which work like this; <a href="#pinq-to-sqlalchemy">PINQ</a>, <a href="#tracing">Tracing</a>, <a href="#pattern-matching">Pattern Matching</a>
 all work like this, doing the minimal viable transform and delegating 
the functionality to objects and functions as soon as possible.</p>
<h2><a href="#no-macros-necessary" aria-hidden="true" class="anchor" id="user-content-no-macros-necessary"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>No Macros Necessary</h2>
<p>Python is a remarkably dynamic language. Not only that, but it is also a relatively <em>large</em>
 language, containing many things already built in. A large amount of 
feedback has been received from the online community, and among it 
suggestions to use macros for things such as:</p>
<ul>
<li>Before and After function advice: code snippets to hook into the function call process</li>
<li>Auto parallelizing functions, which run in a forked process</li>
</ul>
<p>This <a href="http://stackoverflow.com/questions/764412/python-macros-use-cases" rel="nofollow">stackoverflow question</a> also explores the use cases of Macros in Python, and comes up with a large number of unimaginative suggestions:</p>
<ul>
<li>An <code>unless blah:</code> statement, equivalent to an <code>if not blah:</code></li>
<li>A <code>repeat</code> macro, to replace for-loops</li>
<li>A <code>do while</code> loop</li>
</ul>
<p>The last three examples are completely banal: they really don't add 
anything, don't make anything easier, and add a lot of indirection to no
 real gain. The first two suggestions, on the other hand, sound 
impressive, but are actually entirely implementable without Macros.</p>
<p>###Function Advice
Function advice, part of <a href="http://en.wikipedia.org/wiki/Aspect-oriented_programming" rel="nofollow">AOP</a>,
 is a technique of register code snippets to run before or after 
function calls occur. These could be used for debugging (printing 
whenever a function is run), caching (intercepting the arguments and 
returning the value from a cache if it already exists), authentication 
(checking permissions before the function runs) and a host of other use 
cases.</p>
<p>Although in the Java world, such a technique requires high-sorcery with <a href="http://www.eclipse.org/aspectj/" rel="nofollow">AspectJ</a>
 and other tools, in Python these are as simple as defining a decorator.
 For example, here is a decorator that logs invocations and returns of a
 generic python function:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">def</span> <span class="pl-en">trace</span>(<span class="pl-smi">func</span>):
    <span class="pl-k">def</span> <span class="pl-en">new_func</span>(<span class="pl-k">*</span><span class="pl-smi">args</span>, <span class="pl-k">**</span><span class="pl-smi">kwargs</span>):
        <span class="pl-c1">print</span> <span class="pl-s"><span class="pl-pds">"</span>Calling<span class="pl-pds">"</span></span>, func.func_name, <span class="pl-s"><span class="pl-pds">"</span>with<span class="pl-pds">"</span></span>, args, kwargs
        result <span class="pl-k">=</span> func(<span class="pl-k">*</span>args, <span class="pl-k">**</span>kwargs)
        <span class="pl-c1">print</span> <span class="pl-s"><span class="pl-pds">"</span>func.func_name, <span class="pl-pds">"</span></span>returned<span class="pl-s"><span class="pl-pds">"</span>, result<span class="pl-ii"></span></span>
        <span class="pl-k">return</span> result
    <span class="pl-k">return</span> new_func

<span class="pl-en">@trace</span>
my_func(arg0, arg1):
    <span class="pl-c1">...</span> do stuff <span class="pl-c1">...</span></pre></div>
<p>Similar things could be done for the other use cases mentioned. This is not a complete example (it would need a <code>functools.wraps</code> or similar to preserve the <code>argspec</code> etc.) but the point is that writing such a decorator really is not very difficult. No macros necessary!</p>
<p>###Auto-Parallelization
Another suggestion was to make a decorator macro that ships the code 
within the function into a separate process to execute. While this 
sounds pretty extreme, it really is not that difficult, for in Python 
you can easily introspect a function object and retrieve it's <code>code</code> attribute. This can pretty easily <a href="http://stackoverflow.com/questions/1253528/is-there-an-easy-way-to-pickle-a-python-function-or-otherwise-serialize-its-cod" rel="nofollow">be pickled and sent to a child process</a>
 to be executed there. Perhaps you may want some sort of Future 
container to hold the result, or some nice helpers for fork-join style 
code, but these are all just normal python functions: no macros 
necessary!</p>
<hr>
<p>Thus, you can accomplish a lot of things in Python without using 
macros. If you need to pass functions around, you can do so without 
macros. Similarly, if you want to introspect a function and see how many
 arguments it takes, you can go ahead using <code>inspect</code>. <code>getattr</code>, <code>hasattr</code>
 and friends are sufficient for all sorts of reflective metaprogramming,
 dynamically setting and getting attributes. Beyond that, you have the 
abilities to access the <code>locals</code> an <code>globals</code> dictionaries, reflecting on the call stack via <code>inspect.stack()</code> and <code>eval</code> or <code>exec</code>ing source code. Whether this is a good idea is another question.</p>
<h2><a href="#levels-of-magic" aria-hidden="true" class="anchor" id="user-content-levels-of-magic"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Levels of Magic</h2>
<p>MacroPy is an extreme measure; there is no doubting that. 
Intercepting the raw source code as it is being imported, parsing it and
 performing AST transforms just before loading it is not something to be
 taken lightly! However, macros are not the most extreme thing that you 
can do! If you look at an Magic Scale for the various things you can do 
in Python, it may look something like this:</p>
<p><a href="https://github.com/lihaoyi/macropy/blob/master/docs/media/Magic.png" target="_blank"><img src="Magic" alt="Magic" style="max-width:100%;"></a></p>
<p>Where basic language constructs are at <strong>0</strong> in the scale of magic, functions and classes can be mildly confusing. <code>hasattr</code> and <code>getattr</code> are at another level, letting you treat things objects as dictionaries and do all sorts of incredibly dynamic things.</p>
<p>I would place MacroPy about on par with Metaclasses in terms of their
 magic-level: pretty knotty, but still ok. Past that, you are in the 
realm of <code>stack.inspect()</code>, where your function call can look at <em>what files are in the call stack</em> and do different things depending on what it sees! And finally, at the <strong>Beyond 9000</strong> level of magic, is the act of piecing together code via string-interpolation or concatenation and just calling <code>eval</code> or <code>exec</code> on the whole blob, maybe at import time, maybe at run-time.</p>
<p>###Skeletons in the Closet
Many profess to shun the higher levels of magic "I would <em>never</em> 
do textual code generation!" you hear them say. "I will do things the 
simple, Pythonic way, with minimal magic!". But if you dig a little 
deeper, and see the code they use on a regular basis, you may notice 
some <code>namedtuple</code>s in their code base. Looking up the <a href="http://hg.python.org/cpython/file/2.7/Lib/collections.py#l234" rel="nofollow">implementation of namedtuple</a> brings up this:</p>
<div class="highlight highlight-source-python"><pre>template <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'''</span>class <span class="pl-c1">%(typename)s</span>(tuple):</span>
<span class="pl-s">    '<span class="pl-c1">%(typename)s</span>(<span class="pl-c1">%(argtxt)s</span>)' <span class="pl-cce">\n</span></span>
<span class="pl-s">    __slots__ = () <span class="pl-cce">\n</span></span>
<span class="pl-s">    _fields = <span class="pl-c1">%(field_names)r</span> <span class="pl-cce">\n</span></span>
<span class="pl-s">    def __new__(_cls, <span class="pl-c1">%(argtxt)s</span>):</span>
<span class="pl-s">        'Create new instance of <span class="pl-c1">%(typename)s</span>(<span class="pl-c1">%(argtxt)s</span>)'</span>
<span class="pl-s">        return _tuple.__new__(_cls, (<span class="pl-c1">%(argtxt)s</span>)) <span class="pl-cce">\n</span></span>
<span class="pl-s">    @classmethod</span>
<span class="pl-s">    def _make(cls, iterable, new=tuple.__new__, len=len):</span></pre></div>
<p>Runtime code-generation as strings! It turns out they piece together the class declaration textually and then just <code>exec</code> the whole lot. Similar things take place in the new <code>Enum</code> that's going to enter the standard library. <a href="#case-classes">Case Classes</a> may be magical, but are they really any worse than the status quo?</p>
<p>Beyond Python, you have the widely used <a href="http://en.wikipedia.org/wiki/.NET_Framework" rel="nofollow">.NET</a>'s <a href="http://msdn.microsoft.com/en-us/library/bb126445.aspx" rel="nofollow">T4 Text Templates</a> and <a href="http://rubyonrails.org/" rel="nofollow">Ruby on Rails</a>
 code-generation tools. This demonstrates that in any language, there 
will be situations where dynamic generation/compilation/execution of 
source code begin to look attractive, or even necessary. In these 
situations, syntactic macros provide a safer, easier to use and more 
maintainable alternative to this kind of string-trickery.</p>
<h2><a href="#whither-macropy" aria-hidden="true" class="anchor" id="user-content-whither-macropy"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Whither MacroPy</h2>
<p>When, then, do you need macros? We believe that the macros shown 
above are a compelling set of functionality that would be impossible 
without macros. The things that macros do roughly falls into the 
following categories:</p>
<ul>
<li><a href="#boilerplate-shaving">Boilerplate Shaving</a></li>
<li><a href="#source-reflection">Source Reflection</a></li>
<li><a href="#mobile-code">Mobile Code</a></li>
</ul>
<p>###Boilerplate Shaving
<a href="#parser-combinators">Parser Combinators</a>, <a href="#quick-lambdas">Quick Lambdas</a> and <a href="#case-classes">Case Classes</a> are examples <em>of boilerplate shaving</em>,
 where macros are used to reduce the amount of boilerplate necessary to 
perform some logic below the level that can be achieved by traditional 
means of abstraction (methods, operator overloading, etc.). With the 
Parser Combinators, for example, the macro transform that is performed 
is <a href="#minimize-macro-magic">extremely simple and superficial</a>. This is also the case with the other boilerplate shaving macros.</p>
<p>In these macros, the boilerplate that the macro removes is trivial but extremely important. Looking again at the <a href="#minimize-macro-magic">Parser Combinator</a>
 transformation, it is clear that removing the boilerplate is a huge 
improvement: rather than having to dig through the code to figure out 
what happens, the PEG-like structure of the code jumps right out at you 
making it far easier to see, at a glance, what is going on.</p>
<p>###Source Reflection
Source reflection is the use of macros to take the source code of the 
program and making it available for inspection at run-time. For example,
 if we re-examine the error-reporting example from <a href="https://github.com/lihaoyi/macropy/blob/master/macropeg-parser-combinators">MacroPEG</a>:</p>
<div class="highlight highlight-source-python"><pre>json_exp.parse(<span class="pl-s"><span class="pl-pds">'</span>{"omg": "123", "wtf": , "bbq": "789"}<span class="pl-pds">'</span></span>)
<span class="pl-c"><span class="pl-c">#</span> ParseError: index: 22, line: 1, col: 23</span>
<span class="pl-c"><span class="pl-c">#</span> json_exp / obj / pair / json_exp</span>
<span class="pl-c"><span class="pl-c">#</span> {"omg": "123", "wtf": , "bbq": "789"}</span>
<span class="pl-c"><span class="pl-c">#</span>                       ^</span>
<span class="pl-c"><span class="pl-c">#</span> expected: (obj | array | string | true | false | null | number)</span></pre></div>
<p>We can see that MacroPEG is able to place the names of each parser in the <code>ParseError</code>'s
 error message. This of course is very handy when debugging your 
parsers, as well as being useful in debugging malformed input.</p>
<p>One question that you may ask is, how is MacroPEG able to access the 
names of each parser, given that the name of each parser is only 
provided in its variable name? Recall that MacroPEG parsers are defined 
as follows:</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">with</span> peg:
    json_exp <span class="pl-k">=</span> (space, (obj <span class="pl-k">|</span> array <span class="pl-k">|</span> string <span class="pl-k">|</span> true <span class="pl-k">|</span> false <span class="pl-k">|</span> null <span class="pl-k">|</span> number), space) <span class="pl-k">//</span> f[_[<span class="pl-c1">1</span>]]
    obj <span class="pl-k">=</span> <span class="pl-c1">...</span>
    array <span class="pl-k">=</span> <span class="pl-c1">...</span>
    string <span class="pl-k">=</span> <span class="pl-c1">...</span>
    <span class="pl-c1">...</span></pre></div>
<p>The answer is that MacroPEG captures the variable-name of each parser
 and passes it to the parser's constructor, performing a transform 
similar to:</p>
<div class="highlight highlight-source-python"><pre>obj <span class="pl-k">=</span> <span class="pl-c1">...</span> <span class="pl-ii">-&gt;</span> obj <span class="pl-k">=</span> Named(<span class="pl-c1">...</span>, <span class="pl-s"><span class="pl-pds">"</span>obj<span class="pl-pds">"</span></span>)</pre></div>
<p>By doing this, now you are able to get sensible error messages when 
using your parsers, without having to manually label each parser with a 
name in addition to the variable to which it's assigned.</p>
<p>Apart from MacroPEG, the <a href="#tracing">Tracing</a> macros also 
operates on the same principle, capturing the source code of each 
snippet as a string that is passed to the code at run-time for printing.
 This is something which is impossible to do using normal Python code, 
and the only answer is the repetitive definition of each variable, 
statement or expression together with its string representation, a task 
which is extremely tedious to perform by hand.</p>
<p>###Mobile Code
Macros such as <a href="#pinq-to-sqlalchemy">PINQ</a>, <a href="#js-snippets">JS Snippets</a>, <a href="#tracing">Tracing</a> and potential extensions such as the <a href="https://github.com/lihaoyi/macropy/blob/master/issues/25">Fork-Join</a>
 macros are all about using macros to shuttle code between domains, 
while still allowing it to be written together in a single code base. 
PINQ and JS Snippets are all about taking sections of a Python program 
and executing it either on a remote database or in a browser, while the 
Tracing macro ships sections of code into the console for debugging 
purposes and the Fork-Join macro would shuttle sections of code between 
Python processes in order to run them in parallel.</p>
<p>This idea of <em>mobile code</em> is not commonly seen in most 
domains; more often, code written in a single file is run in a single 
place, and if you want to write a distributed system, you'll need to 
manually break up your code even though conceptually it all belongs 
together. Allowing you to have a single code-base and semi-transparently
 (translucently?) ship the code to somewhere else to run would be a big 
step forward.</p>
<hr>
<p>Note how none of these macros are simple things like do-while loops 
or alternate syntaxes for if-else statements; these categories of macros
 perform useful functions, often completely impossible without macros, 
and have to be carefully crafted so as to minimize the confusion caused 
by the macro transformation.</p>
<h1><a href="#macropy-bringing-macros-to-python" aria-hidden="true" class="anchor" id="user-content-macropy-bringing-macros-to-python"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>MacroPy: Bringing Macros to Python</h1>
<p>Macros are always a contentious issue. On one hand, we have the <a href="https://en.wikipedia.org/wiki/LISP" rel="nofollow">Lisp</a>
 community, which seems to using macros for everything. On the other 
hand, most mainstream programmers shy away from them, believing them to 
be extremely powerful and potentially confusing, not to mention 
extremely difficult to execute.</p>
<p>With MacroPy, we believe that we have a powerful, flexible tool that 
makes it trivially easy to write AST-transforming macros with any level 
of complexity. We have a <a href="#examples">compelling suite of use cases</a>
 demonstrating the utility of such transforms, and all of it runs 
perfectly fine on alternative implementations of Python such as PyPy.</p>
<h1><a href="#credits" aria-hidden="true" class="anchor" id="user-content-credits"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Credits</h1>
<p>MacroPy was initially created as a final project for the <a href="http://web.mit.edu/" rel="nofollow">MIT</a> class <a href="http://groups.csail.mit.edu/mac/users/gjs/6.945/" rel="nofollow">6.945: Adventures in Advanced Symbolic Programming</a>, taught by <a href="http://groups.csail.mit.edu/mac/users/gjs/" rel="nofollow">Gerald Jay Sussman</a> and <a href="http://pavpanchekha.com/" rel="nofollow">Pavel Panchekha</a>. Inspiration was taken from project such as <a href="http://scalamacros.org/" rel="nofollow">Scala Macros</a>, <a href="https://pypi.python.org/pypi/karnickel" rel="nofollow">Karnickel</a> and <a href="https://github.com/dropbox/pyxl">Pyxl</a>.</p>
<p>The MIT License (MIT)</p>
<p>Copyright (c) 2013, <a href="https://github.com/lihaoyi">Li Haoyi</a>, <a href="https://github.com/jnhnum1">Justin Holmgren</a></p>
<p>Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:</p>
<p>The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.</p>
<p>THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.</p>
</article>
  </div>


  </div>
  <div class="modal-backdrop js-touch-events"></div>
</div>

    </div>
  </div>

  </div>

      
<div class="footer container-lg px-3" role="contentinfo">
  <div class="position-relative d-flex flex-justify-between pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <ul class="list-style-none d-flex flex-wrap ">
      <li class="mr-3">© 2018 <span title="0.30353s from unicorn-4134928663-cdqmt">GitHub</span>, Inc.</li>
        <li class="mr-3"><a data-ga-click="Footer, go to terms, text:terms" href="https://github.com/site/terms">Terms</a></li>
        <li class="mr-3"><a data-ga-click="Footer, go to privacy, text:privacy" href="https://github.com/site/privacy">Privacy</a></li>
        <li class="mr-3"><a href="https://help.github.com/articles/github-security/" data-ga-click="Footer, go to security, text:security">Security</a></li>
        <li class="mr-3"><a href="https://status.github.com/" data-ga-click="Footer, go to status, text:status">Status</a></li>
        <li><a data-ga-click="Footer, go to help, text:help" href="https://help.github.com/">Help</a></li>
    </ul>

    <a aria-label="Homepage" title="GitHub" class="footer-octicon" href="https://github.com/">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></svg>
</a>
   <ul class="list-style-none d-flex flex-wrap ">
        <li class="mr-3"><a data-ga-click="Footer, go to contact, text:contact" href="https://github.com/contact">Contact GitHub</a></li>
      <li class="mr-3"><a href="https://developer.github.com/" data-ga-click="Footer, go to api, text:api">API</a></li>
      <li class="mr-3"><a href="https://training.github.com/" data-ga-click="Footer, go to training, text:training">Training</a></li>
      <li class="mr-3"><a href="https://shop.github.com/" data-ga-click="Footer, go to shop, text:shop">Shop</a></li>
        <li class="mr-3"><a data-ga-click="Footer, go to blog, text:blog" href="https://github.com/blog">Blog</a></li>
        <li><a data-ga-click="Footer, go to about, text:about" href="https://github.com/about">About</a></li>

    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>
</div>



  <div id="ajax-error-message" class="ajax-error-message flash flash-error">
    <svg class="octicon octicon-alert" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8.865 1.52c-.18-.31-.51-.5-.87-.5s-.69.19-.87.5L.275 13.5c-.18.31-.18.69 0 1 .19.31.52.5.87.5h13.7c.36 0 .69-.19.86-.5.17-.31.18-.69.01-1L8.865 1.52zM8.995 13h-2v-2h2v2zm0-3h-2V6h2v4z"></path></svg>
    <button type="button" class="flash-close js-ajax-error-dismiss" aria-label="Dismiss error">
      <svg class="octicon octicon-x" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.48 8l3.75 3.75-1.48 1.48L6 9.48l-3.75 3.75-1.48-1.48L4.52 8 .77 4.25l1.48-1.48L6 6.52l3.75-3.75 1.48 1.48z"></path></svg>
    </button>
    You can't perform that action at this time.
  </div>


    <script crossorigin="anonymous" integrity="sha512-gEAdDZ4LgyEE51A6EiCI5F8hC2pELVwJzk9fcRYT6JKNg92wpQhso4uD1rML8kTVE8FFW4G1hKIm+eWgX+D5/g==" type="application/javascript" src="compat-432e5bb0f7cc942dbf63a7c74de5da3c.js"></script>
    <script crossorigin="anonymous" integrity="sha512-bDFUXMGHFddte8PoN8CW5xNr/0w/9Zrfsjun90gr7lJdc7w5+NLGNrJHTPFeaZa5ph1MzSTQg7fqTg/CI95fSw==" type="application/javascript" src="frameworks-c566e2adb34ea4706cec5d285e57dd1d.js"></script>
    
    <script crossorigin="anonymous" async="async" integrity="sha512-QKerAmbi8RFAfjUvkdjUZNeOk7x3IoYJhiCCTJbn/v17op8fggb0zxJw0denloKM0lPiHUKs2iE4+nUMj+Q7Yw==" type="application/javascript" src="github-12f0557a92f0fb40861429376cb054d5.js"></script>
    
    
    
    
  <div class="js-stale-session-flash stale-session-flash flash flash-warn flash-banner d-none">
    <svg class="octicon octicon-alert" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8.865 1.52c-.18-.31-.51-.5-.87-.5s-.69.19-.87.5L.275 13.5c-.18.31-.18.69 0 1 .19.31.52.5.87.5h13.7c.36 0 .69-.19.86-.5.17-.31.18-.69.01-1L8.865 1.52zM8.995 13h-2v-2h2v2zm0-3h-2V6h2v4z"></path></svg>
    <span class="signed-in-tab-flash">You signed in with another tab or window. <a href="">Reload</a> to refresh your session.</span>
    <span class="signed-out-tab-flash">You signed out in another tab or window. <a href="">Reload</a> to refresh your session.</span>
  </div>
  <div class="facebox" id="facebox" style="display:none;">
  <div class="facebox-popup">
    <div class="facebox-content" role="dialog" aria-labelledby="facebox-header" aria-describedby="facebox-description">
    </div>
    <button type="button" class="facebox-close js-facebox-close" aria-label="Close modal">
      <svg class="octicon octicon-x" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.48 8l3.75 3.75-1.48 1.48L6 9.48l-3.75 3.75-1.48-1.48L4.52 8 .77 4.25l1.48-1.48L6 6.52l3.75-3.75 1.48 1.48z"></path></svg>
    </button>
  </div>
</div>

  <div class="Popover js-hovercard-content position-absolute" style="display: none; outline: none;" tabindex="0">
  <div class="Popover-message Popover-message--bottom-left Popover-message--large Box box-shadow-large" style="width:360px;">
  </div>
</div>

<div id="hovercard-aria-description" class="sr-only">
  Press h to open a hovercard with more details.
</div>


  


</body></html>